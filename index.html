<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burgherr V21 - Free Market</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #0d0d0d; 
            --panel-bg: #e0d5b7;
            --border: #3e2723;
            --highlight: #ffb300;
            --text: #271c19;
            --success: #2e7d32;
            --danger: #b71c1c;
            --accent: #d84315;
            --can-build: #e8f5e9;
            --can-build-border: #2e7d32;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Lato', sans-serif; background: var(--bg-body); color: #ccc; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- TICK BAR --- */
        #tick-container { height: 6px; background: #000; width: 100%; position: relative; z-index: 200; }
        #tick-bar { height: 100%; background: var(--highlight); width: 0%; transition: width 0.1s linear; box-shadow: 0 0 10px var(--highlight); }

        /* --- HEADER --- */
        header { 
            background: #1a1a1a; height: 120px; flex-shrink: 0; border-bottom: 3px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 10px; z-index: 100; position: relative;
        }

        .header-info { width: 180px; }
        .game-title { font-family: 'MedievalSharp'; font-size: 1.6rem; color: var(--highlight); margin: 0; line-height: 1; text-shadow: 2px 2px 0 #000; }
        .objective { font-size: 0.7rem; background: rgba(255,255,255,0.05); padding: 5px; border-left: 3px solid var(--highlight); margin-top: 5px; color: #bbb; }
        .obj-done { text-decoration: line-through; color: var(--success); opacity: 0.7; }

        .res-container { display: flex; gap: 5px; flex: 1; justify-content: flex-end; }
        .res-group { 
            background: #2d2d2d; border: 1px solid #444; border-radius: 4px; padding: 4px 6px; 
            min-width: 60px; text-align: center; display: flex; flex-direction: column; justify-content: center;
            position: relative; cursor: help; transition: background 0.2s;
        }
        .res-group:hover .tooltip { display: block; }
        .res-label { font-size: 0.55rem; text-transform: uppercase; color: #888; border-bottom: 1px solid #444; margin-bottom: 2px; }
        .res-values { display: flex; gap: 8px; justify-content: center; font-weight: bold; font-size: 0.85rem; color: #eee; position: relative; }
        
        .res-item { position: relative; display: inline-block; min-width: 25px; text-align: center; }
        .rate-ind { font-size: 0.65rem; position: absolute; top: -8px; right: -5px; opacity: 0.9; font-weight: 900; text-shadow: 1px 1px 0 #000; }
        .rate-pos { color: #66bb6a; }
        .rate-neg { color: #ef5350; }

        /* Floating Text */
        .float-txt {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            font-size: 1rem; font-weight: 900; pointer-events: none;
            animation: floatUp 1.5s forwards; text-shadow: 1px 1px 0 #000; z-index: 3000;
        }
        .click-pop {
            position: absolute; font-size: 1.5rem; font-weight: bold; color: #fff; pointer-events: none; z-index: 4000;
            text-shadow: 0 0 5px #000; animation: floatUpMap 0.8s forwards;
        }
        @keyframes floatUp { 0% { opacity: 1; top: -10px; transform: translateX(-50%); } 100% { opacity: 0; top: -40px; transform: translateX(-50%); } }
        @keyframes floatUpMap { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-40px) scale(1.3); } }

        /* TOOLTIP */
        .tooltip { 
            display: none; position: absolute; top: 100%; right: 0; margin-top: 5px; z-index: 2000;
            background: #e0e0e0; color: #000; padding: 10px; border: 2px solid var(--border); border-radius: 4px;
            width: 240px; text-align: left; box-shadow: 0 5px 15px rgba(0,0,0,0.5); pointer-events: none;
        }
        .tt-row { display: flex; justify-content: space-between; font-size: 0.8rem; border-bottom: 1px dashed #ccc; padding: 2px 0; }
        
        .pop-val { display:flex; gap:5px; align-items:center; }
        .idle-val { color: var(--highlight); margin-left: 8px; }

        /* --- MAIN MAP --- */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }

        #map-area { 
            flex: 1; position: relative; overflow: hidden; padding: 10px;
            background-color: #0d1b0e;
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8px;
        }
        
        /* ZONES */
        .zone { 
            position: relative; border-radius: 8px; overflow: hidden; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
            transition: transform 0.1s; cursor: pointer; border: 2px solid rgba(255,255,255,0.05);
        }
        .zone:active { transform: scale(0.99); }
        .zone:hover { border-color: rgba(255,255,255,0.2); }

        #z-forest { background: radial-gradient(circle at center, #2e7d32, #1b5e20); }
        #z-mountain { background: linear-gradient(135deg, #5d4037, #3e2723); } 
        #z-town { background: radial-gradient(#d7ccc8, #8d6e63); border: 2px solid #5d4037; }
        #z-farm { background: radial-gradient(#8bc34a, #558b2f); }

        .zone-label { 
            position: absolute; bottom: 10px; left: 10px; 
            font-family: 'MedievalSharp'; font-size: 1.2rem; color: rgba(255,255,255,0.6); 
            text-shadow: 1px 1px 2px #000; pointer-events: none; z-index: 10;
        }
        .zone-hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.1; font-size: 4rem; pointer-events: none; }

        /* SCATTERED BUILDINGS */
        .map-b { 
            position: absolute; 
            font-size: 1.6rem; 
            filter: drop-shadow(2px 2px 1px rgba(0,0,0,0.5));
            animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: help;
        }
        .map-b:hover { transform: scale(1.3) translateY(-5px); z-index: 20; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }
        @keyframes popIn { from { transform: scale(0) translateY(20px); opacity:0; } to { transform: scale(1) translateY(0); opacity:1; } }

        /* SIDEBAR */
        aside { 
            width: 340px; background: var(--panel-bg); border-left: 5px solid var(--border); 
            display: flex; flex-direction: column; color: var(--text); z-index: 50;
        }
        .log-box { 
            flex: 1; overflow-y: hidden; padding: 10px; display: flex; flex-direction: column; gap: 5px; 
            background: rgba(0,0,0,0.05); font-size: 0.85rem; position: relative;
        }
        .log-box::after {
            content:''; position: absolute; bottom:0; left:0; width:100%; height: 50px;
            background: linear-gradient(transparent, var(--panel-bg)); pointer-events: none;
        }
        .log-entry { 
            background: #fff; padding: 6px 10px; border-radius: 4px; border-left: 4px solid #999; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-shrink: 0; animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        .log-entry:nth-child(1) { font-weight: bold; border-left-width: 6px; } 
        .log-entry:nth-child(n+10) { opacity: 0.5; } 

        .log-entry.prod { border-color: var(--success); }
        .log-entry.warn { border-color: var(--danger); background: #ffebee; }
        .log-entry.death { border-color: #000; background: #444; color: #fff; }
        .log-entry.war { border-color: var(--highlight); background: #fff8e1; }

        .controls { padding: 10px; background: #bcaaa4; border-top: 2px solid var(--border); }
        .c-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .btn { 
            flex: 1; padding: 8px; border: 1px solid var(--border); background: #efebe9; 
            font-weight: bold; cursor: pointer; border-radius: 4px; color: var(--text); transition: 0.1s;
        }
        .btn:hover { background: #fff; transform: translateY(-1px); }
        .btn:active { transform: translateY(1px); }
        .btn-war { background: #5d4037; color: #fff; border-color: #3e2723; }
        .btn-war:hover { background: #4e342e; }

        /* --- FOOTER (BUILDING) --- */
        footer { 
            height: 160px; background: #d7ccc8; border-top: 5px solid var(--border); flex-shrink: 0;
            display: flex; padding: 0 10px; align-items: center; 
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            z-index: 60;
        }
        
        .cat-bar { width: 140px; display: flex; flex-wrap: wrap; gap: 5px; border-right: 2px solid #ccc; padding-right: 10px; justify-content: center; }
        .cat-btn { width: 40px; height: 40px; background: var(--border); color: #fff; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .cat-btn:hover { transform: scale(1.1); }
        .cat-btn.active { background: var(--highlight); color: #000; border-color: #fff; transform: scale(1.1); box-shadow: 0 0 10px var(--highlight); }

        .build-bar { flex: 1; display: flex; gap: 10px; overflow-x: auto; padding: 5px; height: 100%; align-items: center; }
        .b-card { 
            min-width: 80px; height: 110px; background: rgba(0,0,0,0.05); border-radius: 6px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; border: 2px solid transparent; transition: 0.2s;
        }
        .b-card:hover { background: rgba(0,0,0,0.1); border-color: #999; }
        .b-card.can-build { background: var(--can-build); border-color: var(--can-build-border); box-shadow: 0 4px 6px rgba(46, 125, 50, 0.2); }
        
        .b-count { position: absolute; top: -5px; right: -5px; background: var(--accent); color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; font-weight: bold; box-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        
        /* MODALS */
        .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-win { background: var(--panel-bg); width: 500px; padding: 25px; border: 4px solid var(--border); border-radius: 8px; text-align: center; color: var(--text); box-shadow: 0 0 50px #000; position: relative; }
        
        .list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 400px; overflow-y: auto; text-align: left; margin: 15px 0; }
        .list-item { background: rgba(255,255,255,0.5); padding: 5px; border: 1px solid #999; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; font-size: 0.9rem; }
        .missing-res { color: var(--danger); font-weight: bold; }

        /* WAR MISSION STYLES */
        .war-card { background: rgba(0,0,0,0.1); padding: 10px; margin-bottom: 5px; border: 1px solid #777; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .war-lvl { font-weight: bold; color: var(--danger); }
        .war-loot { font-size: 0.8rem; color: #555; }
    </style>
</head>
<body>

<div id="modal-mask" class="modal-mask">
    <div class="modal-win">
        <h2 id="m-title" style="font-family:'MedievalSharp'; margin-top:0">Titel</h2>
        <div id="m-body" style="font-size:1.1rem; line-height:1.4">Text</div>
        <button id="m-btn" class="btn" style="margin-top:20px; width:100%; background:var(--highlight);">Aktion</button>
    </div>
</div>

<div id="war-mask" class="modal-mask">
    <div class="modal-win" style="width: 600px;">
        <h2 style="font-family:'MedievalSharp'; margin:0">Feldz√ºge</h2>
        <div style="margin-bottom:10px; border-bottom:1px solid #999; padding-bottom:5px;">
            Deine Armeest√§rke: <span id="army-str" style="font-weight:bold; font-size:1.2rem">0</span> ‚öîÔ∏è
        </div>
        <div id="war-list" class="list-grid" style="grid-template-columns: 1fr;"></div>
        <button onclick="UI.closeWar()" class="btn" style="width:100%">R√ºckzug</button>
    </div>
</div>

<div id="recruit-mask" class="modal-mask">
    <div class="modal-win">
        <h2 style="font-family:'MedievalSharp'; margin:0">Kaserne</h2>
        <div id="recruit-list" class="list-grid"></div>
        <button onclick="UI.closeRecruit()" class="btn" style="width:100%">Schlie√üen</button>
    </div>
</div>

<div id="market-mask" class="modal-mask">
    <div class="modal-win">
        <h2 style="font-family:'MedievalSharp'; margin:0">Markt</h2>
        <div id="market-list" class="list-grid"></div>
        <button onclick="UI.closeMarket()" class="btn" style="width:100%">Schlie√üen</button>
    </div>
</div>

<div id="tick-container"><div id="tick-bar"></div></div>

<header>
    <div class="header-info">
        <div class="game-title">Burgherr V21</div>
        <div class="objective" id="obj-disp">Lade...</div>
    </div>

    <div class="res-container">
        <div class="res-group" id="rg-gold">
            <span class="res-label">Schatz</span>
            <div class="res-values">üí∞ <span id="r-gold">0</span></div>
        </div>
        
        <div class="res-group" id="rg-store" style="min-width:120px">
            <span class="res-label">Lager</span>
            <div class="res-values">
                <span class="res-item" title="Holz">üå≤<span id="r-wood">0</span><span id="d-wood" class="rate-ind"></span></span>
                <span class="res-item" title="Stein">üß±<span id="r-stone">0</span><span id="d-stone" class="rate-ind"></span></span>
                <span class="res-item" title="Eisen">‚õìÔ∏è<span id="r-iron">0</span><span id="d-iron" class="rate-ind"></span></span>
                <span class="res-item" title="Weizen">üåæ<span id="r-wheat">0</span><span id="d-wheat" class="rate-ind"></span></span>
                <span class="res-item" title="Mehl">ü•°<span id="r-flour">0</span><span id="d-flour" class="rate-ind"></span></span>
            </div>
            <div class="tooltip">Limit: <span id="tt-stock">100</span> (Vorratslager bauen)</div>
        </div>

        <div class="res-group" id="rg-food">
            <span class="res-label">Nahrung</span>
            <div class="res-values">
                <span class="res-item" title="Brot">üçû<span id="r-bread">0</span><span id="d-bread" class="rate-ind"></span></span>
                <span class="res-item" title="Fleisch">ü•©<span id="r-meat">0</span><span id="d-meat" class="rate-ind"></span></span>
                <span class="res-item" title="√Ñpfel">üçé<span id="r-apple">0</span><span id="d-apple" class="rate-ind"></span></span>
                <span class="res-item" title="K√§se">üßÄ<span id="r-cheese">0</span><span id="d-cheese" class="rate-ind"></span></span>
            </div>
            <div class="tooltip">Limit: <span id="tt-food">100</span> (Kornspeicher bauen)</div>
        </div>

        <div class="res-group" style="min-width:100px">
            <span class="res-label">Truppen</span>
            <div class="res-values">
                <span title="Bogen">üèπ<span id="r-bow">0</span></span>
                <span title="Pike">üî±<span id="r-spear">0</span></span>
                <span title="Schwert">‚öîÔ∏è<span id="r-sword">0</span></span>
                <span title="S√∂ldner">üó°Ô∏è<span id="r-merc">0</span></span>
            </div>
        </div>

        <div class="res-group">
            <span class="res-label">Bev√∂lkerung</span>
            <div class="res-values pop-val">
                <span title="B√ºrger">üë®‚Äçüåæ <span id="r-pop">0</span></span>
                <span title="Beliebtheit">‚ù§Ô∏è <span id="r-hap">0</span></span>
                <span title="Unt√§tig" class="idle-val">üí§ <span id="r-idle">0</span></span>
            </div>
            <div class="tooltip">
                <div id="hap-breakdown"></div>
            </div>
        </div>
    </div>
</header>

<main>
    <div id="map-area">
        <div class="zone" id="z-forest" onclick="Game.clickGather('wood', event)">
            <div class="zone-hint">üå≤</div>
            <div class="zone-label">Forst</div>
        </div>
        <div class="zone" id="z-mountain" onclick="Game.clickGather('stone', event)">
            <div class="zone-hint">‚õ∞Ô∏è</div>
            <div class="zone-label">Gebirge</div>
        </div>
        <div class="zone" id="z-town">
            <div class="zone-hint">üè∞</div>
            <div class="zone-label">Stadt</div>
        </div>
        <div class="zone" id="z-farm" onclick="Game.clickGather('apple', event)">
            <div class="zone-hint">üçé</div>
            <div class="zone-label">L√§ndereien</div>
        </div>
    </div>

    <aside>
        <div style="padding:10px; text-align:center; font-weight:bold; border-bottom:1px solid #aaa;">
            Tag <span id="day-disp">1</span> - Level <span id="lvl-disp">1</span>
        </div>
        <div class="log-box" id="log"></div>
        <div class="controls">
            <div class="c-row">
                <button class="btn" onclick="UI.openRecruit()">üõ°Ô∏è Armee</button>
                <button class="btn btn-war" onclick="UI.openWar()">‚öîÔ∏è Feldzug</button>
            </div>
            <div class="c-row">
                <button class="btn" onclick="UI.openMarket()">‚öñÔ∏è Markt</button>
            </div>
            <div style="background:rgba(255,255,255,0.5); padding:5px; border-radius:4px; font-size:0.8rem; margin:5px 0;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>Steuern: <strong id="tax-name">Keine</strong></span>
                    <span>
                        <button onclick="Game.tax(-1)" style="cursor:pointer">‚ûñ</button> 
                        <button onclick="Game.tax(1)" style="cursor:pointer">‚ûï</button>
                    </span>
                </div>
                <div id="tax-impact" style="font-size:0.7rem; color:#555; margin-top:3px; text-align:center;">
                    0üí∞ / -1‚ù§Ô∏è
                </div>
            </div>
            <div style="border-top:1px dashed #777; margin-top:5px; padding-top:5px; font-size:0.75rem;">
                System: 
                <button onclick="Game.togglePause()">Pause</button>
                <button onclick="Game.save()">Save</button>
                <button onclick="Game.reset()" style="color:red">Reset</button>
            </div>
        </div>
    </aside>
</main>

<footer>
    <div class="cat-bar">
        <div class="cat-btn active" onclick="UI.setCat('burg')">üè∞</div>
        <div class="cat-btn" onclick="UI.setCat('werk')">üî®</div>
        <div class="cat-btn" onclick="UI.setCat('farm')">üçé</div>
        <div class="cat-btn" onclick="UI.setCat('stadt')">üè†</div>
        <div class="cat-btn" onclick="UI.setCat('waffen')">‚öîÔ∏è</div>
        <div class="cat-btn" onclick="UI.setCat('nahrung')">üçû</div>
    </div>
    <div class="build-bar" id="build-list"></div>
</footer>

<script>
/* DATEN */
const T = {
    wood:"Holz", stone:"Stein", iron:"Eisen", pitch:"Pech", wheat:"Weizen", flour:"Mehl", hops:"Hopfen",
    bread:"Brot", meat:"Fleisch", cheese:"K√§se", apple:"√Ñpfel", beer:"Bier",
    bow:"Bogen", spear:"Speer", sword:"Schwert", armor:"R√ºstung", leather:"Leder",
    gold:"Gold", pop:"B√ºrger", archer:"Sch√ºtze", pikeman:"Pikenier", swordsman:"Schwertk√§mpfer", merc:"S√∂ldner",
    cath:"Kathedrale"
};
const SafeT = (k) => T[k] || k; 

const Levels = [
    {
        id:1, 
        t:"Gr√ºndung", 
        msg:"Sorge f√ºr Nahrung und Unterk√ºnfte. Klicke auf die Karte f√ºr erste Rohstoffe!", 
        goal:{wood:50, pop:10}, 
        start:{gold: 100, wood: 60, bread: 50, apple: 20}
    },
    {id:2, t:"Stein & Brot", msg:"Baut Steinbr√ºche & Brotproduktion. Klicke auf Berge f√ºr Stein.", goal:{stone:20, bread:30}, start:{gold:150, wood:50, bread:50}},
    {id:3, t:"Waffen", msg:"Stellt B√∂gen und Speere her.", goal:{bow:5, spear:5}, start:{gold:200, wood:100, stone:50, bread:100, meat:20}},
    {id:4, t:"Armee", msg:"Bildet 10 Soldaten aus.", goal:{soldier:10}, start:{gold:300, wood:100, stone:100, iron:20, bread:100, meat:50}},
    {id:5, t:"Kathedrale", msg:"Das Meisterwerk.", goal:{cath:1}, start:{gold:1000, wood:500, stone:500, iron:100, bread:200, wine:50}}
];

const Units = {
    archer: {n:"Sch√ºtze", cost:10, res:"bow", str:5},
    pikeman: {n:"Pikenier", cost:15, res:"spear", str:8},
    swordsman: {n:"Schwertk.", cost:30, res:"sword", arm:"armor", str:15},
    merc: {n:"S√∂ldner", cost:50, str:10}
};

const Missions = [
    {n:"Banditenlager", str:20, loot:{gold:50, wood:20, bread:20}, risk:"Niedrig"},
    {n:"Wegelagerer", str:50, loot:{gold:100, iron:10, meat:20}, risk:"Mittel"},
    {n:"Raubritterburg", str:150, loot:{gold:300, stone:50, sword:5, armor:2}, risk:"Hoch"},
    {n:"Feindliche Grafschaft", str:500, loot:{gold:1000, iron:100}, risk:"Extrem"}
];

const Config = {
    tick: 4000, 
    taxes: [
        {n:"Keine",   g:0, h:1},
        {n:"Gering",  g:1, h:-1}, 
        {n:"Normal",  g:2, h:-2},
        {n:"Hoch",    g:4, h:-4},
        {n:"Wucher",  g:8, h:-10}
    ],
    b: {
        // BURG
        wall_w:{n:"Holzwall",c:"burg",i:"ü™µ",z:"z-town",cost:{g:10,w:20}},
        tower:{n:"Turm",c:"burg",i:"üóº",z:"z-mountain",cost:{g:100,s:50}},
        barrack:{n:"Kaserne",c:"burg",i:"‚õ∫",z:"z-town",cost:{g:150,s:20},desc:"Armee"},
        merc:{n:"S√∂ldnerlager",c:"burg",i:"üé™",z:"z-town",cost:{g:500,w:100},desc:"S√∂ldner"},
        
        // WERK
        wood:{n:"Holzf√§ller",c:"werk",i:"ü™ì",z:"z-forest",cost:{g:10},prod:"wood",amt:3},
        stock:{n:"Vorratslager",c:"werk",i:"üì¶",z:"z-town",cost:{w:20},desc:"Lager"},
        ox:{n:"Ochsenjoch",c:"werk",i:"üêÇ",z:"z-mountain",cost:{g:20,w:20}},
        quarry:{n:"Steinbruch",c:"werk",i:"‚õèÔ∏è",z:"z-mountain",cost:{g:50,w:50},prod:"stone",amt:2,need:"ox"},
        iron:{n:"Eisenmine",c:"werk",i:"‚õìÔ∏è",z:"z-mountain",cost:{g:100,w:100},prod:"iron",amt:1},
        
        // FARM
        apple:{n:"Obstgarten",c:"farm",i:"üçé",z:"z-farm",cost:{g:30,w:10},prod:"apple",amt:3},
        hunter:{n:"J√§ger",c:"farm",i:"üèπ",z:"z-forest",cost:{g:20,w:5},prod:"meat",amt:2},
        dairy:{n:"K√§serei",c:"farm",i:"üßÄ",z:"z-farm",cost:{g:40,w:20},prod:"cheese",amt:2},
        wheat:{n:"Getreide",c:"farm",i:"üåæ",z:"z-farm",cost:{g:40,w:10},prod:"wheat",amt:2},
        hops:{n:"Hopfen",c:"farm",i:"üåø",z:"z-farm",cost:{g:40,w:10},prod:"hops",amt:2},
        
        // STADT
        hovel:{n:"H√ºtte",c:"stadt",i:"üõñ",z:"z-town",cost:{w:10},pop:5},
        house:{n:"Haus",c:"stadt",i:"üè†",z:"z-town",cost:{g:50,w:30,s:10},pop:10},
        church:{n:"Kirche",c:"stadt",i:"‚õ™",z:"z-town",cost:{g:500,s:100},rel:10},
        cath:{n:"KATHEDRALE",c:"stadt",i:"üïç",z:"z-town",cost:{g:5000,s:2000},rel:50},
        
        // WAFFEN
        fletch:{n:"Pfeilmacher",c:"waffen",i:"üèπ",z:"z-town",cost:{g:100,w:50},use:"wood",out:"bow",amt:1},
        pole:{n:"Pikenmacher",c:"waffen",i:"üî±",z:"z-town",cost:{g:100,w:50},use:"wood",out:"spear",amt:1},
        smith:{n:"Schmiede",c:"waffen",i:"‚öîÔ∏è",z:"z-town",cost:{g:200,w:100},use:"iron",out:"sword",amt:1},
        armor:{n:"R√ºstung",c:"waffen",i:"üõ°Ô∏è",z:"z-town",cost:{g:200,w:100},use:"iron",out:"armor",amt:1},
        
        // NAHRUNG
        gran:{n:"Kornspeicher",c:"nahrung",i:"üõñ",z:"z-town",cost:{w:20},cap:50},
        mill:{n:"M√ºhle",c:"nahrung",i:"‚öôÔ∏è",z:"z-town",cost:{g:100,w:50},proc:"wheat",out:"flour",r:1},
        bake:{n:"B√§cker",c:"nahrung",i:"üçû",z:"z-town",cost:{g:50,w:20},proc:"flour",out:"bread",r:4},
        brew:{n:"Brauerei",c:"nahrung",i:"üç∫",z:"z-town",cost:{g:100,w:20},proc:"hops",out:"beer",r:2}
    }
};

/* LOGIC */
let S = {}; 
let lastTickTime = 0;

const Game = {
    init: function() {
        if(localStorage.getItem('sh_v21')) {
            try {
                S = JSON.parse(localStorage.getItem('sh_v21'));
                if(!S.b.gran && S.b.granary) { S.b.gran = S.b.granary; delete S.b.granary; }
                UI.init();
                UI.showModal("Willkommen zur√ºck", "Dein Lehen erwartet dich.", "Weiter");
            } catch(e) { this.reset(); }
        } else {
            this.startLevel(1);
        }
        
        setInterval(this.tick, Config.tick);
        lastTickTime = Date.now();
        requestAnimationFrame(UI.animateTick);
    },

    startLevel: function(id) {
        let l = Levels.find(x => x.id == id);
        if(!l) return UI.showModal("Spielende", "Du bist der wahre Burgherr!", "Hurra");
        
        S = {
            lvl: id, day: 1, paused: true,
            res: { gold:0, wood:0, stone:0, iron:0, pitch:0, wheat:0, flour:0, bread:0, meat:0, cheese:0, apple:0, hops:0, beer:0, bow:0, spear:0, sword:0, armor:0, leather:0 },
            units: { archer:0, pikeman:0, swordsman:0, merc:0 },
            pop: { curr:5, max:0, hap:100 },
            b: {}, w: {}, tax: 0,
            factors: { food:0, tax:0 },
            rates: {} 
        };
        for(let k in l.start) S.res[k] = l.start[k];
        for(let k in Config.b) { S.b[k]=0; S.w[k]=0; }
        
        S.b.stock = 1; S.b.gran = 1;

        UI.init();
        UI.showModal("Level " + id + ": " + l.t, l.msg, "Starten");
    },

    getArmyStr: function() {
        let s = 0;
        for(let k in S.units) s += (S.units[k] * Units[k].str);
        return s;
    },

    clickGather: function(type, e) {
        if(S.paused) return;
        
        let maxS = (S.b.stock || 1) * 50;
        let maxF = (S.b.gran || 1) * 50;
        let curS = S.res.wood + S.res.stone + S.res.iron + S.res.wheat + S.res.flour;
        let curF = S.res.bread + S.res.meat + S.res.apple + S.res.cheese;

        if(type === 'wood' || type === 'stone') {
            if(curS >= maxS) { UI.showFloatingText(type, "Voll!", "neg"); return; }
        }
        if(type === 'apple') {
            if(curF >= maxF) { UI.showFloatingText(type, "Voll!", "neg"); return; }
        }

        S.res[type]++;
        UI.update();
        
        UI.showFloatingText(type, "+1", "pos");
        UI.showMapClickEffect(e.currentTarget, type === 'apple' ? 'üçé' : (type==='wood'?'üå≤':'üß±'));
    },

    tick: function() {
        if(S.paused) { lastTickTime = Date.now(); return; }
        S.day++;
        lastTickTime = Date.now();
        
        let startRes = JSON.parse(JSON.stringify(S.res));
        
        // 1. LIMITS & SPACE CALC
        let maxS = (S.b.stock || 1) * 50;
        let maxF = (S.b.gran || 1) * 50; 
        
        let curS = S.res.wood + S.res.stone + S.res.iron + S.res.wheat + S.res.flour;
        let curF = S.res.bread + S.res.meat + S.res.apple + S.res.cheese;
        
        // Remaining space
        let spaceS = maxS - curS;
        let spaceF = maxF - curF;

        // 2. PRODUCTION
        for(let k in Config.b) {
            let b = Config.b[k];
            let n = S.w[k];
            if(n <= 0) continue;

            if(b.need && S.b[b.need] < n) n = S.b[b.need]; 

            if(b.prod) {
                let isFood = ['meat','apple','cheese','wheat','hops'].includes(b.prod);
                let isStorage = !['meat','apple','cheese','bread'].includes(b.prod);
                let amt = n * (b.amt||1);
                
                if(isFood && spaceF > 0) {
                    let realAdd = Math.min(amt, spaceF);
                    S.res[b.prod] = (S.res[b.prod]||0) + realAdd;
                    spaceF -= realAdd;
                } else if(isStorage && spaceS > 0) {
                    let realAdd = Math.min(amt, spaceS);
                    S.res[b.prod] = (S.res[b.prod]||0) + realAdd;
                    spaceS -= realAdd;
                }
            }
            // Process (Converts 1:X, consumes space but frees input space? Simplified: Just check output space)
            if(b.proc) {
                let take = Math.min(S.res[b.proc]||0, n);
                // Check if we have space for output
                let outAmt = take * (b.r||1);
                // Simple logic: if food output, check spaceF
                let isFoodOut = ['bread','beer'].includes(b.out); // beer is neither food nor storage limit technically? Let's treat beer as limitless or storage.
                // Actually wheat->flour (Storage to Storage). Flour->Bread (Storage to Food).
                
                if(take > 0) {
                    // We assume processing always works for now to keep flow, but strictly we should check limit.
                    // Let's rely on space checks.
                    let canProd = true;
                    if(['bread'].includes(b.out) && spaceF < outAmt) canProd = false;
                    if(['flour'].includes(b.out) && spaceS < outAmt) canProd = false;
                    
                    if(canProd) {
                        S.res[b.proc] -= take;
                        S.res[b.out] = (S.res[b.out]||0) + outAmt;
                        if(['bread'].includes(b.out)) spaceF -= outAmt;
                        if(['flour'].includes(b.out)) spaceS -= outAmt; // Frees wheat space but takes flour space. Net zero change mostly.
                    }
                }
            }
            if(b.use) {
                if((S.res[b.use]||0) >= n) {
                    // Check output space? Weapons don't have limit logic in this simple version
                    S.res[b.use] -= n;
                    S.res[b.out] = (S.res[b.out]||0) + (n*(b.amt||1));
                }
            }
        }

        // 3. EAT
        let eat = S.pop.curr;
        let foods = ['apple','bread','cheese','meat'];
        let ateTypes = 0;
        foods.forEach(f => {
            if(eat > 0 && S.res[f] > 0) {
                let take = Math.min(eat, S.res[f]);
                S.res[f] -= take; eat -= take; ateTypes++;
            }
        });

        let hChg = 0;
        if(eat > 0) { 
            UI.log(`${eat} hungern!`, 'warn'); 
            hChg -= 3; 
            S.factors.food = -3; 
            if(Math.random() < 0.1) {
                S.pop.curr--;
                UI.log("Ein B√ºrger verhungert.", "death");
            }
        }
        else { hChg += (ateTypes); S.factors.food = ateTypes; }

        // Tax
        let tx = Config.taxes[S.tax];
        hChg += tx.h;
        S.res.gold += (S.pop.curr * tx.g);
        S.factors.tax = tx.h;

        // Beer
        if(S.res.beer >= S.pop.curr && S.pop.curr > 0) {
            S.res.beer -= S.pop.curr;
            hChg += 5;
        }

        hChg += ((S.b.church||0) * 5);
        let diff = Math.max(-10, Math.min(10, hChg));
        S.pop.hap = Math.max(0, Math.min(100, S.pop.hap + diff));

        // 4. GAME OVER
        if(S.pop.curr <= 0) {
            S.pop.curr = 0; 
            S.paused = true;
            UI.update();
            UI.showModal("GAME OVER", "Das Dorf ist ausgestorben.", "Neustart", Game.reset);
            return; 
        }

        S.pop.max = (S.b.hovel*5) + (S.b.house*10) + 5;
        let work = 0; for(let k in S.w) work += S.w[k];
        let sold = 0; for(let k in S.units) sold += S.units[k];
        let idle = S.pop.curr - sold - work;

        if(S.pop.hap > 60 && S.pop.curr < S.pop.max && Math.random()>0.5) {
            S.pop.curr++; Game.autoAssign();
        } else if(S.pop.hap < 20 && S.pop.curr > 0) {
            S.pop.curr--; UI.log("B√ºrger geflohen", "warn");
            for(let k in S.w) if(S.w[k]>0){S.w[k]--; break;}
        }

        // 5. RATES
        S.rates = {};
        for(let k in S.res) {
            let diff = S.res[k] - startRes[k];
            if(diff !== 0) {
                S.rates[k] = diff;
                if(diff > 0) UI.showFloatingText(k, `+${diff}`, 'pos');
            }
        }

        // 6. WIN CHECK
        let l = Levels.find(x => x.id == S.lvl);
        let win = true;
        for(let k in l.goal) {
            let val = 0;
            if(k=='pop') val=S.pop.curr;
            else if(k=='soldier') val=sold;
            else val = S.res[k] || S.b[k] || 0;
            if(val < l.goal[k]) win = false;
        }
        if(win) {
            S.paused = true;
            UI.showModal("SIEG!", "Level geschafft!", "N√§chstes Level", () => Game.startLevel(S.lvl+1));
        }

        UI.update();
    },

    autoAssign: function() {
        let work = 0; for(let k in S.w) work += S.w[k];
        let sold = 0; for(let k in S.units) sold += S.units[k];
        let idle = S.pop.curr - sold - work;
        if(idle <= 0) return;

        for(let k in Config.b) {
            let b = Config.b[k];
            if((b.prod || b.proc || b.use) && S.b[k] > S.w[k]) {
                S.w[k]++; idle--;
                if(idle<=0) break;
            }
        }
    },

    build: function(key) {
        let b = Config.b[key];
        if(S.res.gold >= (b.cost.g||0) && S.res.wood >= (b.cost.w||0) && S.res.stone >= (b.cost.s||0)) {
            S.res.gold -= (b.cost.g||0); S.res.wood -= (b.cost.w||0); S.res.stone -= (b.cost.s||0);
            S.b[key]++;
            Game.autoAssign();
            UI.addMapIcon(key);
            UI.renderBuild();
            UI.update();
        }
    },

    recruit: function(key) {
        let work = 0; for(let k in S.w) work += S.w[k];
        let sold = 0; for(let k in S.units) sold += S.units[k];
        let idle = S.pop.curr - sold - work;
        let u = Units[key];

        if(key === 'merc') {
            if(S.b.merc < 1) return;
            if(S.res.gold >= 50) { S.res.gold-=50; S.units.merc++; UI.log("S√∂ldner angeheuert", "prod"); }
        } else {
            if(S.b.barrack < 1) return;
            if(idle < 1) return;
            if(S.res.gold >= u.cost && S.res[u.res] >= 1) {
                if(u.arm && S.res[u.arm] < 1) return;
                S.res.gold -= u.cost;
                S.res[u.res]--;
                if(u.arm) S.res[u.arm]--;
                S.units[key]++;
                UI.log(u.n + " ausgebildet", "prod");
            }
        }
        UI.update();
    },

    launchWar: function(idx) {
        let m = Missions[idx];
        let str = Game.getArmyStr();
        
        let rng = (Math.random() * 0.4) + 0.8; 
        let enemyRoll = m.str * rng;
        let playerRoll = str;
        
        let win = playerRoll >= enemyRoll;
        
        let lossRate = win ? 0.1 : 0.3;
        let lostUnits = [];
        for(let k in S.units) {
            let uCount = S.units[k];
            if(uCount > 0) {
                let kill = Math.ceil(uCount * lossRate * Math.random());
                if(kill > 0) {
                    S.units[k] -= kill;
                    lostUnits.push(`${kill} ${Units[k].n}`);
                }
            }
        }
        
        if(win) {
            let lootText = [];
            for(let k in m.loot) {
                S.res[k] = (S.res[k]||0) + m.loot[k];
                lootText.push(`${m.loot[k]} ${SafeT(k)}`);
            }
            UI.log(`Sieg gegen ${m.n}! Beute: ${lootText.join(', ')}`, 'war');
        } else {
            UI.log(`Niederlage gegen ${m.n}.`, 'warn');
        }
        
        if(lostUnits.length) UI.log(`Verluste: ${lostUnits.join(', ')}`, 'death');
        
        UI.update();
        UI.closeWar();
    },

    tax: function(d) {
        let n = S.tax + d;
        if(n >= 0 && n < 5) S.tax = n;
        UI.update();
    },

    trade: function(k, buy) {
        if(buy && S.res.gold >= 5) { S.res.gold-=5; S.res[k]+=5; }
        if(!buy && S.res[k] >= 5) { S.res[k]-=5; S.res.gold+=3; }
        UI.update(); UI.renderMarket();
    },

    togglePause: function() { 
        S.paused = !S.paused; 
        if(!S.paused) lastTickTime = Date.now();
    },
    save: function() { localStorage.setItem('sh_v21', JSON.stringify(S)); UI.log("Gespeichert", "prod"); },
    reset: function() { localStorage.removeItem('sh_v21'); location.reload(); }
};

const UI = {
    cat: 'burg',
    init: function() {
        this.renderMap();
        this.renderBuild();
        this.update();
    },
    
    animateTick: function() {
        if(!S.paused) {
            let now = Date.now();
            let diff = now - lastTickTime;
            let pct = Math.min(100, (diff / Config.tick) * 100);
            document.getElementById('tick-bar').style.width = pct + "%";
        }
        requestAnimationFrame(UI.animateTick);
    },
    
    update: function() {
        // Resources
        ['gold','wood','stone','iron','wheat','flour','bread','meat','apple','cheese','bow','spear','sword','merc'].forEach(k => {
            let el = document.getElementById('r-'+k);
            if(el) {
                let val = S.res[k] !== undefined ? S.res[k] : (S.units[k] !== undefined ? S.units[k] : 0);
                el.innerText = Math.floor(val); 
            }
            
            let dEl = document.getElementById('d-'+k);
            if(dEl) {
                let r = S.rates[k] || 0;
                dEl.innerText = r > 0 ? `+${r}` : (r < 0 ? r : "");
                dEl.className = "rate-ind " + (r >= 0 ? "rate-pos" : "rate-neg");
            }
        });

        // Pop & Info
        let work = 0; for(let k in S.w) work += S.w[k];
        let sold = 0; for(let k in S.units) sold += S.units[k];
        let idle = S.pop.curr - sold - work;

        document.getElementById('r-pop').innerText = S.pop.curr + "/" + S.pop.max;
        document.getElementById('r-idle').innerText = idle;
        document.getElementById('r-hap').innerText = Math.floor(S.pop.hap);
        document.getElementById('day-disp').innerText = S.day;
        document.getElementById('lvl-disp').innerText = S.lvl;
        
        let tIdx = Config.taxes[S.tax];
        document.getElementById('tax-name').innerText = tIdx.n;
        document.getElementById('tax-impact').innerText = `+${S.pop.curr * tIdx.g}üí∞ / ${tIdx.h}‚ù§Ô∏è`;
        if(tIdx.h < 0) document.getElementById('tax-impact').style.color = 'var(--danger)';
        else document.getElementById('tax-impact').style.color = 'var(--success)';

        document.getElementById('hap-breakdown').innerHTML = `
            <div class="tt-row"><span>Essen:</span><span>${S.factors.food > 0 ? '+'+S.factors.food : S.factors.food}</span></div>
            <div class="tt-row"><span>Steuer:</span><span>${S.factors.tax}</span></div>
            <div class="tt-row"><span>Kirche:</span><span>+${(S.b.church||0)*5}</span></div>
        `;
        
        let maxS = (S.b.stock||1)*50;
        let curS = S.res.wood+S.res.stone+S.res.iron+S.res.wheat+S.res.flour;
        document.getElementById('tt-stock').innerText = `${Math.floor(curS)}/${maxS}`;
        
        let maxF = (S.b.gran||1)*50;
        let curF = S.res.bread+S.res.meat+S.res.apple+S.res.cheese;
        document.getElementById('tt-food').innerText = `${Math.floor(curF)}/${maxF}`;

        let l = Levels.find(x => x.id == S.lvl);
        if(l) {
            let h = "";
            for(let k in l.goal) {
                let v = 0;
                if(k=='pop') v = S.pop.curr;
                else if(k=='soldier') v = sold;
                else v = S.res[k] || S.b[k] || 0;
                let c = v >= l.goal[k] ? 'obj-done' : '';
                h += `<span class="${c}">${SafeT(k)}: ${Math.floor(v)}/${l.goal[k]}</span> `;
            }
            document.getElementById('obj-disp').innerHTML = h;
        }

        this.updateBuildState();
        if(document.getElementById('war-mask').style.display === 'flex') {
            document.getElementById('army-str').innerText = Game.getArmyStr();
        }
    },

    updateBuildState: function() {
        document.querySelectorAll('.b-card').forEach(card => {
            let key = card.getAttribute('data-key');
            if(!key) return;
            let b = Config.b[key];
            let can = S.res.gold >= (b.cost.g||0) && S.res.wood >= (b.cost.w||0) && S.res.stone >= (b.cost.s||0);
            
            if(can) card.classList.add('can-build');
            else card.classList.remove('can-build');
            
            let txt = [];
            if(b.cost.g) txt.push(`<span class="${S.res.gold<b.cost.g?'missing-res':''}">${b.cost.g}üí∞</span>`);
            if(b.cost.w) txt.push(`<span class="${S.res.wood<b.cost.w?'missing-res':''}">${b.cost.w}üå≤</span>`);
            if(b.cost.s) txt.push(`<span class="${S.res.stone<b.cost.s?'missing-res':''}">${b.cost.s}üß±</span>`);
            
            card.querySelector('.cost-disp').innerHTML = txt.join(' ');
        });
    },

    showFloatingText: function(key, text, type) {
        let targetId = "";
        if(['wood','stone','iron','wheat','flour'].includes(key)) targetId = 'rg-store';
        else if(['bread','meat','apple','cheese'].includes(key)) targetId = 'rg-food';
        else if(key === 'gold') targetId = 'rg-gold';
        else return; 
        
        let target = document.getElementById(targetId);
        if(!target) return;
        
        let el = document.createElement('div');
        el.className = 'float-txt';
        el.style.color = type === 'pos' ? '#4caf50' : '#f44336';
        el.innerText = text;
        target.appendChild(el);
        
        setTimeout(() => el.remove(), 1500);
    },

    showMapClickEffect: function(el, icon) {
        let pop = document.createElement('div');
        pop.className = 'click-pop';
        pop.innerText = icon;
        let rect = el.getBoundingClientRect();
        let x = Math.random() * (rect.width - 20);
        let y = Math.random() * (rect.height - 20);
        pop.style.left = x + 'px';
        pop.style.top = y + 'px';
        el.appendChild(pop);
        setTimeout(() => pop.remove(), 800);
    },

    log: function(t, c) {
        let d = document.createElement('div');
        d.className = `log-entry ${c}`;
        d.innerText = `Tag ${S.day}: ${t}`;
        let log = document.getElementById('log');
        log.prepend(d);
        if(log.childNodes.length > 20) log.removeChild(log.lastChild);
    },

    setCat: function(c) {
        this.cat = c; 
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if(event && event.currentTarget) event.currentTarget.classList.add('active');
        this.renderBuild();
        this.updateBuildState();
    },

    renderBuild: function() {
        const d = document.getElementById('build-list'); d.innerHTML = "";
        for(let k in Config.b) {
            let b = Config.b[k];
            if(b.c !== this.cat) continue;
            
            let el = document.createElement('div'); el.className = "b-card";
            el.setAttribute('data-key', k);
            el.onclick = () => Game.build(k);
            
            el.innerHTML = `
                ${S.b[k]>0 ? `<div class="b-count">${S.b[k]}</div>`:''}
                <div style="font-size:2rem">${b.i}</div>
                <div style="font-size:0.7rem;font-weight:bold">${b.n}</div>
                <div class="cost-disp" style="font-size:0.6rem;color:#666"></div>
            `;
            d.appendChild(el);
        }
    },

    renderMap: function() {
        ['forest','mountain','town','farm'].forEach(z => {
            let el = document.getElementById('z-'+z);
            let nodes = Array.from(el.childNodes);
            nodes.forEach(n => {
                if(n.className === 'map-b' || n.className === 'click-pop') el.removeChild(n);
            });
        });
        for(let k in S.b) {
            for(let i=0; i<S.b[k]; i++) this.addMapIcon(k);
        }
    },

    addMapIcon: function(k) {
        let b = Config.b[k];
        let zone = document.getElementById(b.z);
        if(zone) {
            let d = document.createElement('div'); d.className='map-b'; d.innerText = b.i;
            d.title = b.n;
            d.style.left = (10 + Math.random() * 70) + '%';
            d.style.top = (10 + Math.random() * 70) + '%';
            zone.appendChild(d);
        }
    },

    showModal: function(t, b, btnTxt, cb) {
        document.getElementById('m-title').innerText = t;
        document.getElementById('m-body').innerText = b;
        let btn = document.getElementById('m-btn');
        btn.innerText = btnTxt || "OK";
        
        let newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.onclick = function() {
            document.getElementById('modal-mask').style.display = 'none';
            S.paused = false;
            lastTickTime = Date.now(); 
            if(cb) cb();
        };
        
        document.getElementById('modal-mask').style.display = 'flex';
    },

    openRecruit: function() {
        document.getElementById('recruit-mask').style.display='flex';
        let l = document.getElementById('recruit-list'); l.innerHTML="";
        for(let k in Units) {
            let u = Units[k];
            let row = document.createElement('div'); row.className='list-item';
            let cost = `${u.cost}üí∞` + (u.res ? ` +1 ${SafeT(u.res)}` : "");
            row.innerHTML = `<span>${u.n} (${u.str}‚öîÔ∏è)</span><button class="btn" style="padding:2px 8px" onclick="Game.recruit('${k}')">Ausbilden (${cost})</button>`;
            l.appendChild(row);
        }
    },
    closeRecruit: function() { document.getElementById('recruit-mask').style.display='none'; },

    openWar: function() {
        document.getElementById('war-mask').style.display='flex';
        let l = document.getElementById('war-list'); l.innerHTML="";
        document.getElementById('army-str').innerText = Game.getArmyStr();
        
        Missions.forEach((m, idx) => {
            let row = document.createElement('div'); row.className='war-card';
            let lootTxt = [];
            for(let k in m.loot) lootTxt.push(`${m.loot[k]} ${SafeT(k)}`);
            row.innerHTML = `
                <div>
                    <div style="font-weight:bold">${m.n}</div>
                    <div class="war-loot">Beute: ${lootTxt.join(', ')}</div>
                </div>
                <div style="text-align:right">
                    <div class="war-lvl">St√§rke: ${m.str}</div>
                    <button class="btn" style="margin-top:5px; background:var(--danger); color:#fff" onclick="Game.launchWar(${idx})">Angriff!</button>
                </div>
            `;
            l.appendChild(row);
        });
    },
    closeWar: function() { document.getElementById('war-mask').style.display='none'; },

    openMarket: function() {
        document.getElementById('market-mask').style.display='flex';
        this.renderMarket();
    },
    closeMarket: function() { document.getElementById('market-mask').style.display='none'; },
    renderMarket: function() {
        let l = document.getElementById('market-list'); l.innerHTML="";
        // ALL TRADEABLE GOODS
        ['wood','stone','iron','pitch','wheat','flour','hops','bread','meat','cheese','apple','beer','bow','spear','sword','armor','leather'].forEach(k => {
            let row = document.createElement('div'); row.className='list-item';
            row.innerHTML = `<span>${SafeT(k)}: ${Math.floor(S.res[k]||0)}</span><div><button onclick="Game.trade('${k}',1)">Kauf</button> <button onclick="Game.trade('${k}',0)">Verk</button></div>`;
            l.appendChild(row);
        });
    }
};

Game.init();
</script>
</body>
</html>
