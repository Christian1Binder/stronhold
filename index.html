<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burgherr WebApp - Split UI</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #2b2b2b;
            --bg-panel: #fdf6e3;
            --primary: #8b5e3c;
            --primary-dark: #5d4037;
            --secondary: #37474f;
            --accent: #d32f2f;
            --positive: #2e7d32;
            --highlight: #f9a825;
            --text-main: #333333;
            --text-light: #f1f1f1;
            --border-radius: 8px;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            height: 100vh;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        #app {
            background-color: var(--bg-panel);
            width: 100%;
            max-width: 1400px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- HEADER --- */
        header {
            background-color: var(--secondary);
            color: var(--text-light);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 4px solid var(--primary);
            height: 100px;
        }

        .header-left h1 {
            font-family: 'MedievalSharp', cursive;
            margin: 0; font-size: 1.5rem; color: var(--highlight); text-shadow: 2px 2px 0 #000;
        }

        .res-container { display: flex; gap: 15px; flex: 1; justify-content: flex-end; }
        .res-group {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px; padding: 5px 10px; display: flex; flex-direction: column; min-width: 100px; position: relative;
        }
        .res-items { display: flex; justify-content: space-around; align-items: center; gap: 12px; }
        .res-item { display: flex; flex-direction: column; align-items: center; cursor: help; }
        .res-icon { font-size: 1.2rem; margin-bottom: 2px; }
        .res-val { font-weight: 900; font-size: 1rem; color: #fff; }
        .gold-val { color: var(--highlight); }

        /* --- LAYOUT --- */
        main { display: flex; flex: 1; overflow: hidden; }

        /* Links: Bauen */
        aside.left {
            width: 320px; background-color: #f4ecd8; padding: 15px;
            overflow-y: auto; border-right: 1px solid #dccbb1; display: flex; flex-direction: column; gap: 10px;
        }
        
        /* Rechts: Personal & Status */
        aside.right {
            width: 380px; background-color: #eaddcf; padding: 15px; /* Etwas dunkler zur Unterscheidung */
            overflow-y: auto; border-left: 1px solid #dccbb1; display: flex; flex-direction: column; gap: 10px;
        }
        
        section#center-log {
            flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px;
            background-image: radial-gradient(#f4e4bc 10%, transparent 10%), radial-gradient(#f4e4bc 10%, transparent 10%);
            background-size: 20px 20px; background-color: #ffffff;
        }

        h2 { font-family: 'MedievalSharp', cursive; color: var(--primary-dark); border-bottom: 2px solid var(--primary); font-size: 1.2rem; margin: 0 0 10px 0; }

        /* --- CARDS --- */
        .build-card {
            background: #fff; border: 1px solid #cbb092; padding: 8px; border-radius: 4px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: background 0.2s; cursor: pointer;
        }
        .build-card:hover { background: #fff8e1; border-color: var(--highlight); }
        .build-info { display: flex; flex-direction: column; }
        .build-name { font-weight: bold; font-size: 0.9rem; }
        .build-cost { font-size: 0.75rem; color: #666; }
        .build-count { font-weight: bold; font-size: 1.1rem; color: var(--primary); background: #eee; padding: 2px 6px; border-radius: 4px; }

        .worker-card {
            background: #fff; border: 1px solid #aaa; border-left: 4px solid var(--secondary);
            padding: 8px; border-radius: 4px; display: flex; flex-direction: column; gap: 5px;
        }
        .worker-header { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 4px;}
        .worker-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .w-btn {
            width: 28px; height: 28px; background: var(--secondary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .w-btn:hover { background: var(--primary); }
        .w-display { font-size: 0.9rem; }

        /* --- LOG --- */
        .log-entry { padding: 6px 10px; border-radius: 4px; font-size: 0.9rem; border-left: 3px solid #ccc; background: #fcfcfc; }
        .log-entry.report { border-left-color: var(--highlight); background-color: #fffde7; font-family: monospace; font-size: 0.85rem; color: #333; }
        .log-entry.error { border-left-color: var(--accent); background-color: #ffebee; color: #b71c1c; font-weight: bold; }
        
        /* Bar & Tooltip Styles (wie zuvor) */
        .pop-tooltip { visibility: hidden; width: 200px; background: #333; color: #fff; position: absolute; top: 100%; right: 0; padding: 10px; border-radius: 6px; z-index: 100; font-size: 0.8rem; }
        .res-group:hover .pop-tooltip { visibility: visible; }
        .bar-container { width: 100%; background: #ddd; height: 6px; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: var(--positive); transition: width 0.1s linear; }

    </style>
</head>
<body>

<div id="app">
    <header>
        <div class="header-left">
            <h1>üè∞ Der Burgherr</h1>
        </div>
        <div class="res-container">
            <div class="res-group">
                <div class="res-items">
                    <div class="res-item" title="Gold"><span class="res-icon">üí∞</span><span class="res-val gold-val" id="res-gold">0</span></div>
                    <div class="res-item" title="Holz"><span class="res-icon">üå≤</span><span class="res-val" id="res-wood">0</span></div>
                    <div class="res-item" title="Stein"><span class="res-icon">üß±</span><span class="res-val" id="res-stone">0</span></div>
                    <div class="res-item" title="Eisen"><span class="res-icon">‚õìÔ∏è</span><span class="res-val" id="res-iron">0</span></div>
                </div>
            </div>
            <div class="res-group">
                <div class="res-items">
                    <div class="res-item" title="Brot"><span class="res-icon">üçû</span><span class="res-val" id="res-bread">0</span></div>
                    <div class="res-item" title="Fleisch"><span class="res-icon">ü•©</span><span class="res-val" id="res-meat">0</span></div>
                    <div class="res-item" title="√Ñpfel"><span class="res-icon">üçé</span><span class="res-val" id="res-apple">0</span></div>
                </div>
            </div>
            <div class="res-group">
                <div class="res-items">
                    <div class="res-item" title="Freie Arbeiter / Gesamt"><span class="res-icon">üë®‚Äçüåæ</span><span class="res-val" id="res-workers">0/0</span></div>
                    <div class="res-item" title="Beliebtheit"><span class="res-icon">‚ù§Ô∏è</span><span class="res-val" id="res-pop">0</span></div>
                </div>
                <div class="pop-tooltip" id="pop-details">Details...</div>
            </div>
        </div>
    </header>

    <main>
        <aside class="left">
            <h2>üî® Bau-Men√º</h2>
            <div id="build-list">
                </div>
        </aside>

        <section id="center-log"></section>

        <aside class="right">
            <h2>üë®‚Äçüåæ Personal-B√ºro</h2>
            <div style="font-size:0.85rem; margin-bottom:10px; color:#555;">
                Hier weist du Arbeiter den Geb√§uden zu. Ohne Arbeiter keine Produktion!
            </div>
            
            <div id="worker-list">
                </div>

            <br>
            <hr style="border:0; border-top:1px solid #ccc; margin:10px 0;">
            <h2>üìä Status</h2>
            <div style="font-size:0.9rem">Tag: <span id="stat-day">1</span></div>
            <div class="bar-container" style="margin-top:5px;"><div class="bar-fill" id="day-bar"></div></div>
            
            <br>
            <div style="margin-bottom:5px;">Steuern: <strong id="tax-display">Keine</strong></div>
            <div style="display:flex; gap:5px;">
                <button onclick="Game.setTax(-1)" style="flex:1;">Weniger</button>
                <button onclick="Game.setTax(1)" style="flex:1;">Mehr</button>
            </div>
        </aside>
    </main>
</div>

<script>
const Config = {
    tickRate: 5000, 
    combatStartDay: 40,
    buildings: {
        woodcutter: { name: "Holzf√§ller", costG: 15, costW: 0, costS: 0, output: "wood", amount: 2 },
        quarry:     { name: "Steinbruch", costG: 50, costW: 20, costS: 0, output: "stone", amount: 1 },
        ironmine:   { name: "Eisenmine",  costG: 100, costW: 50, costS: 0, output: "iron", amount: 1 },
        farm_apple: { name: "Apfelgarten", costG: 30, costW: 10, costS: 0, output: "apple", amount: 3 },
        hunter:     { name: "J√§gerstand", costG: 20, costW: 5, costS: 0, output: "meat", amount: 2 },
        farm_wheat: { name: "Getreidefarm", costG: 40, costW: 10, costS: 0, output: "wheat", amount: 2 },
        mill:       { name: "M√ºhle", costG: 80, costW: 30, costS: 10, process: "wheat", product: "flour", ratio: 2 },
        bakery:     { name: "B√§ckerei", costG: 60, costW: 20, costS: 0, process: "flour", product: "bread", ratio: 3 },
        weaponsmith:{ name: "Waffenschmiede", costG: 100, costW: 0, costS: 20, process: "iron", product: "weapons", ratio: 1 },
        house:      { name: "H√ºtte", costG: 0, costW: 10, costS: 0, capacity: 5 },
        barracks:   { name: "Kaserne", costG: 150, costW: 0, costS: 50 }
    },
    taxes: [
        { name: "Bestechung", gold: -2, pop: +5 },
        { name: "Keine", gold: 0, pop: +1 },
        { name: "Niedrig", gold: 2, pop: -2 },
        { name: "Hoch", gold: 4, pop: -6 },
        { name: "Grausam", gold: 8, pop: -15 }
    ]
};

const State = {
    day: 1, paused: false, lastTick: Date.now(),
    res: { gold: 150, wood: 50, stone: 0, iron: 0, wheat: 0, flour: 0, bread: 0, meat: 5, apple: 5, weapons: 0 },
    pop: { current: 5, max: 10, happiness: 100, soldiers: 0 },
    b: {}, w: {}, // Buildings & Workers
    taxIndex: 1, // Start: Keine Steuern
    factors: { food: 0, tax: 0, events: 0 }
};

// Init State
for(let k in Config.buildings) { State.b[k] = 0; State.w[k] = 0; }

const Game = {
    init: function() {
        UI.renderBuildMenu();
        UI.renderWorkerMenu();
        UI.update();
        setInterval(() => { if(!State.paused) this.tick(); }, Config.tickRate);
        setInterval(() => { if(!State.paused) UI.updateBar(); }, 100);
        UI.log("Willkommen! Nutze das Personal-B√ºro (rechts), um Produktion zu starten.", "report");
    },

    tick: function() {
        State.day++;
        State.lastTick = Date.now();
        State.factors = { food: 0, tax: 0, events: 0 };
        
        let report = { produced: [], eaten: [] };

        // 1. Produktion (Logik: Erst produzieren, dann essen)
        // Generische Produktion
        ['woodcutter', 'quarry', 'ironmine', 'farm_apple', 'hunter', 'farm_wheat'].forEach(type => {
            const amount = State.w[type] * Config.buildings[type].amount;
            if(amount > 0) {
                const res = Config.buildings[type].output;
                State.res[res] += amount;
                report.produced.push(`${amount} ${res}`); // F√ºr den Bericht
            }
        });

        // Verarbeitung
        this.process('mill', 'wheat', 'flour', 2, report);
        this.process('bakery', 'flour', 'bread', 3, report);
        this.process('weaponsmith', 'iron', 'weapons', 1, report);

        // 2. Konsum
        let pop = State.pop.current;
        let foodDiversity = 0;
        if(pop > 0) {
            const eat = (type) => {
                if(State.res[type] > 0) {
                    let take = Math.min(State.res[type], pop);
                    State.res[type] -= take;
                    pop -= take;
                    if(take > 0) {
                        report.eaten.push(`${take} ${type}`);
                        foodDiversity++;
                    }
                }
            };
            eat('bread'); eat('meat'); eat('apple');
            
            if(pop > 0) { // Immer noch hungrig?
                UI.log(`HUNGER! ${pop} Leute haben nichts bekommen!`, "error");
                State.factors.food = -20;
            } else {
                State.factors.food = foodDiversity; // Bonus f√ºr Vielfalt
            }
        }

        // 3. Steuern
        const tax = Config.taxes[State.taxIndex];
        if(State.pop.current > 0) {
            State.res.gold += (State.pop.current * tax.gold);
            State.factors.tax = tax.pop;
        }

        // 4. Beliebtheit
        State.pop.happiness += (State.factors.food + State.factors.tax + State.factors.events);
        State.pop.happiness = Math.max(0, Math.min(100, State.pop.happiness));

        // 5. Migration
        this.handleMigration();

        // TAGESBERICHT SCHREIBEN
        let logText = "";
        if(report.produced.length > 0) logText += `<b>Prod:</b> ${report.produced.join(', ')}. `;
        if(report.eaten.length > 0) logText += `<b>Verbrauch:</b> ${report.eaten.join(', ')}.`;
        if(logText !== "") UI.log(logText, "report");

        UI.update();
    },

    process: function(b, inRes, outRes, ratio, report) {
        let workers = State.w[b];
        if(workers > 0) {
            let possible = Math.min(State.res[inRes], workers);
            if(possible > 0) {
                State.res[inRes] -= possible;
                let outAmount = possible * ratio;
                State.res[outRes] += outAmount;
                report.produced.push(`${outAmount} ${outRes}`);
            }
        }
    },

    handleMigration: function() {
        if(State.pop.happiness > 50 && State.pop.current < State.pop.max && Math.random() < 0.3) {
            State.pop.current++;
            UI.log("Ein neuer Siedler ist eingezogen.", "success");
        }
        if(State.pop.happiness < 20 && State.pop.current > 0) {
            this.removeRandomWorker();
            State.pop.current--;
            State.pop.happiness = 30;
            UI.log("Ein Siedler ist abgehauen!", "error");
        }
    },

    removeRandomWorker: function() {
        for(let k in State.w) { if(State.w[k] > 0) { State.w[k]--; return; } }
    },

    // Aktionen
    build: function(type) {
        let c = Config.buildings[type];
        if(State.res.gold >= c.costG && State.res.wood >= c.costW && State.res.stone >= c.costS) {
            State.res.gold -= c.costG; State.res.wood -= c.costW; State.res.stone -= c.costS;
            State.b[type]++;
            if(c.capacity) State.pop.max += c.capacity;
            UI.renderWorkerMenu(); // Men√º neu rendern (wegen neuer Limits)
            UI.update();
        }
    },

    assignWorker: function(type, delta) {
        let assigned = Object.values(State.w).reduce((a,b)=>a+b,0);
        let free = State.pop.current - State.pop.soldiers - assigned;

        if(delta === 1) {
            if(free <= 0) return; // Keine Leute
            if(State.w[type] >= State.b[type]) return; // Kein Arbeitsplatz
            State.w[type]++;
        } else {
            if(State.w[type] <= 0) return;
            State.w[type]--;
        }
        UI.update();
    },

    setTax: function(d) {
        let n = State.taxIndex + d;
        if(n >= 0 && n < Config.taxes.length) { State.taxIndex = n; UI.update(); }
    }
};

const UI = {
    renderBuildMenu: function() {
        const el = document.getElementById('build-list'); el.innerHTML = "";
        for(let k in Config.buildings) {
            if(k === 'barracks') continue; // Kaserne lassen wir erstmal raus f√ºr Platz
            let b = Config.buildings[k];
            let cost = `${b.costG} Gold`;
            if(b.costW) cost += `, ${b.costW} Holz`;
            
            let div = document.createElement('div');
            div.className = "build-card";
            div.onclick = () => Game.build(k);
            div.innerHTML = `
                <div class="build-info">
                    <span class="build-name">${b.name}</span>
                    <span class="build-cost">${cost}</span>
                </div>
                <span class="build-count" id="count-${k}">0</span>
            `;
            el.appendChild(div);
        }
    },

    renderWorkerMenu: function() {
        const el = document.getElementById('worker-list'); el.innerHTML = "";
        // Nur Geb√§ude mit Arbeitern anzeigen (keine H√§user)
        const workerBuildings = ['woodcutter', 'quarry', 'ironmine', 'farm_apple', 'hunter', 'farm_wheat', 'mill', 'bakery', 'weaponsmith'];
        
        workerBuildings.forEach(k => {
            let b = Config.buildings[k];
            let div = document.createElement('div');
            div.className = "worker-card";
            div.innerHTML = `
                <div class="worker-header">
                    <span>${b.name}</span>
                    <span style="font-weight:normal; font-size:0.8rem">Geb√§ude: <span id="w-build-${k}">0</span></span>
                </div>
                <div class="worker-controls">
                    <button class="w-btn" onclick="Game.assignWorker('${k}', -1)">-</button>
                    <span class="w-display"><span id="w-curr-${k}">0</span> / <span id="w-max-${k}">0</span> Arbeiter</span>
                    <button class="w-btn" onclick="Game.assignWorker('${k}', 1)">+</button>
                </div>
            `;
            el.appendChild(div);
        });
    },

    update: function() {
        const s = State;
        // Res
        document.getElementById('res-gold').innerText = Math.floor(s.res.gold);
        document.getElementById('res-wood').innerText = Math.floor(s.res.wood);
        document.getElementById('res-stone').innerText = Math.floor(s.res.stone);
        document.getElementById('res-iron').innerText = Math.floor(s.res.iron);
        document.getElementById('res-bread').innerText = Math.floor(s.res.bread);
        document.getElementById('res-meat').innerText = Math.floor(s.res.meat);
        document.getElementById('res-apple').innerText = Math.floor(s.res.apple);
        
        // Pop
        const assigned = Object.values(s.w).reduce((a,b)=>a+b,0);
        const free = s.pop.current - s.pop.soldiers - assigned;
        document.getElementById('res-workers').innerText = `${free} / ${s.pop.current}`;
        
        const popEl = document.getElementById('res-pop');
        popEl.innerText = s.pop.happiness;
        popEl.style.color = s.pop.happiness > 50 ? '#81c784' : '#e57373';

        // Tooltip Content
        document.getElementById('pop-details').innerHTML = 
            `Nahrung: ${s.factors.food > 0 ? '+'+s.factors.food : s.factors.food}<br>` +
            `Steuern: ${s.factors.tax > 0 ? '+'+s.factors.tax : s.factors.tax}<br>` + 
            `Events: ${s.factors.events}`;

        // Build Counts
        for(let k in s.b) {
            let el = document.getElementById(`count-${k}`);
            if(el) el.innerText = s.b[k];
            
            // Worker Updates
            let elBuild = document.getElementById(`w-build-${k}`);
            if(elBuild) elBuild.innerText = s.b[k];
            
            let elCurr = document.getElementById(`w-curr-${k}`);
            if(elCurr) elCurr.innerText = s.w[k];
            
            let elMax = document.getElementById(`w-max-${k}`);
            if(elMax) elMax.innerText = s.b[k];
        }

        document.getElementById('stat-day').innerText = s.day;
        document.getElementById('tax-display').innerText = Config.taxes[s.taxIndex].name;
    },

    updateBar: function() {
        const pct = ((Date.now() - State.lastTick) / Config.tickRate) * 100;
        document.getElementById('day-bar').style.width = Math.min(pct, 100) + "%";
    },

    log: function(msg, type='') {
        const box = document.getElementById('center-log');
        const div = document.createElement('div');
        div.className = `log-entry ${type}`;
        div.innerHTML = `<strong>T${State.day}:</strong> ${msg}`;
        box.prepend(div);
    }
};

Game.init();
</script>
</body>
</html>
