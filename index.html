<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burgherr V7 - Fixed & Polished</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #1a1a1a; 
            --scroll-bg: #fdf5e6;
            --scroll-border: #8b5a2b;
            --primary: #5d4037; 
            --accent: #d32f2f; 
            --highlight: #ffb300;
            --text-dark: #3e2723;
        }

        * { box-sizing: border-box; user-select: none; }
        body { font-family: 'Lato', sans-serif; background: var(--bg-body); color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header { 
            background: #2d2d2d; height: 100px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; border-bottom: 2px solid #444;
        }
        
        .header-info { display: flex; flex-direction: column; width: 250px; }
        .level-display { font-family: 'MedievalSharp'; font-size: 1.4rem; color: var(--highlight); margin-bottom: 2px; }
        .objective { font-size: 0.75rem; color: #ccc; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 4px; border-left: 3px solid var(--highlight); }
        .obj-item { display: inline-block; margin-right: 8px; }
        .obj-done { color: #81c784; text-decoration: line-through; opacity: 0.6; }

        .res-bar { display: flex; gap: 8px; flex:1; justify-content: flex-end; }
        .res-box { 
            background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 4px; 
            padding: 3px 6px; min-width: 60px; text-align: center; position: relative;
        }
        .res-label { font-size: 0.55rem; text-transform: uppercase; color: #999; border-bottom: 1px solid #444; display: block; margin-bottom: 2px;}
        .res-row { font-size: 0.85rem; font-weight: bold; display: flex; gap: 8px; justify-content: center; }
        
        /* HOVER TOOLTIP (Wieder da!) */
        .tooltip { 
            visibility: hidden; opacity: 0; position: absolute; top: 100%; right: 0; 
            background: #222; border: 1px solid #666; padding: 10px; border-radius: 4px; 
            width: 180px; z-index: 100; text-align: left; transition: 0.2s; pointer-events: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-top: 5px;
        }
        .res-box:hover .tooltip { visibility: visible; opacity: 1; }
        .tt-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px; }
        .tt-val.pos { color: #81c784; } .tt-val.neg { color: #e57373; }

        /* --- MAIN --- */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }

        #village-map {
            flex: 1; background: radial-gradient(#558b2f 10%, #33691e 90%);
            position: relative; overflow: hidden; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 5px; padding: 20px;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
        }
        .map-icon { font-size: 1.8rem; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 5px; animation: pop 0.3s; cursor: default; }
        .map-icon:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        @keyframes pop { from{transform:scale(0)} to{transform:scale(1)} }

        aside.right { 
            width: 320px; background: #d7ccc8; color: var(--text-dark);
            border-left: 4px solid var(--scroll-border); display: flex; flex-direction: column; 
        }
        
        .log-area { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 5px; background: rgba(255,255,255,0.3); }
        .log-card { background: #fff; padding: 6px; border-radius: 4px; font-size: 0.8rem; border-left: 4px solid #aaa; box-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-shrink: 0; }
        .log-card.report { border-color: #558b2f; background: #f1f8e9; }
        .log-card.error { border-color: #d32f2f; background: #ffebee; font-weight: bold; }
        .log-card.info { border-color: #ffb300; }

        .controls-area { padding: 10px; background: #bcaaa4; border-top: 2px solid var(--primary); }
        .btn-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .ctrl-btn { flex: 1; padding: 8px; border: 1px solid #5d4037; background: #efebe9; font-weight: bold; cursor: pointer; border-radius: 3px; font-size: 0.8rem; }
        .ctrl-btn:hover { background: #fff; }

        /* --- FOOTER --- */
        footer {
            height: 150px; background: var(--scroll-bg); border-top: 5px solid var(--scroll-border);
            display: flex; align-items: center; padding: 0 15px; flex-shrink: 0; z-index: 20;
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            color: var(--text-dark);
        }

        .category-bar { display: flex; gap: 5px; padding-right: 15px; border-right: 2px solid #c5afa0; margin-right: 10px; flex-wrap: wrap; width: 130px; justify-content: center; }
        .cat-icon { width: 35px; height: 35px; background: #8d6e63; color: #fff; border: 2px solid #5d4037; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; }
        .cat-icon:hover { transform: translateY(-2px); background: #a1887f; }
        .cat-icon.selected { background: var(--highlight); color: #000; border-color: #fff; }

        .building-scroll { display: flex; overflow-x: auto; gap: 10px; align-items: center; height: 100%; padding-bottom: 5px; flex: 1; }
        .build-item {
            min-width: 75px; height: 95px; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; cursor: pointer; position: relative;
            background: rgba(0,0,0,0.05); border-radius: 6px; padding: 4px; transition: 0.2s; border: 1px solid transparent;
        }
        .build-item:hover { background: rgba(0,0,0,0.1); transform: scale(1.05); border-color: #8b5a2b; }
        .build-count { position: absolute; top: -5px; right: -5px; background: var(--accent); color: #fff; font-size: 0.7rem; padding: 1px 5px; border-radius: 10px; font-weight: bold; box-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; }
        .modal-box { background: var(--scroll-bg); padding: 20px; width: 500px; border: 4px solid var(--scroll-border); border-radius: 8px; text-align: center; color: var(--text-dark); }
        
        .list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; text-align: left; max-height: 400px; overflow-y: auto; margin-top: 10px; }
        .trade-row { background: rgba(255,255,255,0.6); padding: 5px; border: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
    </style>
</head>
<body>

<div id="recruit-modal" class="modal">
    <div class="modal-box">
        <h2 style="margin:0">Rekrutierung</h2>
        <div id="recruit-list" class="list-grid"></div>
        <button onclick="UI.toggleRecruit(false)" class="ctrl-btn" style="margin-top:15px;">Schlie√üen</button>
    </div>
</div>

<div id="market-modal" class="modal">
    <div class="modal-box">
        <h2 style="margin:0">Marktplatz</h2>
        <div id="market-list" class="list-grid"></div>
        <button onclick="UI.toggleMarket(false)" class="ctrl-btn" style="margin-top:15px;">Schlie√üen</button>
    </div>
</div>

<div id="msg-modal" class="modal">
    <div class="modal-box">
        <h2 id="msg-title">Titel</h2>
        <p id="msg-text">Text</p>
        <button onclick="Game.closeMsg()" class="ctrl-btn" style="margin-top:15px; background:var(--highlight);">Weiter</button>
    </div>
</div>

<header>
    <div class="header-info">
        <div class="level-display" id="level-title">Level 1</div>
        <div class="objective" id="objective-text">Lade Daten...</div>
    </div>
    
    <div class="res-bar">
        <div class="res-box">
            <span class="res-label">Schatz</span>
            <div class="res-row">üí∞ <span id="r-gold">0</span></div>
        </div>
        <div class="res-box">
            <span class="res-label">Material</span>
            <div class="res-row">
                <span title="Holz">üå≤<span id="r-wood">0</span></span>
                <span title="Stein">üß±<span id="r-stone">0</span></span>
                <span title="Eisen">‚õìÔ∏è<span id="r-iron">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <span class="res-label">Ernte</span>
            <div class="res-row">
                <span title="Weizen">üåæ<span id="r-wheat">0</span></span>
                <span title="Mehl">ü•°<span id="r-flour">0</span></span>
                <span title="Hopfen">üåø<span id="r-hops">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <span class="res-label">Speise</span>
            <div class="res-row">
                <span title="Brot">üçû<span id="r-bread">0</span></span>
                <span title="Fleisch">ü•©<span id="r-meat">0</span></span>
                <span title="√Ñpfel">üçé<span id="r-apple">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <span class="res-label">Volk & Moral</span>
            <div class="res-row">
                <span title="B√ºrger">üë®‚Äçüåæ <span id="r-pop">0</span></span>
                <span title="Beliebtheit" style="cursor:help">‚ù§Ô∏è <span id="r-hap">0</span></span>
            </div>
            <div class="tooltip" id="hap-tooltip">
                Lade Details...
            </div>
        </div>
    </div>
</header>

<main>
    <div id="village-map"></div>

    <aside class="right">
        <div style="background:#bcaaa4; padding:5px; font-weight:bold; text-align:center; font-size:0.8rem;">
            Tag <span id="game-day">1</span> <span id="pause-indicator" style="color:red; display:none;">(PAUSIERT)</span>
        </div>
        <div class="log-area" id="game-log"></div>
        
        <div class="controls-area">
            <div class="btn-row">
                <button class="ctrl-btn" onclick="UI.toggleRecruit(true)">üõ°Ô∏è Armee</button>
                <button class="ctrl-btn" onclick="UI.toggleMarket(true)">‚öñÔ∏è Markt</button>
            </div>
            
            <div style="font-size:0.8rem; margin:5px 0; background:rgba(255,255,255,0.5); padding:4px;">
                <strong>Steuern:</strong> <span id="tax-disp">Keine</span>
                <div style="display:flex; gap:5px; margin-top:2px;">
                    <button class="ctrl-btn" style="padding:2px;" onclick="Game.tax(-1)">-</button>
                    <button class="ctrl-btn" style="padding:2px;" onclick="Game.tax(1)">+</button>
                </div>
            </div>

            <div style="border-top:1px dashed #555; padding-top:5px; margin-top:5px; font-size:0.75rem;">System</div>
            <div class="btn-row">
                <button class="ctrl-btn" onclick="Game.togglePause()">‚èØÔ∏è</button>
                <button class="ctrl-btn" onclick="Game.save()">üíæ</button>
                <button class="ctrl-btn" onclick="Game.load()">üìÇ</button>
                <button class="ctrl-btn" onclick="Game.reset()" style="background:#ffcdd2;">‚ùå</button>
            </div>
        </div>
    </aside>
</main>

<footer>
    <div class="category-bar">
        <div class="cat-icon selected" onclick="UI.setCat('burg')" title="Burg">üè∞</div>
        <div class="cat-icon" onclick="UI.setCat('werk')" title="Industrie">üî®</div>
        <div class="cat-icon" onclick="UI.setCat('farm')" title="Farmen">üçé</div>
        <div class="cat-icon" onclick="UI.setCat('stadt')" title="Stadt">üè†</div>
        <div class="cat-icon" onclick="UI.setCat('waffen')" title="Waffen">‚öîÔ∏è</div>
        <div class="cat-icon" onclick="UI.setCat('nahrung')" title="Verarbeitung">üçû</div>
    </div>

    <div class="building-scroll" id="build-list"></div>
</footer>

<script>
/* DATEN */
const Labels = {
    wood:"Holz", stone:"Stein", iron:"Eisen", pitch:"Pech", wheat:"Weizen", flour:"Mehl", hops:"Hopfen",
    meat:"Fleisch", apple:"√Ñpfel", cheese:"K√§se", bread:"Brot", beer:"Bier",
    bow:"Bogen", spear:"Speer", sword:"Schwert", armor:"R√ºstung", leather:"Harnisch",
    gold:"Gold", pop:"Einwohner", soldiers:"Soldaten", cath:"Kathedrale", tower:"Wachturm"
};

const Levels = [
    { id: 1, title: "Die Gr√ºndung", intro: "Willkommen, Sire! Baut Holzf√§ller und H√ºtten.", goal: { wood: 50, pop: 10 }, start: { gold:100, wood:20, food:20 } },
    { id: 2, title: "Stein & Brot", intro: "Wir brauchen Steinbr√ºche (mit Ochsen) und Brot.", goal: { bread: 30, stone: 20 }, start: { gold:150, wood:50, food:30 } },
    { id: 3, title: "Aufr√ºstung", intro: "Produziert Waffen f√ºr die kommende Schlacht.", goal: { bow: 5, spear: 5 }, start: { gold:200, wood:100, stone:50, food:50 } },
    { id: 4, title: "Krieg", intro: "Bildet 10 Soldaten aus.", goal: { soldiers: 10 }, start: { gold:300, wood:100, stone:100, iron:20, food:100 } },
    { id: 5, title: "Die Kathedrale", intro: "Das Meisterwerk.", goal: { cath: 1 }, start: { gold:1000, wood:500, stone:500, iron:100, food:200 } }
];

const Units = {
    archer: { name: "Bogensch√ºtze", cost: 10, res: "bow", str: 5 },
    spear: { name: "Pikenier", cost: 15, res: "spear", str: 8 },
    sword: { name: "Schwertk√§mpfer", cost: 30, res: "sword", armor: "armor", str: 15 },
    merc: { name: "S√∂ldner", cost: 50, str: 10 } // Nur Gold
};

const Config = {
    tick: 5000,
    taxes: ["Keine", "Niedrig", "Mittel", "Hoch", "Grausam"],
    buildings: {
        // BURG
        wall_w: { name:"Holzwall", cat:"burg", icon:"ü™µ", cost:{g:10,w:20}, def:10 },
        wall_s: { name:"Steinmauer", cat:"burg", icon:"üß±", cost:{g:50,s:20}, def:50 },
        tower:  { name:"Wachturm", cat:"burg", icon:"üóº", cost:{g:100,s:50}, def:150 },
        gate:   { name:"Torhaus", cat:"burg", icon:"‚õ©Ô∏è", cost:{g:50,w:20,s:20}, def:20 },
        barracks: { name:"Kaserne", cat:"burg", icon:"‚õ∫", cost:{g:150,s:20}, desc:"Rekrutierung" },
        merc_post: { name:"S√∂ldnerlager", cat:"burg", icon:"üé™", cost:{g:500,w:100}, desc:"S√∂ldner" },

        // WERKSTATT (Hier ist jetzt das Vorratslager!)
        stock:  { name:"Vorratslager", cat:"werk", icon:"üì¶", cost:{w:20}, desc:"+50 Lager" },
        wood:   { name:"Holzf√§ller", cat:"werk", icon:"ü™ì", cost:{g:10}, prod:"wood", amt:3 },
        ox:     { name:"Ochsenjoch", cat:"werk", icon:"üêÇ", cost:{g:20,w:20} },
        quarry: { name:"Steinbruch", cat:"werk", icon:"‚õèÔ∏è", cost:{g:50,w:50}, prod:"stone", amt:2, need:"ox" },
        iron:   { name:"Eisenmine", cat:"werk", icon:"‚õìÔ∏è", cost:{g:100,w:100}, prod:"iron", amt:1 },
        pitch:  { name:"Pechgrube", cat:"werk", icon:"‚ö´", cost:{g:150,w:50}, prod:"pitch", amt:1 },

        // FARM
        apple:  { name:"Obstgarten", cat:"farm", icon:"üçé", cost:{g:30,w:10}, prod:"apple", amt:3 },
        hunter: { name:"J√§gerstand", cat:"farm", icon:"üèπ", cost:{g:20,w:5}, prod:"meat", amt:2 },
        dairy:  { name:"K√§serei", cat:"farm", icon:"üßÄ", cost:{g:40,w:20}, prod:"cheese", amt:2 },
        wheat:  { name:"Getreide", cat:"farm", icon:"üåæ", cost:{g:40,w:10}, prod:"wheat", amt:2 },
        hops:   { name:"Hopfen", cat:"farm", icon:"üåø", cost:{g:40,w:10}, prod:"hops", amt:2 },

        // STADT
        hovel:  { name:"H√ºtte", cat:"stadt", icon:"üõñ", cost:{w:10}, pop:5 },
        house:  { name:"Haus", cat:"stadt", icon:"üè†", cost:{g:50,w:30,s:10}, pop:10 },
        church: { name:"Kirche", cat:"stadt", icon:"‚õ™", cost:{g:500,s:100}, rel:10 },
        cath:   { name:"KATHEDRALE", cat:"stadt", icon:"üïç", cost:{g:5000,s:2000}, rel:50 },
        apoth:  { name:"Apotheke", cat:"stadt", icon:"üíä", cost:{g:200,w:50}, hap:5 },
        well:   { name:"Brunnen", cat:"stadt", icon:"üíß", cost:{g:50,s:10}, hap:2 },

        // WAFFEN
        fletcher: { name:"Pfeilmacher", cat:"waffen", icon:"üèπ", cost:{g:100,w:50}, use:"wood", out:"bow", amt:1 },
        pole:     { name:"Pikenmacher", cat:"waffen", icon:"üî±", cost:{g:100,w:50}, use:"wood", out:"spear", amt:1 },
        smith:    { name:"Schmiede", cat:"waffen", icon:"‚öîÔ∏è", cost:{g:200,w:100}, use:"iron", out:"sword", amt:1 },
        armor:    { name:"R√ºstung", cat:"waffen", icon:"üõ°Ô∏è", cost:{g:200,w:100}, use:"iron", out:"armor", amt:1 },
        tanner:   { name:"Gerber", cat:"waffen", icon:"üß•", cost:{g:100,w:50}, need:"dairy", prod:"leather", amt:1 },

        // NAHRUNG
        granary: { name:"Kornspeicher", cat:"nahrung", icon:"üõñ", cost:{w:20}, cap:50 },
        mill:    { name:"M√ºhle", cat:"nahrung", icon:"‚öôÔ∏è", cost:{g:100,w:50}, proc:"wheat", out:"flour", ratio:1 },
        bake:    { name:"B√§ckerei", cat:"nahrung", icon:"üçû", cost:{g:50,w:20}, proc:"flour", out:"bread", ratio:4 },
        brew:    { name:"Brauerei", cat:"nahrung", icon:"üç∫", cost:{g:100,w:20}, proc:"hops", out:"beer", ratio:2 },
        inn:     { name:"Schenke", cat:"nahrung", icon:"üçª", cost:{g:200,w:100}, hap:10 }
    }
};

let State = {};

const Game = {
    init: function() {
        // Neuer Save-Slot "v7" erzwingt Neustart bei alten Bug-Saves
        if(localStorage.getItem('burgherr_v7')) this.load();
        else this.startLevel(1);
        
        UI.init();
        setInterval(this.tick, Config.tick);
        setInterval(UI.updateBar, 100);
        setInterval(this.save, 30000); 
    },

    startLevel: function(lvlId) {
        let l = Levels.find(x => x.id == lvlId);
        if(!l) return alert("Alle Level geschafft!");
        
        State = {
            level: lvlId, day: 1, paused: true, lastTick: Date.now(),
            res: { ...l.start, stone:0, iron:0, pitch:0, wheat:0, flour:0, bread:l.start.food||0, cheese:0, meat:0, apple:0, hops:0, beer:0, bow:0, spear:0, sword:0, armor:0, leather:0 },
            pop: { curr:5, max:0, sold:0, merc:0, hap:100 },
            b: {}, w: {}, tax: 0,
            factors: { food:0, tax:0, other:0 }
        };
        for(let k in Config.buildings) { State.b[k]=0; State.w[k]=0; }
        // Start Buildings
        State.b.stock = 1; State.b.granary = 1;
        
        UI.showMsg(`Level ${lvlId}`, l.intro);
        UI.renderMap();
        UI.update();
    },

    tick: function() {
        if(State.paused) return;
        try {
            State.day++;
            State.lastTick = Date.now();
            let log = [];

            // 1. Prod
            for(let k in Config.buildings) {
                let b = Config.buildings[k];
                let n = State.w[k];
                if(n <= 0) continue;

                // Dependencies
                if(b.need && State.b[b.need] < n) n = State.b[b.need]; 

                // Prod
                if(b.prod) { State.res[b.prod] += (n * (b.amt||1)); }
                // Proc
                if(b.proc) {
                    let take = Math.min(State.res[b.proc], n);
                    if(take > 0) { State.res[b.proc]-=take; State.res[b.out]+=(take*(b.ratio||1)); }
                }
                // Craft
                if(b.use) {
                    if(State.res[b.use] >= n) { State.res[b.use]-=n; State.res[b.out]+=(n*(b.amt||1)); }
                }
            }

            // 2. Food
            let eat = State.pop.curr;
            let foods = ['bread','meat','cheese','apple'];
            let ateCount = 0;
            foods.forEach(f => {
                if(eat>0 && State.res[f]>0) {
                    let take = Math.min(eat, State.res[f]);
                    State.res[f]-=take; eat-=take; ateCount++;
                }
            });
            
            let hapChg = 0;
            if(eat > 0) { UI.log(`${eat} hungern!`, 'error'); hapChg -= 20; }
            else hapChg += (ateCount + 1);
            State.factors.food = eat > 0 ? -20 : (ateCount + 1);

            // 3. Tax & Beer
            let taxVals = [2, 0, -2, -5, -15];
            let taxGold = [-2, 0, 2, 4, 8];
            hapChg += taxVals[State.tax];
            State.res.gold += (State.pop.curr * taxGold[State.tax]);
            State.factors.tax = taxVals[State.tax];

            if(State.res.beer >= State.pop.curr && State.pop.curr > 0) {
                State.res.beer -= State.pop.curr;
                hapChg += 5;
            }

            // Church & Misc
            let bonus = (State.b.church * 5) + (State.b.well * 2) + (State.b.inn * 3);
            hapChg += bonus;
            State.factors.other = bonus + (State.res.beer>=State.pop.curr ? 5 : 0);

            State.pop.hap = Math.max(0, Math.min(100, State.pop.hap + hapChg));

            // 4. Pop
            State.pop.max = (State.b.hovel*5) + (State.b.house*10) + 5;
            let work = 0; for(let k in State.w) work += State.w[k];
            let idle = State.pop.curr - State.pop.sold - State.pop.merc - work;

            if(State.pop.hap > 60 && State.pop.curr < State.pop.max && Math.random()>0.5) {
                State.pop.curr++; UI.log("B√ºrger zugewandert", "success"); Game.autoAssign();
            } else if(State.pop.hap < 20 && State.pop.curr > 0) {
                State.pop.curr--; UI.log("B√ºrger geflohen", "error");
                // Remove random worker
                for(let k in State.w) if(State.w[k]>0){State.w[k]--; break;}
            }

            // 5. Win
            let l = Levels.find(x => x.id == State.level);
            let win = true;
            for(let k in l.goal) {
                let val = 0;
                if(k=='pop') val = State.pop.curr;
                else if(k=='soldiers') val = State.pop.sold + State.pop.merc;
                else val = State.res[k] || State.b[k] || 0;
                
                if(val < l.goal[k]) win = false;
            }
            if(win) {
                State.paused = true;
                UI.showMsg("SIEG!", "Level geschafft!", () => Game.startLevel(State.level+1));
            }

            UI.update();
        } catch(e) {
            console.error(e); State.paused = true; alert("Fehler im Spielablauf. Neustart empfohlen.");
        }
    },

    autoAssign: function() {
        let work = 0; for(let k in State.w) work += State.w[k];
        let idle = State.pop.curr - State.pop.sold - State.pop.merc - work;
        if(idle <= 0) return;

        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            if((b.prod || b.proc || b.use) && State.b[k] > State.w[k]) {
                State.w[k]++; idle--;
                if(idle<=0) break;
            }
        }
    },

    build: function(key) {
        let b = Config.buildings[key];
        if(State.res.gold >= (b.cost.g||0) && State.res.wood >= (b.cost.w||0) && State.res.stone >= (b.cost.s||0)) {
            State.res.gold -= (b.cost.g||0); State.res.wood -= (b.cost.w||0); State.res.stone -= (b.cost.s||0);
            State.b[key]++;
            UI.addMapIcon(b.icon);
            Game.autoAssign();
            UI.update();
        } else UI.log("Zu wenig Rohstoffe", "error");
    },

    recruit: function(type) {
        let work = 0; for(let k in State.w) work += State.w[k];
        let idle = State.pop.curr - State.pop.sold - State.pop.merc - work;

        if(type === 'merc') {
            if(State.b.merc_post < 1) return UI.log("S√∂ldnerlager n√∂tig", "error");
            if(State.res.gold < 50) return UI.log("Zu wenig Gold (50)", "error");
            State.res.gold -= 50; State.pop.merc++;
            UI.log("S√∂ldner angeheuert", "success");
        } else {
            // Units from Menu
            if(State.b.barracks < 1) return UI.log("Kaserne n√∂tig", "error");
            if(idle < 1) return UI.log("Keine freien Bauern", "error");
            
            let u = Units[type];
            if(!u) return;
            if(State.res.gold < u.cost) return UI.log("Zu wenig Gold", "error");
            if(u.res && State.res[u.res] < 1) return UI.log(Labels[u.res] + " fehlt!", "error");
            if(u.armor && State.res[u.armor] < 1) return UI.log("R√ºstung fehlt!", "error");

            State.res.gold -= u.cost;
            if(u.res) State.res[u.res]--;
            if(u.armor) State.res[u.armor]--;
            State.pop.curr--; // Bauer wird Soldat
            State.pop.sold++;
            UI.log(u.name + " ausgebildet", "success");
        }
        UI.update();
    },

    tax: function(d) {
        let n = State.tax + d;
        if(n >= 0 && n < 5) State.tax = n;
        UI.update();
    },

    trade: function(item, buy) {
        if(buy && State.res.gold >= 5) { State.res.gold-=5; State.res[item]+=5; }
        if(!buy && State.res[item] >= 5) { State.res[item]-=5; State.res.gold+=3; }
        UI.update(); UI.renderMarket();
    },

    togglePause: function() { State.paused = !State.paused; UI.update(); },
    save: function() { localStorage.setItem('burgherr_v7', JSON.stringify(State)); UI.log("Gespeichert", "info"); },
    load: function() { 
        let d = localStorage.getItem('burgherr_v7'); 
        if(d) { State = JSON.parse(d); State.paused = true; UI.renderMap(); UI.update(); UI.showMsg("Geladen","Willkommen zur√ºck"); }
    },
    reset: function() { localStorage.removeItem('burgherr_v7'); location.reload(); },
    closeMsg: function() { document.getElementById('msg-modal').style.display = 'none'; State.paused = false; State.lastTick = Date.now(); },
    
    startRaid: function() {
        let army = State.pop.sold + State.pop.merc;
        if(army < 5) return UI.log("Min. 5 Mann n√∂tig", "error");
        UI.log("Raubzug gestartet (Dauer: kurz)...", "info");
        setTimeout(()=>{
            if(Math.random()>0.3) {
                let g = Math.floor(Math.random()*100)+50;
                State.res.gold += g; UI.log(`Erfolg! ${g} Gold erbeutet.`, "success");
            } else {
                UI.log("Misserfolg. Keine Beute.", "error");
            }
            UI.update();
        }, 2000);
    }
};

const UI = {
    cat: 'burg',
    init: function() { this.renderBuild(); },
    setCat: function(c) { 
        this.cat = c; this.renderBuild(); 
        document.querySelectorAll('.cat-icon').forEach(e => e.classList.remove('selected'));
        event.target.classList.add('selected');
    },
    renderBuild: function() {
        const d = document.getElementById('build-list'); d.innerHTML = "";
        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            if(b.cat !== this.cat) continue;
            let cost = [];
            if(b.cost.g) cost.push(b.cost.g+"üí∞"); if(b.cost.w) cost.push(b.cost.w+"üå≤"); if(b.cost.s) cost.push(b.cost.s+"üß±");
            
            let el = document.createElement('div'); el.className = "build-item";
            el.onclick = () => Game.build(k);
            el.innerHTML = `
                ${State.b[k]>0 ? `<div class="build-count">${State.b[k]}</div>`:''}
                <div class="build-ico">${b.icon}</div>
                <div class="build-name">${b.name}</div>
                <div class="build-cost">${cost.join(' ')}</div>
            `;
            d.appendChild(el);
        }
    },
    renderMap: function() {
        const m = document.getElementById('village-map'); m.innerHTML = "";
        for(let k in State.b) {
            for(let i=0; i<State.b[k]; i++) this.addMapIcon(Config.buildings[k].icon);
        }
    },
    addMapIcon: function(ico) {
        let d = document.createElement('div'); d.className='map-icon'; d.innerText=ico;
        document.getElementById('village-map').appendChild(d);
    },
    log: function(txt, type) {
        let d = document.createElement('div'); d.className=`log-card ${type}`; d.innerText = `T${State.day}: ${txt}`;
        let c = document.getElementById('game-log'); c.prepend(d);
    },
    update: function() {
        const r = State.res;
        ['gold','wood','stone','iron','wheat','flour','hops','bread','meat','apple','cheese','beer','bow','spear','sword','armor'].forEach(k => {
            let e = document.getElementById('r-'+k); if(e) e.innerText = Math.floor(r[k]);
        });
        document.getElementById('r-pop').innerText = State.pop.curr + "/" + State.pop.max;
        document.getElementById('r-hap').innerText = Math.floor(State.pop.hap);
        document.getElementById('r-sold').innerText = State.pop.sold + State.pop.merc;
        document.getElementById('game-day').innerText = State.day;
        document.getElementById('level-title').innerText = "Level " + State.level;
        document.getElementById('tax-disp').innerText = Config.taxes[State.tax];
        document.getElementById('pause-indicator').style.display = State.paused ? 'inline' : 'none';

        // Hover Tooltip Update
        let f = State.factors;
        document.getElementById('hap-tooltip').innerHTML = `
            <div class="tt-row"><span>Essen:</span><span class="tt-val ${f.food>=0?'pos':'neg'}">${f.food}</span></div>
            <div class="tt-row"><span>Steuern:</span><span class="tt-val ${f.tax>=0?'pos':'neg'}">${f.tax}</span></div>
            <div class="tt-row"><span>Boni:</span><span class="tt-val pos">+${f.other}</span></div>
        `;

        // Objective Update (KLARTEXT!)
        let l = Levels.find(x => x.id == State.level);
        if(l) {
            let html = "";
            for(let k in l.goal) {
                let val = 0;
                if(k=='pop') val=State.pop.curr;
                else if(k=='soldiers') val=State.pop.sold + State.pop.merc;
                else val = State.res[k] || State.b[k] || 0;
                
                let label = Labels[k] || k;
                let done = val >= l.goal[k] ? "obj-done" : "";
                html += `<span class="obj-item ${done}">${label}: ${Math.floor(val)}/${l.goal[k]}</span>`;
            }
            document.getElementById('objective-text').innerHTML = html;
        }
        
        this.renderBuild();
    },
    toggleMarket: function(s) { 
        document.getElementById('market-modal').style.display=s?'flex':'none'; 
        if(s){ this.renderList('market-list', Object.keys(State.res).filter(k=>k!='gold'), 'trade'); }
    },
    toggleRecruit: function(s) {
        document.getElementById('recruit-modal').style.display=s?'flex':'none';
        if(s){ 
            let list = document.getElementById('recruit-list'); list.innerHTML = "";
            ['archer','spear','sword'].forEach(u => {
                let unit = Units[u];
                let cost = `${unit.cost}üí∞ + ${Labels[unit.res]}`;
                let d = document.createElement('div'); d.className='trade-row';
                d.innerHTML = `<span>${unit.name} (${unit.str}‚öîÔ∏è)</span><button class="trade-btn" onclick="Game.recruit('${u}')">Ausbilden (${cost})</button>`;
                list.appendChild(d);
            });
        }
    },
    renderList: function(id, items, type) {
        let list = document.getElementById(id); list.innerHTML = "";
        items.forEach(k => {
            let d = document.createElement('div'); d.className='trade-row';
            if(type=='trade') d.innerHTML = `<span>${Labels[k]||k} (${Math.floor(State.res[k])})</span><div><button class="trade-btn" onclick="Game.trade('${k}',1)">Kauf</button><button class="trade-btn" onclick="Game.trade('${k}',0)">Verk</button></div>`;
            list.appendChild(d);
        });
    },
    showMsg: function(t, b, cb) {
        document.getElementById('msg-title').innerText=t; document.getElementById('msg-text').innerText=b;
        document.getElementById('msg-modal').style.display='flex';
        let btn = document.querySelector('#msg-modal button');
        btn.onclick = cb ? () => { cb(); Game.closeMsg(); } : Game.closeMsg;
    },
    updateBar: function() {} // Nicht mehr ben√∂tigt
};

Game.init();
</script>
</body>
</html>
