<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burgherr V14 - Alive Update</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #111; 
            --panel-bg: #e0d5b7;
            --border: #5d4037;
            --highlight: #ffb300;
            --text: #3e2723;
            --success: #2e7d32;
            --danger: #c62828;
            --accent: #d84315;
            --can-build: #e8f5e9; /* Hellgr√ºn f√ºr leistbare Geb√§ude */
            --can-build-border: #2e7d32;
        }

        * { box-sizing: border-box; user-select: none; }
        body { font-family: 'Lato', sans-serif; background: var(--bg-body); color: #ccc; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- TICK BAR --- */
        #tick-container {
            height: 6px; background: #000; width: 100%; position: relative; z-index: 200;
        }
        #tick-bar {
            height: 100%; background: var(--highlight); width: 0%; transition: width 0.1s linear;
            box-shadow: 0 0 10px var(--highlight);
        }

        /* --- HEADER --- */
        header { 
            background: #222; height: 120px; flex-shrink: 0; border-bottom: 3px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 100;
            position: relative;
        }

        .header-info { width: 220px; }
        .game-title { font-family: 'MedievalSharp'; font-size: 1.8rem; color: var(--highlight); margin: 0; line-height: 1; text-shadow: 2px 2px 0 #000; }
        .objective { font-size: 0.75rem; background: rgba(255,255,255,0.1); padding: 5px; border-left: 3px solid var(--highlight); margin-top: 5px; color: #ddd; }
        .obj-done { text-decoration: line-through; color: var(--success); opacity: 0.7; }

        .res-container { display: flex; gap: 8px; flex: 1; justify-content: flex-end; }
        .res-group { 
            background: #333; border: 1px solid #555; border-radius: 4px; padding: 4px 8px; 
            min-width: 70px; text-align: center; display: flex; flex-direction: column; justify-content: center;
            position: relative; cursor: help; transition: background 0.2s;
        }
        .res-group:hover .tooltip { display: block; }
        
        .res-label { font-size: 0.6rem; text-transform: uppercase; color: #aaa; border-bottom: 1px solid #555; margin-bottom: 2px; }
        
        /* Values & Rates */
        .res-values { display: flex; gap: 10px; justify-content: center; font-weight: bold; font-size: 0.9rem; color: #fff; position: relative; }
        .res-item { position: relative; display: inline-block; }
        .rate-ind { font-size: 0.65rem; position: relative; top: -5px; margin-left: 2px; opacity: 0.8; }
        .rate-pos { color: #66bb6a; }
        .rate-neg { color: #ef5350; }

        /* FLOATING TEXT ANIMATION */
        .float-txt {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            font-size: 0.9rem; font-weight: bold; pointer-events: none;
            animation: floatUp 1.5s forwards; text-shadow: 1px 1px 0 #000; z-index: 3000;
        }
        @keyframes floatUp {
            0% { opacity: 1; top: -10px; transform: translateX(-50%) scale(1); }
            100% { opacity: 0; top: -40px; transform: translateX(-50%) scale(1.2); }
        }

        /* TOOLTIP */
        .tooltip { 
            display: none; position: absolute; top: 100%; right: 0; margin-top: 5px; z-index: 2000;
            background: #e0e0e0; color: #000; padding: 10px; border: 2px solid var(--border); border-radius: 4px;
            width: 220px; text-align: left; box-shadow: 0 5px 15px rgba(0,0,0,0.5); pointer-events: none;
        }
        .tt-row { display: flex; justify-content: space-between; font-size: 0.8rem; border-bottom: 1px dashed #ccc; padding: 2px 0; }

        /* IDLE ICON */
        .idle-alert {
            display: none; color: var(--highlight); font-size: 1.2rem; animation: pulse 1s infinite; margin-left: 5px;
        }
        @keyframes pulse { 0% { opacity: 0.5; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.9); } }

        /* --- MAIN --- */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* KARTE */
        #map-area { 
            flex: 1; position: relative; overflow: hidden; padding: 20px;
            background: radial-gradient(#558b2f, #1b5e20); 
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 2px;
        }
        .zone { position: relative; border: 1px dashed rgba(255,255,255,0.1); display: flex; align-content: flex-start; flex-wrap: wrap; padding: 10px; overflow: hidden; transition: background 0.5s; }
        .zone-label { position: absolute; bottom: 5px; right: 5px; font-family: 'MedievalSharp'; font-size: 2rem; color: rgba(255,255,255,0.2); pointer-events: none; }
        
        .map-b { 
            display: inline-flex; width: 40px; height: 40px; font-size: 1.5rem; 
            align-items: center; justify-content: center; background: rgba(255,255,255,0.2); 
            border-radius: 4px; margin: 2px; box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: default;
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* SIDEBAR */
        aside { 
            width: 340px; background: var(--panel-bg); border-left: 5px solid var(--border); 
            display: flex; flex-direction: column; color: var(--text); z-index: 50;
        }
        
        /* LOG: Newest at Top */
        .log-box { 
            flex: 1; overflow-y: hidden; padding: 10px; display: flex; flex-direction: column; gap: 5px; 
            background: rgba(0,0,0,0.05); font-size: 0.85rem; position: relative;
        }
        /* Fade effect at bottom */
        .log-box::after {
            content:''; position: absolute; bottom:0; left:0; width:100%; height: 40px;
            background: linear-gradient(transparent, rgba(0,0,0,0.1)); pointer-events: none;
        }

        .log-entry { 
            background: #fff; padding: 6px 10px; border-radius: 4px; border-left: 4px solid #999; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-shrink: 0; animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        .log-entry:nth-child(1) { font-weight: bold; border-left-width: 6px; } /* Neueste Nachricht */
        .log-entry:nth-child(n+10) { opacity: 0.5; } /* √Ñltere verblassen */

        .log-entry.prod { border-color: var(--success); }
        .log-entry.warn { border-color: var(--danger); background: #ffebee; }
        
        .controls { padding: 10px; background: #bcaaa4; border-top: 2px solid var(--border); }
        .c-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .btn { 
            flex: 1; padding: 8px; border: 1px solid var(--border); background: #efebe9; 
            font-weight: bold; cursor: pointer; border-radius: 4px; color: var(--text); transition: 0.1s;
        }
        .btn:hover { background: #fff; transform: translateY(-1px); }
        .btn:active { transform: translateY(1px); }

        /* --- FOOTER (BUILDING) --- */
        footer { 
            height: 160px; background: #d7ccc8; border-top: 5px solid var(--border); flex-shrink: 0;
            display: flex; padding: 0 10px; align-items: center; 
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            z-index: 60;
        }
        
        .cat-bar { width: 140px; display: flex; flex-wrap: wrap; gap: 5px; border-right: 2px solid #ccc; padding-right: 10px; justify-content: center; }
        .cat-btn { width: 40px; height: 40px; background: var(--border); color: #fff; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .cat-btn:hover { transform: scale(1.1); }
        .cat-btn.active { background: var(--highlight); color: #000; border-color: #fff; transform: scale(1.1); box-shadow: 0 0 10px var(--highlight); }

        .build-bar { flex: 1; display: flex; gap: 10px; overflow-x: auto; padding: 5px; height: 100%; align-items: center; }
        .b-card { 
            min-width: 80px; height: 110px; background: rgba(0,0,0,0.05); border-radius: 6px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; border: 2px solid transparent; transition: 0.2s;
        }
        .b-card:hover { background: rgba(0,0,0,0.1); border-color: #999; }
        
        /* AFFORDABILITY HIGHLIGHT */
        .b-card.can-build { background: var(--can-build); border-color: var(--can-build-border); box-shadow: 0 4px 6px rgba(46, 125, 50, 0.2); }
        .b-card.can-build:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 6px 10px rgba(46, 125, 50, 0.3); }

        .b-count { position: absolute; top: -5px; right: -5px; background: var(--accent); color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; font-weight: bold; box-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        
        /* MODALS */
        .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-win { background: var(--panel-bg); width: 500px; padding: 25px; border: 4px solid var(--border); border-radius: 8px; text-align: center; color: var(--text); box-shadow: 0 0 50px #000; position: relative; }
        
        .list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 400px; overflow-y: auto; text-align: left; margin: 15px 0; }
        .list-item { background: rgba(255,255,255,0.5); padding: 5px; border: 1px solid #999; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; font-size: 0.9rem; }

        .missing-res { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

<div id="modal-mask" class="modal-mask">
    <div class="modal-win">
        <h2 id="m-title" style="font-family:'MedievalSharp'; margin-top:0">Titel</h2>
        <div id="m-body" style="font-size:1.1rem; line-height:1.4">Text</div>
        <button id="m-btn" class="btn" style="margin-top:20px; width:100%; background:var(--highlight);">Aktion</button>
    </div>
</div>

<div id="recruit-mask" class="modal-mask">
    <div class="modal-win">
        <h2 style="font-family:'MedievalSharp'; margin:0">Kaserne</h2>
        <div id="recruit-list" class="list-grid"></div>
        <button onclick="UI.closeRecruit()" class="btn" style="width:100%">Schlie√üen</button>
    </div>
</div>

<div id="market-mask" class="modal-mask">
    <div class="modal-win">
        <h2 style="font-family:'MedievalSharp'; margin:0">Markt</h2>
        <div id="market-list" class="list-grid"></div>
        <button onclick="UI.closeMarket()" class="btn" style="width:100%">Schlie√üen</button>
    </div>
</div>

<div id="tick-container"><div id="tick-bar"></div></div>

<header>
    <div class="header-info">
        <div class="game-title">Burgherr V14</div>
        <div class="objective" id="obj-disp">Lade...</div>
    </div>

    <div class="res-container">
        <div class="res-group" id="rg-gold">
            <span class="res-label">Schatz</span>
            <div class="res-values">üí∞ <span id="r-gold">0</span></div>
        </div>
        
        <div class="res-group" id="rg-store">
            <span class="res-label">Lager</span>
            <div class="res-values">
                <span class="res-item" title="Holz">üå≤<span id="r-wood">0</span><span id="d-wood" class="rate-ind"></span></span>
                <span class="res-item" title="Stein">üß±<span id="r-stone">0</span><span id="d-stone" class="rate-ind"></span></span>
                <span class="res-item" title="Eisen">‚õìÔ∏è<span id="r-iron">0</span><span id="d-iron" class="rate-ind"></span></span>
            </div>
            <div class="tooltip">Limit: <span id="tt-stock">100</span> (Vorratslager bauen)</div>
        </div>

        <div class="res-group" id="rg-food">
            <span class="res-label">Nahrung</span>
            <div class="res-values">
                <span class="res-item" title="Brot">üçû<span id="r-bread">0</span><span id="d-bread" class="rate-ind"></span></span>
                <span class="res-item" title="Fleisch">ü•©<span id="r-meat">0</span><span id="d-meat" class="rate-ind"></span></span>
                <span class="res-item" title="√Ñpfel">üçé<span id="r-apple">0</span><span id="d-apple" class="rate-ind"></span></span>
                <span class="res-item" title="K√§se">üßÄ<span id="r-cheese">0</span><span id="d-cheese" class="rate-ind"></span></span>
            </div>
            <div class="tooltip">Limit: <span id="tt-food">100</span> (Kornspeicher bauen)</div>
        </div>

        <div class="res-group" style="min-width:140px">
            <span class="res-label">Truppen</span>
            <div class="res-values">
                <span title="Bogen">üèπ<span id="r-bow">0</span></span>
                <span title="Pike">üî±<span id="r-spear">0</span></span>
                <span title="Schwert">‚öîÔ∏è<span id="r-sword">0</span></span>
                <span title="S√∂ldner">üó°Ô∏è<span id="r-merc">0</span></span>
            </div>
        </div>

        <div class="res-group">
            <span class="res-label">Bev√∂lkerung</span>
            <div class="res-values">
                <span title="B√ºrger">üë®‚Äçüåæ <span id="r-pop">0</span></span>
                <span title="Beliebtheit">‚ù§Ô∏è <span id="r-hap">0</span></span>
                <span id="idle-icon" class="idle-alert" title="Unt√§tige Arbeiter!">üí§</span>
            </div>
            <div class="tooltip">
                <div class="tt-row"><span>Unt√§tig:</span><span id="tt-idle" style="font-weight:bold">0</span></div>
                <hr>
                <div id="hap-breakdown"></div>
            </div>
        </div>
    </div>
</header>

<main>
    <div id="map-area">
        <div class="zone" id="z-forest"><div class="zone-label">Wald</div></div>
        <div class="zone" id="z-mountain"><div class="zone-label">Berg</div></div>
        <div class="zone" id="z-town"><div class="zone-label">Stadt</div></div>
        <div class="zone" id="z-farm"><div class="zone-label">Feld</div></div>
    </div>

    <aside>
        <div style="padding:10px; text-align:center; font-weight:bold; border-bottom:1px solid #aaa;">
            Tag <span id="day-disp">1</span> - Level <span id="lvl-disp">1</span>
        </div>
        <div class="log-box" id="log"></div>
        <div class="controls">
            <div class="c-row">
                <button class="btn" onclick="UI.openRecruit()">üõ°Ô∏è Armee</button>
                <button class="btn" onclick="UI.openMarket()">‚öñÔ∏è Markt</button>
            </div>
            <div style="background:rgba(255,255,255,0.5); padding:5px; border-radius:4px; font-size:0.8rem; margin:5px 0;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>Steuern: <strong id="tax-name">Keine</strong></span>
                    <span>
                        <button onclick="Game.tax(-1)" style="cursor:pointer">‚ûñ</button> 
                        <button onclick="Game.tax(1)" style="cursor:pointer">‚ûï</button>
                    </span>
                </div>
                <div id="tax-impact" style="font-size:0.7rem; color:#555; margin-top:3px; text-align:center;">
                    0üí∞ / -1‚ù§Ô∏è
                </div>
            </div>
            <div style="border-top:1px dashed #777; margin-top:5px; padding-top:5px; font-size:0.75rem;">
                System: 
                <button onclick="Game.togglePause()">Pause</button>
                <button onclick="Game.save()">Save</button>
                <button onclick="Game.reset()" style="color:red">Reset</button>
            </div>
        </div>
    </aside>
</main>

<footer>
    <div class="cat-bar">
        <div class="cat-btn active" onclick="UI.setCat('burg')">üè∞</div>
        <div class="cat-btn" onclick="UI.setCat('werk')">üî®</div>
        <div class="cat-btn" onclick="UI.setCat('farm')">üçé</div>
        <div class="cat-btn" onclick="UI.setCat('stadt')">üè†</div>
        <div class="cat-btn" onclick="UI.setCat('waffen')">‚öîÔ∏è</div>
        <div class="cat-btn" onclick="UI.setCat('nahrung')">üçû</div>
    </div>
    <div class="build-bar" id="build-list"></div>
</footer>

<script>
/* DATEN */
const T = {
    wood:"Holz", stone:"Stein", iron:"Eisen", pitch:"Pech", wheat:"Weizen", flour:"Mehl", hops:"Hopfen",
    bread:"Brot", meat:"Fleisch", cheese:"K√§se", apple:"√Ñpfel", beer:"Bier",
    bow:"Bogen", spear:"Speer", sword:"Schwert", armor:"R√ºstung", leather:"Leder",
    gold:"Gold", pop:"B√ºrger", archer:"Sch√ºtze", pikeman:"Pikenier", swordsman:"Schwertk√§mpfer", merc:"S√∂ldner",
    cath:"Kathedrale"
};
const SafeT = (k) => T[k] || k; // Fallback

const Levels = [
    {id:1, t:"Gr√ºndung", msg:"Baut H√ºtten (Stadt) und Holzf√§ller (Wald). Achte auf deine Nahrung!", goal:{wood:50, pop:10}, start:{gold:100, wood:20, food:20}},
    {id:2, t:"Stein & Brot", msg:"Baut Steinbr√ºche (Berge, brauchen Ochsen!) & Brotproduktion.", goal:{stone:20, bread:30}, start:{gold:150, wood:50, food:30}},
    {id:3, t:"Waffen", msg:"Stellt B√∂gen und Speere her.", goal:{bow:5, spear:5}, start:{gold:200, wood:100, stone:50, food:50}},
    {id:4, t:"Armee", msg:"Bildet 10 Soldaten aus.", goal:{soldier:10}, start:{gold:300, wood:100, stone:100, iron:20, food:100}},
    {id:5, t:"Kathedrale", msg:"Das Meisterwerk.", goal:{cath:1}, start:{gold:1000, wood:500, stone:500, iron:100, food:200}}
];

const Units = {
    archer: {n:"Sch√ºtze", cost:10, res:"bow", str:5},
    pikeman: {n:"Pikenier", cost:15, res:"spear", str:8},
    swordsman: {n:"Schwertk.", cost:30, res:"sword", arm:"armor", str:15},
    merc: {n:"S√∂ldner", cost:50, str:10}
};

const Config = {
    tick: 5000,
    taxes: [{n:"Keine",g:0,h:1}, {n:"Niedrig",g:2,h:-2}, {n:"Mittel",g:4,h:-5}, {n:"Hoch",g:8,h:-12}, {n:"Grausam",g:15,h:-20}],
    b: {
        // BURG
        wall_w:{n:"Holzwall",c:"burg",i:"ü™µ",z:"z-town",cost:{g:10,w:20}},
        tower:{n:"Turm",c:"burg",i:"üóº",z:"z-mountain",cost:{g:100,s:50}},
        barrack:{n:"Kaserne",c:"burg",i:"‚õ∫",z:"z-town",cost:{g:150,s:20},desc:"Armee"},
        merc:{n:"S√∂ldnerlager",c:"burg",i:"üé™",z:"z-town",cost:{g:500,w:100},desc:"S√∂ldner"},
        
        // WERK
        wood:{n:"Holzf√§ller",c:"werk",i:"ü™ì",z:"z-forest",cost:{g:10},prod:"wood",amt:3},
        stock:{n:"Vorratslager",c:"werk",i:"üì¶",z:"z-town",cost:{w:20},desc:"Lager"},
        ox:{n:"Ochsenjoch",c:"werk",i:"üêÇ",z:"z-mountain",cost:{g:20,w:20}},
        quarry:{n:"Steinbruch",c:"werk",i:"‚õèÔ∏è",z:"z-mountain",cost:{g:50,w:50},prod:"stone",amt:2,need:"ox"},
        iron:{n:"Eisenmine",c:"werk",i:"‚õìÔ∏è",z:"z-mountain",cost:{g:100,w:100},prod:"iron",amt:1},
        
        // FARM
        apple:{n:"Obstgarten",c:"farm",i:"üçé",z:"z-farm",cost:{g:30,w:10},prod:"apple",amt:3},
        hunter:{n:"J√§ger",c:"farm",i:"üèπ",z:"z-forest",cost:{g:20,w:5},prod:"meat",amt:2},
        dairy:{n:"K√§serei",c:"farm",i:"üßÄ",z:"z-farm",cost:{g:40,w:20},prod:"cheese",amt:2},
        wheat:{n:"Getreide",c:"farm",i:"üåæ",z:"z-farm",cost:{g:40,w:10},prod:"wheat",amt:2},
        hops:{n:"Hopfen",c:"farm",i:"üåø",z:"z-farm",cost:{g:40,w:10},prod:"hops",amt:2},
        
        // STADT
        hovel:{n:"H√ºtte",c:"stadt",i:"üõñ",z:"z-town",cost:{w:10},pop:5},
        house:{n:"Haus",c:"stadt",i:"üè†",z:"z-town",cost:{g:50,w:30,s:10},pop:10},
        church:{n:"Kirche",c:"stadt",i:"‚õ™",z:"z-town",cost:{g:500,s:100},rel:10},
        cath:{n:"KATHEDRALE",c:"stadt",i:"üïç",z:"z-town",cost:{g:5000,s:2000},rel:50},
        
        // WAFFEN
        fletch:{n:"Pfeilmacher",c:"waffen",i:"üèπ",z:"z-town",cost:{g:100,w:50},use:"wood",out:"bow",amt:1},
        pole:{n:"Pikenmacher",c:"waffen",i:"üî±",z:"z-town",cost:{g:100,w:50},use:"wood",out:"spear",amt:1},
        smith:{n:"Schmiede",c:"waffen",i:"‚öîÔ∏è",z:"z-town",cost:{g:200,w:100},use:"iron",out:"sword",amt:1},
        armor:{n:"R√ºstung",c:"waffen",i:"üõ°Ô∏è",z:"z-town",cost:{g:200,w:100},use:"iron",out:"armor",amt:1},
        
        // NAHRUNG
        gran:{n:"Kornspeicher",c:"nahrung",i:"üõñ",z:"z-town",cost:{w:20},cap:50},
        mill:{n:"M√ºhle",c:"nahrung",i:"‚öôÔ∏è",z:"z-town",cost:{g:100,w:50},proc:"wheat",out:"flour",r:1},
        bake:{n:"B√§cker",c:"nahrung",i:"üçû",z:"z-town",cost:{g:50,w:20},proc:"flour",out:"bread",r:4},
        brew:{n:"Brauerei",c:"nahrung",i:"üç∫",z:"z-town",cost:{g:100,w:20},proc:"hops",out:"beer",r:2}
    }
};

/* LOGIC */
let S = {}; // State
let lastTickTime = 0;

const Game = {
    init: function() {
        if(localStorage.getItem('sh_v14')) {
            try {
                S = JSON.parse(localStorage.getItem('sh_v14'));
                if(!S.b.gran && S.b.granary) { S.b.gran = S.b.granary; delete S.b.granary; }
                UI.init();
                UI.showModal("Willkommen zur√ºck", "Dein Lehen erwartet dich.", "Weiter");
            } catch(e) { this.reset(); }
        } else {
            this.startLevel(1);
        }
        
        // Tick Loop
        setInterval(this.tick, Config.tick);
        
        // Visual Loop (Progress Bar)
        lastTickTime = Date.now();
        requestAnimationFrame(UI.animateTick);
    },

    startLevel: function(id) {
        let l = Levels.find(x => x.id == id);
        if(!l) return UI.showModal("Spielende", "Du bist der wahre Burgherr!", "Hurra");
        
        S = {
            lvl: id, day: 1, paused: true,
            res: { gold:0, wood:0, stone:0, iron:0, pitch:0, wheat:0, flour:0, bread:0, meat:0, cheese:0, apple:0, hops:0, beer:0, bow:0, spear:0, sword:0, armor:0, leather:0 },
            units: { archer:0, pikeman:0, swordsman:0, merc:0 },
            pop: { curr:5, max:0, hap:100 },
            b: {}, w: {}, tax: 0,
            factors: { food:0, tax:0 },
            rates: {} // For tracking +5/-3 etc.
        };
        // Load Start Res
        for(let k in l.start) S.res[k] = l.start[k];
        for(let k in Config.b) { S.b[k]=0; S.w[k]=0; }
        
        S.b.stock = 1; S.b.gran = 1;

        UI.init();
        UI.showModal("Level " + id + ": " + l.t, l.msg, "Starten");
    },

    tick: function() {
        if(S.paused) { lastTickTime = Date.now(); return; }
        S.day++;
        lastTickTime = Date.now();
        
        // SNAPSHOT for Rate Calculation
        let startRes = JSON.parse(JSON.stringify(S.res));
        let pLog = []; // Prod Log
        
        // 1. LIMITS
        let maxS = (S.b.stock || 1) * 50;
        let maxF = (S.b.gran || 1) * 50; 
        
        let curS = S.res.wood + S.res.stone + S.res.iron + S.res.wheat + S.res.flour;
        let curF = S.res.bread + S.res.meat + S.res.apple + S.res.cheese;
        let fullS = curS >= maxS;
        let fullF = curF >= maxF;

        // 2. PRODUCTION
        for(let k in Config.b) {
            let b = Config.b[k];
            let n = S.w[k];
            if(n <= 0) continue;

            if(b.need && S.b[b.need] < n) n = S.b[b.need]; 

            // Simple Prod
            if(b.prod) {
                let isFood = ['meat','apple','cheese','wheat','hops'].includes(b.prod);
                if((isFood && !fullF) || (!isFood && !fullS)) {
                    let amt = n * (b.amt||1);
                    S.res[b.prod] = (S.res[b.prod]||0) + amt;
                }
            }
            // Process
            if(b.proc) {
                let take = Math.min(S.res[b.proc]||0, n);
                if(take > 0 && !fullF) {
                    S.res[b.proc] -= take;
                    let out = take * (b.r||1);
                    S.res[b.out] = (S.res[b.out]||0) + out;
                }
            }
            // Craft
            if(b.use) {
                if((S.res[b.use]||0) >= n && !fullS) {
                    S.res[b.use] -= n;
                    S.res[b.out] = (S.res[b.out]||0) + (n*(b.amt||1));
                }
            }
        }

        // 3. EAT
        let eat = S.pop.curr;
        let foods = ['bread','meat','cheese','apple'];
        let ateTypes = 0;
        foods.forEach(f => {
            if(eat > 0 && S.res[f] > 0) {
                let take = Math.min(eat, S.res[f]);
                S.res[f] -= take; eat -= take; ateTypes++;
            }
        });

        let hChg = 0;
        if(eat > 0) { UI.log(`${eat} hungern!`, 'warn'); hChg -= 20; S.factors.food = -20; }
        else { hChg += (ateTypes); S.factors.food = ateTypes; }

        // Tax
        let tx = Config.taxes[S.tax];
        hChg += tx.h;
        S.res.gold += (S.pop.curr * tx.g);
        S.factors.tax = tx.h;

        // Beer
        if(S.res.beer >= S.pop.curr && S.pop.curr > 0) {
            S.res.beer -= S.pop.curr;
            hChg += 5;
        }

        // Church
        hChg += ((S.b.church||0) * 5);

        S.pop.hap = Math.max(0, Math.min(100, S.pop.hap + hChg));

        // 4. POPULATION & EVENTS
        S.pop.max = (S.b.hovel*5) + (S.b.house*10) + 5;
        let work = 0; for(let k in S.w) work += S.w[k];
        let sold = 0; for(let k in S.units) sold += S.units[k];
        let idle = S.pop.curr - sold - work;

        if(S.pop.hap > 60 && S.pop.curr < S.pop.max && Math.random()>0.5) {
            S.pop.curr++; Game.autoAssign();
        } else if(S.pop.hap < 20 && S.pop.curr > 0) {
            S.pop.curr--; UI.log("B√ºrger geflohen", "warn");
            for(let k in S.w) if(S.w[k]>0){S.w[k]--; break;}
        }

        // 5. CALC RATES & LOG
        S.rates = {};
        for(let k in S.res) {
            let diff = S.res[k] - startRes[k];
            if(diff !== 0) {
                S.rates[k] = diff;
                if(diff > 0) UI.showFloatingText(k, `+${diff}`, 'pos');
                // Keine Floating Text f√ºr Verbrauch, das nervt sonst bei Nahrung
            }
        }
        
        // Log Logic (Simplified)
        let prodArr = [];
        for(let k in S.rates) {
            if(S.rates[k] > 0 && k !== 'gold') prodArr.push(`${S.rates[k]} ${SafeT(k)}`);
        }
        if(prodArr.length) UI.log("Produktion: " + prodArr.join(", "), 'prod');

        // 6. WIN CHECK
        let l = Levels.find(x => x.id == S.lvl);
        let win = true;
        for(let k in l.goal) {
            let val = 0;
            if(k=='pop') val=S.pop.curr;
            else if(k=='soldier') val=sold;
            else val = S.res[k] || S.b[k] || 0;
            if(val < l.goal[k]) win = false;
        }
        if(win) {
            S.paused = true;
            UI.showModal("SIEG!", "Level geschafft!", "N√§chstes Level", () => Game.startLevel(S.lvl+1));
        }

        UI.update();
    },

    autoAssign: function() {
        let work = 0; for(let k in S.w) work += S.w[k];
        let sold = 0; for(let k in S.units) sold += S.units[k];
        let idle = S.pop.curr - sold - work;
        if(idle <= 0) return;

        for(let k in Config.b) {
            let b = Config.b[k];
            if((b.prod || b.proc || b.use) && S.b[k] > S.w[k]) {
                S.w[k]++; idle--;
                if(idle<=0) break;
            }
        }
    },

    build: function(key) {
        let b = Config.b[key];
        if(S.res.gold >= (b.cost.g||0) && S.res.wood >= (b.cost.w||0) && S.res.stone >= (b.cost.s||0)) {
            S.res.gold -= (b.cost.g||0); S.res.wood -= (b.cost.w||0); S.res.stone -= (b.cost.s||0);
            S.b[key]++;
            Game.autoAssign();
            UI.addMapIcon(key);
            UI.update();
        }
    },

    recruit: function(key) {
        let work = 0; for(let k in S.w) work += S.w[k];
        let sold = 0; for(let k in S.units) sold += S.units[k];
        let idle = S.pop.curr - sold - work;
        let u = Units[key];

        if(key === 'merc') {
            if(S.b.merc < 1) return;
            if(S.res.gold >= 50) { S.res.gold-=50; S.units.merc++; UI.log("S√∂ldner angeheuert", "prod"); }
        } else {
            if(S.b.barrack < 1) return;
            if(idle < 1) return;
            if(S.res.gold >= u.cost && S.res[u.res] >= 1) {
                if(u.arm && S.res[u.arm] < 1) return;
                S.res.gold -= u.cost;
                S.res[u.res]--;
                if(u.arm) S.res[u.arm]--;
                S.units[key]++;
                UI.log(u.n + " ausgebildet", "prod");
            }
        }
        UI.update();
    },

    tax: function(d) {
        let n = S.tax + d;
        if(n >= 0 && n < 5) S.tax = n;
        UI.update();
    },

    trade: function(k, buy) {
        if(buy && S.res.gold >= 5) { S.res.gold-=5; S.res[k]+=5; }
        if(!buy && S.res[k] >= 5) { S.res[k]-=5; S.res.gold+=3; }
        UI.update(); UI.renderMarket();
    },

    togglePause: function() { 
        S.paused = !S.paused; 
        if(!S.paused) lastTickTime = Date.now();
    },
    save: function() { localStorage.setItem('sh_v14', JSON.stringify(S)); UI.log("Gespeichert", "prod"); },
    reset: function() { localStorage.removeItem('sh_v14'); location.reload(); }
};

const UI = {
    cat: 'burg',
    init: function() {
        this.renderMap();
        this.renderBuild();
        this.update();
    },
    
    animateTick: function() {
        if(!S.paused) {
            let now = Date.now();
            let diff = now - lastTickTime;
            let pct = Math.min(100, (diff / Config.tick) * 100);
            document.getElementById('tick-bar').style.width = pct + "%";
        }
        requestAnimationFrame(UI.animateTick);
    },
    
    update: function() {
        // Resources (Resourcen UND Units)
        ['gold','wood','stone','iron','bread','meat','apple','cheese','wheat','flour','hops','bow','spear','sword','merc'].forEach(k => {
            let el = document.getElementById('r-'+k);
            let val = S.res[k] !== undefined ? S.res[k] : (S.units[k] !== undefined ? S.units[k] : 0);
            if(el) el.innerText = Math.floor(val); 
            
            // Rates (+/- Display)
            let dEl = document.getElementById('d-'+k);
            if(dEl) {
                let r = S.rates[k] || 0;
                dEl.innerText = r > 0 ? `+${r}` : (r < 0 ? r : "");
                dEl.className = "rate-ind " + (r >= 0 ? "rate-pos" : "rate-neg");
            }
        });

        // Pop & Info
        let work = 0; for(let k in S.w) work += S.w[k];
        let sold = 0; for(let k in S.units) sold += S.units[k];
        let idle = S.pop.curr - sold - work;

        document.getElementById('r-pop').innerText = S.pop.curr + "/" + S.pop.max;
        document.getElementById('tt-idle').innerText = idle;
        document.getElementById('r-hap').innerText = Math.floor(S.pop.hap);
        document.getElementById('day-disp').innerText = S.day;
        document.getElementById('lvl-disp').innerText = S.lvl;
        
        // Idle Warning
        document.getElementById('idle-icon').style.display = idle > 0 ? 'inline' : 'none';

        // Tax Info
        let tIdx = Config.taxes[S.tax];
        document.getElementById('tax-name').innerText = tIdx.n;
        document.getElementById('tax-impact').innerText = `+${S.pop.curr * tIdx.g}üí∞ / ${tIdx.h}‚ù§Ô∏è`;
        if(tIdx.h < 0) document.getElementById('tax-impact').style.color = 'var(--danger)';
        else document.getElementById('tax-impact').style.color = 'var(--success)';

        // Tooltips Breakdown
        document.getElementById('hap-breakdown').innerHTML = `
            <div class="tt-row"><span>Essen:</span><span>${S.factors.food > 0 ? '+'+S.factors.food : S.factors.food}</span></div>
            <div class="tt-row"><span>Steuer:</span><span>${S.factors.tax}</span></div>
            <div class="tt-row"><span>Kirche:</span><span>+${(S.b.church||0)*5}</span></div>
        `;
        
        let maxS = (S.b.stock||1)*50;
        let curS = S.res.wood+S.res.stone+S.res.iron+S.res.wheat+S.res.flour;
        document.getElementById('tt-stock').innerText = `${Math.floor(curS)}/${maxS}`;
        
        let maxF = (S.b.gran||1)*50;
        let curF = S.res.bread+S.res.meat+S.res.apple+S.res.cheese;
        document.getElementById('tt-food').innerText = `${Math.floor(curF)}/${maxF}`;

        // Objective
        let l = Levels.find(x => x.id == S.lvl);
        if(l) {
            let h = "";
            for(let k in l.goal) {
                let v = 0;
                if(k=='pop') v = S.pop.curr;
                else if(k=='soldier') v = sold;
                else v = S.res[k] || S.b[k] || 0;
                let c = v >= l.goal[k] ? 'obj-done' : '';
                h += `<span class="${c}">${SafeT(k)}: ${Math.floor(v)}/${l.goal[k]}</span> `;
            }
            document.getElementById('obj-disp').innerHTML = h;
        }

        this.updateBuildState();
    },

    updateBuildState: function() {
        // Pr√ºft, ob Geb√§ude kaufbar sind und f√§rbt sie gr√ºn
        document.querySelectorAll('.b-card').forEach(card => {
            let key = card.getAttribute('data-key');
            if(!key) return;
            let b = Config.b[key];
            let can = S.res.gold >= (b.cost.g||0) && S.res.wood >= (b.cost.w||0) && S.res.stone >= (b.cost.s||0);
            
            if(can) card.classList.add('can-build');
            else card.classList.remove('can-build');
            
            // Tooltip update mit fehlenden Res
            let txt = [];
            if(b.cost.g) txt.push(`<span class="${S.res.gold<b.cost.g?'missing-res':''}">${b.cost.g}üí∞</span>`);
            if(b.cost.w) txt.push(`<span class="${S.res.wood<b.cost.w?'missing-res':''}">${b.cost.w}üå≤</span>`);
            if(b.cost.s) txt.push(`<span class="${S.res.stone<b.cost.s?'missing-res':''}">${b.cost.s}üß±</span>`);
            
            card.querySelector('.cost-disp').innerHTML = txt.join(' ');
        });
    },

    showFloatingText: function(key, text, type) {
        // Find position based on resource group ID in header
        // Simple mapping based on known structure
        let targetId = "";
        if(['wood','stone','iron'].includes(key)) targetId = 'rg-store';
        else if(['bread','meat','apple','cheese'].includes(key)) targetId = 'rg-food';
        else if(key === 'gold') targetId = 'rg-gold';
        else return; // Andere nicht anzeigen
        
        let target = document.getElementById(targetId);
        if(!target) return;
        
        let el = document.createElement('div');
        el.className = 'float-txt';
        el.style.color = type === 'pos' ? '#4caf50' : '#f44336';
        el.innerText = text;
        target.appendChild(el);
        
        setTimeout(() => el.remove(), 1500);
    },

    log: function(t, c) {
        let d = document.createElement('div');
        d.className = `log-entry ${c}`;
        d.innerText = `Tag ${S.day}: ${t}`;
        let log = document.getElementById('log');
        // REVERSED ORDER: Newest first
        log.prepend(d);
        if(log.childNodes.length > 20) log.removeChild(log.lastChild);
    },

    setCat: function(c) {
        this.cat = c; 
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if(event && event.currentTarget) event.currentTarget.classList.add('active');
        this.renderBuild();
        this.updateBuildState();
    },

    renderBuild: function() {
        const d = document.getElementById('build-list'); d.innerHTML = "";
        for(let k in Config.b) {
            let b = Config.b[k];
            if(b.c !== this.cat) continue;
            
            let el = document.createElement('div'); el.className = "b-card";
            el.setAttribute('data-key', k);
            el.onclick = () => Game.build(k);
            
            el.innerHTML = `
                ${S.b[k]>0 ? `<div class="b-count">${S.b[k]}</div>`:''}
                <div style="font-size:2rem">${b.i}</div>
                <div style="font-size:0.7rem;font-weight:bold">${b.n}</div>
                <div class="cost-disp" style="font-size:0.6rem;color:#666"></div>
            `;
            d.appendChild(el);
        }
    },

    renderMap: function() {
        // Reset Map
        ['forest','mountain','town','farm'].forEach(z => {
            let el = document.getElementById('z-'+z);
            while(el.childNodes.length > 1) el.removeChild(el.lastChild);
        });
        for(let k in S.b) {
            for(let i=0; i<S.b[k]; i++) this.addMapIcon(k);
        }
    },

    addMapIcon: function(k) {
        let b = Config.b[k];
        let zone = document.getElementById(b.z);
        if(zone) {
            let d = document.createElement('div'); d.className='map-b'; d.innerText = b.i;
            d.title = b.n;
            zone.appendChild(d);
        }
    },

    showModal: function(t, b, btnTxt, cb) {
        document.getElementById('m-title').innerText = t;
        document.getElementById('m-body').innerText = b;
        let btn = document.getElementById('m-btn');
        btn.innerText = btnTxt || "OK";
        
        let newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.onclick = function() {
            document.getElementById('modal-mask').style.display = 'none';
            S.paused = false;
            lastTickTime = Date.now(); // Reset Tick timer
            if(cb) cb();
        };
        
        document.getElementById('modal-mask').style.display = 'flex';
    },

    openRecruit: function() {
        document.getElementById('recruit-mask').style.display='flex';
        let l = document.getElementById('recruit-list'); l.innerHTML="";
        for(let k in Units) {
            let u = Units[k];
            let row = document.createElement('div'); row.className='list-item';
            let cost = `${u.cost}üí∞` + (u.res ? ` +1 ${SafeT(u.res)}` : "");
            row.innerHTML = `<span>${u.n} (${u.str}‚öîÔ∏è)</span><button class="btn" style="padding:2px 8px" onclick="Game.recruit('${k}')">Ausbilden (${cost})</button>`;
            l.appendChild(row);
        }
    },
    closeRecruit: function() { document.getElementById('recruit-mask').style.display='none'; },

    openMarket: function() {
        document.getElementById('market-mask').style.display='flex';
        this.renderMarket();
    },
    closeMarket: function() { document.getElementById('market-mask').style.display='none'; },
    renderMarket: function() {
        let l = document.getElementById('market-list'); l.innerHTML="";
        ['wood','stone','iron','wheat','flour','bread','meat','cheese','apple','bow','spear','sword'].forEach(k => {
            let row = document.createElement('div'); row.className='list-item';
            row.innerHTML = `<span>${SafeT(k)}: ${Math.floor(S.res[k]||0)}</span><div><button onclick="Game.trade('${k}',1)">Kauf</button> <button onclick="Game.trade('${k}',0)">Verk</button></div>`;
            l.appendChild(row);
        });
    }
};

Game.init();
</script>
</body>
</html>
