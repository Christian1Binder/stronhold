<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burgherr WebApp - V4.0 Stronghold Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #3e3e3e; --bg-panel: #e0d5b7; 
            --primary: #5d4037; --secondary: #2c2c2c; 
            --accent: #8b0000; --highlight: #ffb300;
            --text-main: #222;
        }

        * { box-sizing: border-box; user-select: none; }
        body { font-family: 'Lato', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        
        #app { 
            background: url('https://www.transparenttextures.com/patterns/aged-paper.png'), var(--bg-panel);
            width: 100%; max-width: 1600px; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        /* --- HEADER (Ressourcen) --- */
        header { 
            background: #2a2a2a; color: #eee; padding: 5px 15px; height: 100px; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 3px solid #5d4037; flex-shrink: 0;
        }
        .header-left h1 { font-family: 'MedievalSharp'; color: var(--highlight); margin: 0; font-size: 1.5rem; text-shadow: 2px 2px 0 #000; }
        .limit-display { font-size: 0.75rem; color: #aaa; margin-top: 2px; }
        .limit-alert { color: #ff5252; font-weight: bold; animation: blink 1s infinite; }

        .res-container { display: flex; gap: 10px; flex: 1; justify-content: flex-end; }
        .res-group { background: rgba(0,0,0,0.4); border: 1px solid #555; border-radius: 4px; padding: 2px 8px; min-width: 80px; text-align: center; }
        .res-val { font-weight: 900; font-size: 0.9rem; color: #fff; display: block; }
        .res-icon { font-size: 1rem; }

        /* --- MAIN AREA --- */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* LOG (Mitte) */
        #center-log { 
            flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
            background-image: radial-gradient(#d7ccc8 10%, transparent 10%); background-size: 20px 20px;
            padding-bottom: 160px; /* Platz f√ºr Footer */
        }

        /* RECHTS (Verwaltung) */
        aside.right { 
            width: 320px; background: #d7ccc8; border-left: 2px solid #5d4037; 
            padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
            padding-bottom: 160px; /* Platz f√ºr Footer */
        }

        /* --- FOOTER (BAUMEN√ú) --- */
        footer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 150px;
            background: url('https://www.transparenttextures.com/patterns/wood-pattern.png'), #3e2723;
            border-top: 4px solid #8d6e63; display: flex; align-items: center; padding: 0 20px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5); z-index: 100;
        }

        /* Kategorien (Links) */
        .cat-menu { display: flex; gap: 10px; border-right: 2px solid #8d6e63; padding-right: 20px; margin-right: 20px; }
        .cat-btn {
            width: 60px; height: 60px; background: #5d4037; border: 2px solid #a1887f; border-radius: 8px;
            cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 2rem;
            transition: all 0.1s; position: relative;
        }
        .cat-btn:hover { background: #6d4c41; transform: scale(1.05); }
        .cat-btn.active { background: #ffb300; border-color: #fff; color: #3e2723; box-shadow: 0 0 10px #ffb300; }
        .cat-tooltip { position: absolute; bottom: 70px; background: #000; color: #fff; padding: 4px; font-size: 0.7rem; border-radius: 4px; opacity: 0; pointer-events: none; transition: opacity 0.2s; white-space: nowrap;}
        .cat-btn:hover .cat-tooltip { opacity: 1; }

        /* Geb√§ude (Rechts) */
        .build-menu { display: flex; gap: 10px; overflow-x: auto; flex: 1; align-items: center; padding-bottom: 10px;}
        .building-icon {
            width: 70px; height: 90px; background: #e0d5b7; border: 2px solid #5d4037; border-radius: 4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; text-align: center; padding: 2px; position: relative; transition: transform 0.1s;
        }
        .building-icon:hover { transform: translateY(-5px); background: #fff; }
        .b-img { font-size: 1.8rem; margin-bottom: 2px; }
        .b-name { font-size: 0.65rem; font-weight: bold; line-height: 1; margin-bottom: 2px; }
        .b-cost { font-size: 0.6rem; color: #555; }
        .b-count { position: absolute; top: -5px; right: -5px; background: #d32f2f; color: white; font-size: 0.7rem; font-weight: bold; padding: 2px 5px; border-radius: 10px; }

        /* --- LOG CARDS --- */
        .log-card { background: #fff; border-radius: 4px; border-left: 4px solid #999; margin-bottom: 5px; padding: 5px; font-size: 0.85rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-shrink: 0;}
        .log-header { font-weight: bold; font-size: 0.75rem; color: #555; display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed #ccc; padding-bottom: 2px;}
        .log-card.error { border-left-color: #d32f2f; background: #ffebee; }
        .log-card.info { border-left-color: #ffb300; background: #fff8e1; }
        .log-card.report { border-left-color: #558b2f; background: #f1f8e9; }
        
        /* --- UI ELEMENTS --- */
        .stat-btn { width: 100%; padding: 8px; background: #5d4037; color: #fff; border: 1px solid #3e2723; cursor: pointer; margin-bottom: 5px; border-radius: 4px; }
        .stat-btn:hover { background: #4e342e; }
        
        .market-overlay { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index: 200; justify-content:center; align-items:center;}
        .market-box { background: #e0d5b7; padding: 20px; border: 4px solid #5d4037; width: 600px; max-height:80vh; overflow-y:auto; border-radius: 8px; }
        .trade-row { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #ccc; align-items: center; }

        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

<div id="market-modal" class="market-overlay">
    <div class="market-box">
        <h2 style="margin-top:0; border-bottom: 2px solid #5d4037;">Der Marktplatz</h2>
        <div id="market-list"></div>
        <button class="stat-btn" onclick="UI.toggleMarket(false)" style="margin-top:20px;">Schlie√üen</button>
    </div>
</div>

<div id="app">
    <header>
        <div class="header-left">
            <h1>üè∞ StrongWeb</h1>
            <div class="limit-display">
                <span id="limit-stock">Lager: 0/100</span> | <span id="limit-food">Korn: 0/100</span>
            </div>
        </div>
        <div class="res-container">
            <div class="res-group" title="Gold">
                <span class="res-icon">üí∞</span> <span class="res-val" id="res-gold">0</span>
            </div>
            <div class="res-group" title="Bev√∂lkerung (Aktuell / Max / Unt√§tig)">
                <span class="res-icon">üë®‚Äçüåæ</span> <span class="res-val" id="res-pop">0/0 (0)</span>
            </div>
            <div class="res-group" title="Beliebtheit">
                <span class="res-icon">‚ù§Ô∏è</span> <span class="res-val" id="res-hap">100</span>
            </div>
            <div class="res-group" title="Milit√§r (S√∂ldner / Soldaten)">
                <span class="res-icon">‚öîÔ∏è</span> <span class="res-val" id="res-mil">0 / 0</span>
            </div>
        </div>
    </header>

    <main>
        <section id="center-log"></section>

        <aside class="right">
            <h3>Verwaltung</h3>
            <button class="stat-btn" onclick="UI.toggleMarket(true)">‚öñÔ∏è Marktplatz</button>
            <div style="font-size:0.8rem; margin:10px 0; background: #fff; padding:5px; border-radius:4px;">
                <strong>Steuern:</strong> <span id="tax-name">Keine</span><br>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button onclick="Game.setTax(-1)" style="flex:1">-</button>
                    <button onclick="Game.setTax(1)" style="flex:1">+</button>
                </div>
            </div>
            
            <h3>Milit√§r</h3>
            <div id="mil-controls">
                <button class="stat-btn" onclick="Game.recruit('regular')">üõ°Ô∏è Soldat (10üí∞, 1‚öîÔ∏è)</button>
                <button class="stat-btn" onclick="Game.recruit('mercenary')">üó°Ô∏è S√∂ldner (50üí∞)</button>
                <button class="stat-btn" style="background:#8b0000;" onclick="Game.startRaid()">‚öîÔ∏è Raubzug</button>
            </div>
            
            <div style="margin-top:auto; font-size:0.8rem; color:#555;">Tag: <span id="game-day">1</span></div>
        </aside>
    </main>

    <footer>
        <div class="cat-menu">
            <div class="cat-btn active" onclick="UI.selectCat('burg')" title="Burg"><span class="cat-tooltip">Burg</span>üè∞</div>
            <div class="cat-btn" onclick="UI.selectCat('industrie')" title="Industrie"><span class="cat-tooltip">Industrie</span>üî®</div>
            <div class="cat-btn" onclick="UI.selectCat('farm')" title="Farmen"><span class="cat-tooltip">Farmen</span>üçé</div>
            <div class="cat-btn" onclick="UI.selectCat('stadt')" title="Stadt"><span class="cat-tooltip">Stadt</span>üè†</div>
            <div class="cat-btn" onclick="UI.selectCat('waffen')" title="Waffen"><span class="cat-tooltip">Waffen</span>‚öîÔ∏è</div>
            <div class="cat-btn" onclick="UI.selectCat('nahrung')" title="Verarbeitung"><span class="cat-tooltip">Nahrung</span>üçû</div>
        </div>
        <div class="build-menu" id="build-menu-content">
            </div>
    </footer>
</div>

<script>
/* --- KONFIGURATION --- */
const Config = {
    tickRate: 5000,
    taxes: [
        {name:"Bestechung", g:-2, h:5}, {name:"Keine", g:0, h:1}, {name:"Niedrig", g:2, h:-2},
        {name:"Normal", g:4, h:-6}, {name:"Hoch", g:8, h:-12}, {name:"Grausam", g:12, h:-20}
    ],
    // Kategorien: burg, industrie, farm, stadt, waffen, nahrung
    buildings: {
        // BURG
        wall_wood:  { name: "Holzwall", cat: "burg", icon: "ü™µ", costG: 10, costW: 20, def: 10 },
        wall_stone: { name: "Steinmauer", cat: "burg", icon: "üß±", costG: 50, costS: 20, def: 50 },
        tower:      { name: "Wachturm", cat: "burg", icon: "üóº", costG: 100, costS: 50, def: 150 },
        gate:       { name: "Torhaus", cat: "burg", icon: "‚õ©Ô∏è", costG: 50, costS: 20, costW: 20, def: 20 },
        barracks:   { name: "Kaserne", cat: "burg", icon: "‚õ∫", costG: 150, costS: 20, costW: 20, desc: "Erm√∂glicht Ausbildung" },
        merc_post:  { name: "S√∂ldnerposten", cat: "burg", icon: "üé™", costG: 500, costW: 100, desc: "S√∂ldner anheuern" },

        // INDUSTRIE
        stockpile:  { name: "Vorratslager", cat: "industrie", icon: "üì¶", costG: 0, costW: 20, capRes: 50, desc: "+50 Lagerplatz" },
        woodcutter: { name: "Holzf√§ller", cat: "industrie", icon: "ü™ì", costG: 10, costW: 0, prod: "wood", amt: 2 },
        ox_tether:  { name: "Ochsenjoch", cat: "industrie", icon: "üêÇ", costG: 20, costW: 20, desc: "N√∂tig f√ºr Steinbruch" },
        quarry:     { name: "Steinbruch", cat: "industrie", icon: "‚õèÔ∏è", costG: 50, costW: 50, prod: "stone", amt: 1, needs: "ox_tether" },
        ironmine:   { name: "Eisenmine", cat: "industrie", icon: "‚õìÔ∏è", costG: 100, costW: 100, prod: "iron", amt: 1 },
        pitch_rig:  { name: "Pechgrube", cat: "industrie", icon: "‚ö´", costG: 150, costW: 50, prod: "pitch", amt: 1, desc: "Pech f√ºr Verteidigung" },

        // FARMEN
        hunter:     { name: "J√§gerstand", cat: "farm", icon: "üèπ", costG: 20, costW: 5, prod: "meat", amt: 2, storage: "food" },
        apple:      { name: "Obstgarten", cat: "farm", icon: "üçé", costG: 30, costW: 10, prod: "apple", amt: 3, storage: "food" },
        dairy:      { name: "K√§serei", cat: "farm", icon: "üßÄ", costG: 40, costW: 20, prod: "cheese", amt: 2, storage: "food", desc: "Liefert Leder f√ºr Gerber" },
        wheat:      { name: "Getreidefarm", cat: "farm", icon: "üåæ", costG: 40, costW: 10, prod: "wheat", amt: 2 },
        hops:       { name: "Hopfenfarm", cat: "farm", icon: "üåø", costG: 40, costW: 10, prod: "hops", amt: 2 },

        // STADT
        hovel:      { name: "H√ºtte", cat: "stadt", icon: "‚õ∫", costG: 0, costW: 10, pop: 5 },
        house:      { name: "Haus", cat: "stadt", icon: "üè†", costG: 50, costW: 30, costS: 10, pop: 10 },
        church:     { name: "Kirche", cat: "stadt", icon: "‚õ™", costG: 500, costS: 100, rel: 10 },
        cathedral:  { name: "Kathedrale", cat: "stadt", icon: "üïç", costG: 5000, costS: 1000, rel: 50, win: true },
        apothecary: { name: "Apotheke", cat: "stadt", icon: "üíä", costG: 200, costW: 50, hap: 5 },
        well:       { name: "Brunnen", cat: "stadt", icon: "üíß", costG: 50, costS: 10, hap: 2 },

        // WAFFEN (Verbrauchen Rohstoffe!)
        fletcher:   { name: "Pfeilmacher", cat: "waffen", icon: "üèπ", costG: 100, costW: 50, prod: "bows", amt: 1, use: "wood", useAmt: 1 },
        blacksmith: { name: "Schmiede", cat: "waffen", icon: "‚öîÔ∏è", costG: 200, costW: 100, prod: "swords", amt: 1, use: "iron", useAmt: 1 },
        armorer:    { name: "R√ºstung", cat: "waffen", icon: "üõ°Ô∏è", costG: 200, costW: 100, prod: "armor", amt: 1, use: "iron", useAmt: 1 },
        tanner:     { name: "Gerber", cat: "waffen", icon: "üß•", costG: 100, costW: 50, prod: "leather", amt: 1, dep: "dairy", ratio: 0.25 }, // 1 Dairy supports 4 Tanners

        // NAHRUNG (Verarbeitung)
        granary:    { name: "Kornspeicher", cat: "nahrung", icon: "üõñ", costG: 0, costW: 20, capFood: 50, desc: "+50 Nahrungslager" },
        mill:       { name: "M√ºhle", cat: "nahrung", icon: "‚öôÔ∏è", costG: 100, costW: 50, proc: "wheat", out: "flour", ratio: 1, cap: 8 },
        bakery:     { name: "B√§ckerei", cat: "nahrung", icon: "üçû", costG: 50, costW: 20, proc: "flour", out: "bread", ratio: 4, cap: 1, storage: "food" },
        brewery:    { name: "Brauerei", cat: "nahrung", icon: "üç∫", costG: 100, costW: 20, proc: "hops", out: "beer", ratio: 2, cap: 2 },
        inn:        { name: "Schenke", cat: "nahrung", icon: "üçª", costG: 200, costW: 100, cons: "beer", hap: 10 }
    }
};

const Labels = {
    wood: "Holz", stone: "Stein", iron: "Eisen", pitch: "Pech", wheat: "Weizen", flour: "Mehl", hops: "Hopfen",
    meat: "Fleisch", apple: "√Ñpfel", cheese: "K√§se", bread: "Brot", beer: "Bier",
    bows: "B√∂gen", swords: "Schwerter", armor: "R√ºstung", leather: "Lederharnisch"
};

let State = {
    day: 1, paused: false,
    res: { gold: 200, wood: 50, stone: 0, iron: 0, pitch: 0, wheat: 0, flour: 0, hops: 0, meat: 5, apple: 5, cheese: 0, bread: 20, beer: 0, bows:0, swords:0, armor:0, leather:0 },
    limits: { stock: 100, food: 100 },
    pop: { curr: 5, max: 8, idle: 0, soldiers: 0, mercs: 0, hap: 100 },
    b: {}, // Buildings count
    w: {}, // Workers count
    tax: 1
};

// Init Buildings
for(let k in Config.buildings) { State.b[k]=0; State.w[k]=0; }
// Ein Start-Lager und Speicher
State.b.stockpile = 1; State.b.granary = 1;

const Game = {
    init: function() {
        UI.renderCats();
        UI.selectCat('industrie');
        UI.update();
        setInterval(this.tick, Config.tickRate);
        setInterval(() => { if(!State.paused) UI.updateLogTime(); }, 500);
        UI.log("Sire, willkommen in Eurer Festung! Baut Holzf√§ller und vergesst das Ochsenjoch f√ºr den Steinbruch nicht.", "info");
    },

    tick: function() {
        if(State.paused) return;
        State.day++;
        
        let logProd = [];
        let logEat = [];
        let warnings = [];

        // 1. LIMITS BERECHNEN
        let maxStock = State.b.stockpile * 50;
        let maxFood = State.b.granary * 50;
        
        let curStock = State.res.wood + State.res.stone + State.res.iron + State.res.pitch + State.res.wheat + State.res.flour + State.res.hops + State.res.leather + State.res.bows + State.res.swords + State.res.armor;
        let curFood = State.res.meat + State.res.apple + State.res.cheese + State.res.bread;

        let stockFull = curStock >= maxStock;
        let foodFull = curFood >= maxFood;

        if(stockFull) warnings.push("Vorratslager voll!");
        if(foodFull) warnings.push("Kornspeicher voll!");

        // 2. PRODUKTION (Basis)
        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            let count = State.w[k];
            if(count <= 0) continue;

            // SPECIAL LOGIC: QUARRY
            if(k === 'quarry') {
                let oxen = State.b.ox_tether;
                let effective = Math.min(count, oxen);
                if(effective < count && Math.random()<0.1) UI.log("Sire, wir brauchen mehr Ochsenjoche!", "error");
                count = effective;
            }

            // SPECIAL LOGIC: TANNER
            if(k === 'tanner') {
                let dairies = State.b.dairy;
                let maxTanners = dairies * 4;
                let effective = Math.min(count, maxTanners);
                if(effective < count && Math.random()<0.1) UI.log("Gerber haben keine K√ºhe (K√§serei)!", "error");
                count = effective;
            }

            // SPECIAL LOGIC: WEAPONS (Resource Cost)
            if(b.use) {
                if(State.res[b.use] >= b.useAmt * count) {
                    State.res[b.use] -= b.useAmt * count;
                } else {
                    count = 0; // Keine Ressource, keine Produktion
                    if(Math.random()<0.1) UI.log(`${b.name} fehlt ${Labels[b.use]}!`, "error");
                }
            }

            // PRODUCTION EXECUTION
            if(b.prod) {
                let amount = count * b.amt;
                let isFood = (b.storage === 'food');
                
                if(isFood && !foodFull) {
                    State.res[b.prod] += amount;
                    logProd.push(`${amount} ${Labels[b.prod]}`);
                } else if(!isFood && !stockFull) {
                    State.res[b.prod] += amount;
                    logProd.push(`${amount} ${Labels[b.prod]}`);
                }
            }
        }

        // 3. VERARBEITUNG (M√ºhle, B√§cker, Brauer)
        const process = (key) => {
            let b = Config.buildings[key];
            let w = State.w[key];
            if(w <= 0) return;
            
            let maxIn = w * b.cap; // Kapazit√§t der Arbeiter
            let actualIn = Math.min(State.res[b.proc], maxIn);
            
            // Check Output Limit
            let isFood = (b.storage === 'food');
            if((isFood && foodFull) || (!isFood && stockFull)) return; 

            if(actualIn > 0) {
                State.res[b.proc] -= actualIn;
                let outAmt = actualIn * b.ratio;
                State.res[b.out] += outAmt;
                logProd.push(`${outAmt} ${Labels[b.out]}`);
            } else if(Math.random()<0.05) {
                UI.log(`${b.name} hat kein ${Labels[b.proc]}!`, "error");
            }
        };
        process('mill'); process('bakery'); process('brewery');

        // 4. KONSUM (Essen & Bier)
        let mouths = State.pop.curr;
        let diversity = 0;
        
        const consume = (type) => {
            if(State.res[type] > 0) {
                let eat = Math.min(State.res[type], mouths);
                State.res[type] -= eat;
                mouths -= eat;
                if(eat > 0) {
                    diversity++; 
                    // Nur loggen wenn relevant
                    if(State.day % 5 === 0) logEat.push(Labels[type]); 
                }
            }
        };
        consume('bread'); consume('meat'); consume('cheese'); consume('apple');

        let foodFactor = 0;
        if(mouths > 0) {
            UI.log(`Hungersnot! ${mouths} B√ºrger haben nichts gegessen.`, "error");
            foodFactor = -20;
        } else {
            foodFactor = diversity * 2; // +2 pro Nahrungsart
        }

        // Bier (Schenke)
        let beerFactor = 0;
        if(State.b.inn > 0 && State.res.beer > 0) {
            let drink = Math.min(State.res.beer, State.pop.curr);
            State.res.beer -= drink;
            if(drink >= State.pop.curr) beerFactor = 10 + (State.b.inn * 2);
        }

        // 5. FINANZEN & BELIEBTHEIT
        let tax = Config.taxes[State.taxIndex];
        State.res.gold += (State.pop.curr * tax.g);
        
        let relFactor = (State.b.church * 10) + (State.b.cathedral * 50);
        let miscFactor = (State.b.well * 2) + (State.b.apothecary * 5);

        let totalChange = foodFactor + beerFactor + relFactor + miscFactor + tax.h;
        State.pop.hap = Math.max(0, Math.min(100, State.pop.hap + totalChange));

        // 6. MIGRATION
        // Max Pop = H√ºtten * 5 + H√§user * 10
        State.pop.max = (State.b.hovel * 5) + (State.b.house * 10) + 8; // +8 Burgfried
        
        if(State.pop.hap > 60 && State.pop.curr < State.pop.max) {
            if(Math.random() > 0.5) { State.pop.curr++; UI.autoAssign(); }
        } else if(State.pop.hap < 40 && State.pop.curr > 0) {
            if(Math.random() > 0.5) { 
                State.pop.curr--; 
                // Worker entfernen
                for(let k in State.w) { if(State.w[k]>0){ State.w[k]--; break;}}
                UI.log("Ein B√ºrger verl√§sst die Burg.", "error"); 
            }
        }

        // REPORT
        if(warnings.length > 0) UI.log(warnings.join(", "), "error");
        if(logProd.length > 0) {
            // Zusammenfassen f√ºr bessere Lesbarkeit
            let shortProd = logProd.length > 3 ? `${logProd.length} Waren produziert` : logProd.join(", ");
            UI.log(`Tag ${State.day}: ${shortProd}`, "report");
        }

        UI.update();
    },

    setTax: function(dir) {
        let n = State.taxIndex + dir;
        if(n >= 0 && n < Config.taxes.length) { State.taxIndex = n; UI.update(); }
    },

    recruit: function(type) {
        let needs = (type==='regular') ? {g:10, w:'swords', a:'armor'} : {g:50}; // Einfachheitshalber S√∂ldner nur Gold
        let avail = State.pop.curr - State.pop.soldiers - State.pop.mercs - UI.getTotalWorkers();
        
        if(type==='regular') {
            if(State.b.barracks < 1) return UI.log("Keine Kaserne!", "error");
            if(avail <= 0) return UI.log("Keine freien Bauern!", "error");
            if(State.res.gold < 10) return UI.log("Zu wenig Gold!", "error");
            // Einfachheit: Ein Soldat braucht EINE Waffe (beliebig)
            if(State.res.swords > 0 || State.res.bows > 0 || State.res.leather > 0) {
                // Remove one weapon
                if(State.res.swords > 0) State.res.swords--;
                else if(State.res.bows > 0) State.res.bows--;
                else State.res.leather--;
                
                State.res.gold -= 10;
                State.pop.soldiers++;
                UI.log("Soldat rekrutiert", "info");
            } else {
                UI.log("Waffen fehlen!", "error");
            }
        } else {
            if(State.res.gold >= 50) {
                State.res.gold -= 50;
                State.pop.mercs++;
                UI.log("S√∂ldner angeheuert", "info");
            }
        }
        UI.update();
    },

    startRaid: function() {
        if((State.pop.soldiers + State.pop.mercs) < 5) return UI.log("Zu wenig Truppen!", "error");
        UI.log("Truppen ausgesandt...", "info");
        setTimeout(() => {
            let loot = Math.floor(Math.random()*200);
            State.res.gold += loot;
            UI.log(`Raubzug beendet. ${loot} Gold erbeutet.`, "success");
            UI.update();
        }, 3000);
    },

    build: function(key) {
        let b = Config.buildings[key];
        if(State.res.gold >= b.costG && State.res.wood >= (b.costW||0) && State.res.stone >= (b.costS||0)) {
            State.res.gold -= b.costG;
            State.res.wood -= (b.costW||0);
            State.res.stone -= (b.costS||0);
            State.b[key]++;
            
            // Auto Worker
            if(b.amt) {
                let free = State.pop.curr - State.pop.soldiers - State.pop.mercs - UI.getTotalWorkers();
                if(free > 0) State.w[key]++;
            }

            UI.log(`${b.name} errichtet.`, "success");
            UI.update();
        } else {
            UI.log("Zu wenig Rohstoffe!", "error");
        }
    },

    trade: function(item, buy) {
        let price = 5; // Simpel
        if(buy) {
            if(State.res.gold >= price) { State.res.gold -= price; State.res[item] += 5; }
        } else {
            if(State.res[item] >= 5) { State.res[item] -= 5; State.res.gold += 3; }
        }
        UI.updateMarket();
        UI.update();
    }
};

const UI = {
    cat: 'burg',
    
    selectCat: function(c) {
        this.cat = c;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        this.renderBuildings();
    },

    renderCats: function() {
        // HTML static in footer
    },

    renderBuildings: function() {
        const div = document.getElementById('build-menu-content');
        div.innerHTML = "";
        
        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            if(b.cat !== this.cat) continue;
            
            let count = State.b[k];
            let worker = State.w[k] || 0;
            
            let costStr = `${b.costG}üí∞`;
            if(b.costW) costStr += ` ${b.costW}ü™µ`;
            if(b.costS) costStr += ` ${b.costS}üß±`;

            let el = document.createElement('div');
            el.className = "building-icon";
            el.title = b.desc || b.name;
            el.onclick = () => Game.build(k);
            el.innerHTML = `
                ${count > 0 ? `<span class="b-count">${count}</span>` : ''}
                <div class="b-img">${b.icon}</div>
                <div class="b-name">${b.name}</div>
                <div class="b-cost">${costStr}</div>
            `;
            div.appendChild(el);
        }
    },

    update: function() {
        // Header Resources
        document.getElementById('res-gold').innerText = Math.floor(State.res.gold);
        // Vorr√§te berechnen
        let curStock = State.res.wood + State.res.stone + State.res.iron + State.res.pitch + State.res.wheat + State.res.flour + State.res.hops + State.res.leather;
        let maxStock = State.b.stockpile * 50;
        let curFood = State.res.meat + State.res.apple + State.res.cheese + State.res.bread;
        let maxFood = State.b.granary * 50;

        document.getElementById('limit-stock').innerText = `Lager: ${Math.floor(curStock)}/${maxStock}`;
        document.getElementById('limit-food').innerText = `Korn: ${Math.floor(curFood)}/${maxFood}`;
        
        if(curStock >= maxStock) document.getElementById('limit-stock').classList.add('limit-alert');
        else document.getElementById('limit-stock').classList.remove('limit-alert');
        
        if(curFood >= maxFood) document.getElementById('limit-food').classList.add('limit-alert');
        else document.getElementById('limit-food').classList.remove('limit-alert');

        // Pop
        let workers = this.getTotalWorkers();
        let idle = State.pop.curr - State.pop.soldiers - State.pop.mercs - workers;
        document.getElementById('res-pop').innerText = `${State.pop.curr}/${State.pop.max} (${idle})`;
        document.getElementById('res-hap').innerText = Math.floor(State.pop.hap);
        document.getElementById('res-mil').innerText = `${State.pop.mercs} / ${State.pop.soldiers}`;

        // Side Info
        document.getElementById('game-day').innerText = State.day;
        document.getElementById('tax-name').innerText = Config.taxes[State.taxIndex].name;

        // Re-Render Buildings (f√ºr Counter update)
        this.renderBuildings();
    },

    updateLogTime: function() {
        // Optional: Smooth scroll or time update
    },

    getTotalWorkers: function() {
        let sum = 0;
        for(let k in State.w) sum += State.w[k];
        return sum;
    },

    log: function(msg, type) {
        const log = document.getElementById('center-log');
        const d = document.createElement('div');
        d.className = `log-card ${type}`;
        d.innerHTML = `<div class="log-header">Nachricht</div><div>${msg}</div>`;
        log.prepend(d);
        if(log.children.length > 15) log.lastChild.remove();
    },

    autoAssign: function() {
        let idle = State.pop.curr - State.pop.soldiers - State.pop.mercs - this.getTotalWorkers();
        if(idle <= 0) return;
        
        // Simple priority filler
        for(let k in Config.buildings) {
            if(idle <= 0) break;
            if(Config.buildings[k].amt && State.b[k] > State.w[k]) {
                State.w[k]++;
                idle--;
            }
        }
    },

    toggleMarket: function(show) {
        const m = document.getElementById('market-modal');
        m.style.display = show ? 'flex' : 'none';
        if(show) this.renderMarket();
    },

    renderMarket: function() {
        const list = document.getElementById('market-list');
        list.innerHTML = "";
        let goods = ['wood','stone','iron','pitch','wheat','flour','hops','meat','apple','cheese','bread','beer','bows','swords','armor','leather'];
        
        goods.forEach(key => {
            let row = document.createElement('div');
            row.className = 'trade-row';
            row.innerHTML = `
                <div>${Labels[key] || key} (${Math.floor(State.res[key])})</div>
                <div>
                    <button onclick="Game.trade('${key}', true)">Kauf (5üí∞)</button>
                    <button onclick="Game.trade('${key}', false)">Verk (3üí∞)</button>
                </div>
            `;
            list.appendChild(row);
        });
    }
};

Game.init();
</script>
</body>
</html>
