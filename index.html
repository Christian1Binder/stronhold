<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burgherr V5 - Visual Village</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-ui: #2c2c2c; 
            --bg-paper: #e0d5b7;
            --primary: #5d4037; 
            --accent: #d32f2f; 
            --highlight: #ffb300;
            --text-light: #f5f5f5;
        }

        * { box-sizing: border-box; user-select: none; }
        body { font-family: 'Lato', sans-serif; background: #111; color: #333; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- 1. HEADER (OLD STYLE RESTORED) --- */
        header { 
            background: var(--bg-ui); color: var(--text-light); height: 100px; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; border-bottom: 3px solid var(--primary); flex-shrink: 0;
        }
        
        .header-title h1 { font-family: 'MedievalSharp'; margin: 0; font-size: 1.4rem; color: var(--highlight); }
        .header-title span { font-size: 0.8rem; color: #aaa; }

        .res-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; flex: 1; justify-content: flex-end; }
        .res-box { 
            background: rgba(0,0,0,0.4); border: 1px solid #555; border-radius: 4px; 
            padding: 3px 6px; min-width: 60px; text-align: center; display: flex; flex-direction: column;
        }
        .res-box small { font-size: 0.55rem; text-transform: uppercase; color: #aaa; margin-bottom: 2px; border-bottom: 1px solid #444; }
        .res-row { display: flex; justify-content: center; gap: 8px; font-size: 0.9rem; font-weight: bold; }
        .res-single { display: flex; flex-direction: column; align-items: center; }
        .res-ico { font-size: 1rem; }

        /* --- 2. MAIN AREA (VILLAGE & LOG) --- */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* VISUAL VILLAGE (LINKS/MITTE) */
        #village-map {
            flex: 1; 
            background-color: #558b2f; /* Wiese */
            background-image: 
                radial-gradient(#689f38 15%, transparent 16%),
                radial-gradient(#33691e 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            padding: 20px;
            display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px;
        }
        
        /* Die Geb√§ude auf der Karte */
        .map-building {
            width: 60px; height: 60px; 
            background: #e0d5b7; border: 2px solid #3e2723; border-radius: 6px;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
            box-shadow: 2px 4px 5px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        .map-building::after { content:''; position:absolute; top:2px; left:2px; width:4px; height:4px; border-radius:50%; background:#8d6e63; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* LOG (RECHTS, SCHMAL) */
        aside.log-sidebar {
            width: 300px; 
            background: #d7ccc8; 
            border-left: 3px solid var(--primary);
            display: flex; flex-direction: column;
            z-index: 10;
        }
        .log-container { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 6px; }
        
        /* LOG ITEMS */
        .log-entry { background: #fff; padding: 6px; border-radius: 4px; font-size: 0.8rem; border-left: 4px solid #aaa; box-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-shrink: 0; }
        .log-entry.report { border-color: #558b2f; background: #f1f8e9; }
        .log-entry.error { border-color: #d32f2f; background: #ffebee; font-weight: bold; }
        .log-entry.info { border-color: #ffb300; }

        /* SIDEBAR CONTROLS */
        .sidebar-controls { padding: 10px; background: #bcaaa4; border-top: 1px solid #8d6e63; }
        .side-btn { width: 100%; padding: 8px; margin-bottom: 5px; cursor: pointer; border: 1px solid #5d4037; background: #efebe9; font-weight: bold; border-radius: 3px; }
        .side-btn:hover { background: #fff; }

        /* --- 3. FOOTER (BUILD MENU) --- */
        footer {
            height: 140px; background: #3e2723; border-top: 4px solid #8d6e63;
            display: flex; align-items: center; padding: 0 10px; flex-shrink: 0; z-index: 20;
        }
        
        .cat-list { display: flex; flex-direction: column; gap: 5px; margin-right: 15px; border-right: 1px solid #6d4c41; padding-right: 10px; height: 100%; justify-content: center; }
        .cat-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #a1887f; background: #5d4037; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        .cat-btn:hover, .cat-btn.active { background: var(--highlight); color: #000; transform: scale(1.1); border-color: #fff; }

        .build-list { display: flex; gap: 8px; overflow-x: auto; flex: 1; padding: 5px; height: 100%; align-items: center; }
        
        .b-card {
            min-width: 80px; height: 100px; background: #e0d5b7; border: 2px solid #5d4037; border-radius: 5px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; transition: transform 0.1s;
        }
        .b-card:hover { transform: translateY(-3px); background: #fff; }
        .b-badge { position: absolute; top: -5px; right: -5px; background: #d32f2f; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #fff; box-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
        .b-icon { font-size: 2rem; margin-bottom: 2px; }
        .b-name { font-size: 0.65rem; font-weight: bold; margin-bottom: 2px; }
        .b-cost { font-size: 0.6rem; color: #555; }

        /* MODALS */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-paper); padding: 20px; width: 500px; border: 4px solid var(--primary); border-radius: 8px; text-align: center; }
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 400px; overflow-y: auto; text-align: left; }
        .trade-row { background: #fff; padding: 5px; border: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .trade-btn { padding: 2px 8px; font-size: 0.8rem; cursor: pointer; }

    </style>
</head>
<body>

<div id="market-modal" class="modal">
    <div class="modal-content">
        <h2>Marktplatz</h2>
        <div id="market-list" class="market-grid"></div>
        <button onclick="UI.toggleMarket(false)" class="side-btn" style="margin-top:10px">Schlie√üen</button>
    </div>
</div>

<header>
    <div class="header-title">
        <h1>Burgherr</h1>
        <span id="limit-info">Lager: 0/100</span>
    </div>
    
    <div class="res-bar">
        <div class="res-box">
            <small>Kasse</small>
            <div class="res-row">
                <span class="res-single" title="Gold">üí∞<span id="r-gold">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <small>Baustoff</small>
            <div class="res-row">
                <span class="res-single" title="Holz">üå≤<span id="r-wood">0</span></span>
                <span class="res-single" title="Stein">üß±<span id="r-stone">0</span></span>
                <span class="res-single" title="Eisen">‚õìÔ∏è<span id="r-iron">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <small>Ernte</small>
            <div class="res-row">
                <span class="res-single" title="Weizen">üåæ<span id="r-wheat">0</span></span>
                <span class="res-single" title="Mehl">ü•°<span id="r-flour">0</span></span>
                <span class="res-single" title="Hopfen">üåø<span id="r-hops">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <small>Speise</small>
            <div class="res-row">
                <span class="res-single" title="Brot">üçû<span id="r-bread">0</span></span>
                <span class="res-single" title="Fleisch">ü•©<span id="r-meat">0</span></span>
                <span class="res-single" title="√Ñpfel">üçé<span id="r-apple">0</span></span>
                <span class="res-single" title="K√§se">üßÄ<span id="r-cheese">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <small>Waffen</small>
            <div class="res-row">
                <span class="res-single" title="Waffen">‚öîÔ∏è<span id="r-weapon">0</span></span>
                <span class="res-single" title="Bier">üç∫<span id="r-beer">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <small>Reich</small>
            <div class="res-row">
                <span class="res-single" title="B√ºrger">üë®‚Äçüåæ<span id="r-pop">0</span></span>
                <span class="res-single" title="Beliebtheit">‚ù§Ô∏è<span id="r-hap">0</span></span>
                <span class="res-single" title="Soldaten">üõ°Ô∏è<span id="r-sold">0</span></span>
            </div>
        </div>
    </div>
</header>

<main>
    <div id="village-map">
        </div>

    <aside class="log-sidebar">
        <div style="padding:10px; background:#bcaaa4; font-weight:bold; border-bottom:1px solid #8d6e63;">
            Tag <span id="day-display">1</span> - Level <span id="level-display">1</span>
        </div>
        
        <div class="log-container" id="game-log">
            </div>

        <div class="sidebar-controls">
            <button class="side-btn" onclick="UI.toggleMarket(true)">‚öñÔ∏è Marktplatz</button>
            <button class="side-btn" onclick="Game.recruit('regular')">üõ°Ô∏è Soldat (10üí∞)</button>
            <button class="side-btn" style="background:#ffccbc" onclick="Game.startRaid()">‚öîÔ∏è Raubzug</button>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <button class="side-btn" onclick="Game.setTax(-1)">Steuer -</button>
                <button class="side-btn" onclick="Game.setTax(1)">Steuer +</button>
            </div>
            <div style="font-size:0.7rem; text-align:center; margin-top:2px;">Aktuell: <span id="tax-text">Keine</span></div>
        </div>
    </aside>
</main>

<footer>
    <div class="cat-list">
        <div class="cat-btn active" onclick="UI.setCat('res')" title="Ressourcen">üî®</div>
        <div class="cat-btn" onclick="UI.setCat('food')" title="Nahrung">üçé</div>
        <div class="cat-btn" onclick="UI.setCat('city')" title="Stadt">üè†</div>
        <div class="cat-btn" onclick="UI.setCat('mil')" title="Milit√§r">‚öîÔ∏è</div>
    </div>

    <div class="build-list" id="build-menu">
        </div>
</footer>

<script>
/* DATEN */
const Config = {
    buildings: {
        // RES
        wood: { name: "Holzf√§ller", cat: "res", icon: "ü™ì", cost:{g:10}, prod:"wood", amt:2 },
        quarry: { name: "Steinbruch", cat: "res", icon: "‚õèÔ∏è", cost:{g:50,w:50}, prod:"stone", amt:1, needs:"ox" },
        ox: { name: "Ochsenjoch", cat: "res", icon: "üêÇ", cost:{g:20,w:20} },
        iron: { name: "Eisenmine", cat: "res", icon: "‚õìÔ∏è", cost:{g:100,w:100}, prod:"iron", amt:1 },
        stock: { name: "Vorratslager", cat: "res", icon: "üì¶", cost:{w:20}, desc:"+50 Lager" },
        
        // FOOD
        apple: { name: "Obstgarten", cat: "food", icon: "üçé", cost:{g:30,w:10}, prod:"apple", amt:3 },
        hunter: { name: "J√§ger", cat: "food", icon: "üèπ", cost:{g:20,w:5}, prod:"meat", amt:2 },
        wheat: { name: "Kornfarm", cat: "food", icon: "üåæ", cost:{g:40,w:10}, prod:"wheat", amt:2 },
        mill: { name: "M√ºhle", cat: "food", icon: "‚öôÔ∏è", cost:{g:100,w:50}, proc:"wheat", out:"flour", ratio:1, cap:8 },
        bake: { name: "B√§ckerei", cat: "food", icon: "üçû", cost:{g:50,w:20}, proc:"flour", out:"bread", ratio:4, cap:1 },
        dairy: { name: "K√§serei", cat: "food", icon: "üßÄ", cost:{g:40,w:20}, prod:"cheese", amt:2 },
        hops: { name: "Hopfenfarm", cat: "food", icon: "üåø", cost:{g:40,w:10}, prod:"hops", amt:2 },
        brew: { name: "Brauerei", cat: "food", icon: "üç∫", cost:{g:100,w:20}, proc:"hops", out:"beer", ratio:2, cap:2 },
        granary: { name: "Kornspeicher", cat: "food", icon: "üõñ", cost:{w:20}, desc:"+50 Nahrung" },

        // CITY
        hovel: { name: "H√ºtte", cat: "city", icon: "‚õ∫", cost:{w:10}, pop:5 },
        house: { name: "Haus", cat: "city", icon: "üè†", cost:{g:50,w:30,s:10}, pop:10 },
        church: { name: "Kirche", cat: "city", icon: "‚õ™", cost:{g:500,s:100}, rel:10 },
        cath: { name: "KATHEDRALE", cat: "city", icon: "üïç", cost:{g:5000,s:2000}, rel:50 },
        
        // MIL
        smith: { name: "Schmiede", cat: "mil", icon: "‚öîÔ∏è", cost:{g:200,w:100}, use:"iron", out:"weapon", amt:1 },
        tanner: { name: "Gerber", cat: "mil", icon: "üß•", cost:{g:100,w:50}, needs:"dairy" }, // Simuliert
        barracks: { name: "Kaserne", cat: "mil", icon: "üè∞", cost:{g:150,s:50} },
        wall: { name: "Holzwall", cat: "mil", icon: "ü™µ", cost:{g:10,w:20}, def:10 },
        tower: { name: "Stein-Turm", cat: "mil", icon: "üóº", cost:{g:200,s:100}, def:150 }
    },
    taxes: ["Steuerfrei", "Niedrig", "Mittel", "Hoch", "Grausam"]
};

let State = {
    day: 1, paused: false,
    res: { gold:200, wood:50, stone:0, iron:0, wheat:0, flour:0, bread:20, meat:10, apple:10, cheese:0, hops:0, beer:0, weapon:0 },
    pop: { curr:5, max:0, sold:0, hap:100 },
    b: {}, w: {}, tax: 0
};
// Init
for(let k in Config.buildings) { State.b[k]=0; State.w[k]=0; }
State.b.stock=1; State.b.granary=1;

const Game = {
    init: function() {
        UI.setCat('res');
        UI.update();
        setInterval(this.tick, 5000);
        UI.log("Sire! Baut H√ºtten und Holzf√§ller.", "info");
    },
    tick: function() {
        if(State.paused) return;
        State.day++;
        
        // 1. Storage
        let maxStock = State.b.stock * 50;
        let maxFood = State.b.granary * 50;
        let curStock = State.res.wood + State.res.stone + State.res.iron + State.res.wheat + State.res.flour + State.res.hops + State.res.weapon;
        let curFood = State.res.bread + State.res.meat + State.res.apple + State.res.cheese + State.res.beer;
        let fullS = curStock >= maxStock;
        let fullF = curFood >= maxFood;

        let prodLog = [];

        // 2. Production
        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            let n = State.w[k];
            if(n <= 0) continue;

            // Logic Checks
            if(k==='quarry' && State.b.ox < n) n = State.b.ox; // Need Ox
            
            // Production
            if(b.prod) {
                let amt = n * b.amt;
                let isFood = ['meat','apple','wheat','hops','cheese'].includes(b.prod);
                if((isFood && !fullF) || (!isFood && !fullS)) {
                    State.res[b.prod] += amt;
                    prodLog.push(`${amt} ${b.prod}`);
                }
            }
            // Processing
            if(b.proc) {
                let maxIn = n * (b.cap||1);
                let take = Math.min(State.res[b.proc], maxIn);
                if(take > 0 && ((b.out==='bread' && !fullF) || (b.out!=='bread' && !fullS))) {
                    State.res[b.proc] -= take;
                    let gain = take * b.ratio;
                    State.res[b.out] += gain;
                    prodLog.push(`${gain} ${b.out}`);
                }
            }
            // Smith
            if(b.use) {
                if(State.res[b.use] >= n) {
                    State.res[b.use] -= n;
                    State.res[b.out] += n;
                    prodLog.push(`${n} ${b.out}`);
                }
            }
        }

        // 3. Eat
        let eat = State.pop.curr;
        let types = ['bread','meat','apple','cheese'];
        let ate = 0;
        types.forEach(t => {
            if(eat > 0 && State.res[t] > 0) {
                let take = Math.min(eat, State.res[t]);
                State.res[t] -= take; eat -= take; ate += take;
            }
        });
        
        let hapChange = 0;
        if(eat > 0) { UI.log(`${eat} hungern!`, "error"); hapChange -= 20; }
        else hapChange += 2;

        // Taxes
        let tax = [-2, 0, 2, 4, 8][State.tax];
        let taxHap = [5, 1, -2, -5, -15][State.tax];
        State.res.gold += (State.pop.curr * tax);
        hapChange += taxHap;

        // Beer
        if(State.res.beer >= State.pop.curr && State.pop.curr > 0) {
            State.res.beer -= State.pop.curr;
            hapChange += 10;
        }

        // Church
        hapChange += (State.b.church * 5);

        // Calc Hap
        State.pop.hap = Math.min(100, Math.max(0, State.pop.hap + hapChange));

        // Migration
        State.pop.max = (State.b.hovel*5) + (State.b.house*10) + 5;
        let work = 0; for(let k in State.w) work += State.w[k];
        State.pop.idle = State.pop.curr - State.pop.sold - work;

        if(State.pop.hap > 60 && State.pop.curr < State.pop.max && Math.random()>0.5) {
            State.pop.curr++; State.pop.idle++; UI.autoAssign();
        } else if(State.pop.hap < 30 && State.pop.curr > 0) {
            State.pop.curr--; State.pop.idle--; // Quick fix logic
            UI.log("B√ºrger flieht!", "error");
        }

        // Logs
        if(prodLog.length) UI.log(`Prod: ${prodLog.join(', ')}`, "report");
        if(fullS || fullF) UI.log("Lager voll!", "error");

        UI.update();
    },

    build: function(k) {
        let b = Config.buildings[k];
        if(State.res.gold >= (b.cost.g||0) && State.res.wood >= (b.cost.w||0) && State.res.stone >= (b.cost.s||0)) {
            State.res.gold -= (b.cost.g||0); State.res.wood -= (b.cost.w||0); State.res.stone -= (b.cost.s||0);
            State.b[k]++;
            if(b.amt || b.proc || b.use) UI.autoAssign(); // Try assign worker
            if(k==='cath') UI.log("SIEG! Die Kathedrale steht!", "info");
            UI.addMapIcon(b.icon);
            UI.update();
        } else UI.log("Zu wenig Ressourcen", "error");
    },

    recruit: function(type) {
        if(State.b.barracks < 1) return UI.log("Kaserne n√∂tig", "error");
        if(State.pop.idle < 1 && type!=='merc') return UI.log("Keine Bauern", "error");
        
        if(type==='regular') {
            if(State.res.gold >= 10 && State.res.weapon >= 1) {
                State.res.gold -= 10; State.res.weapon--; State.pop.curr--; State.pop.sold++;
                UI.log("Soldat ausgebildet", "info");
            }
        }
        UI.update();
    },

    trade: function(item, buy) {
        let p = 5; 
        if(buy) {
            if(State.res.gold >= p) { State.res.gold -= p; State.res[item]+=5; }
        } else {
            if(State.res[item] >= 5) { State.res[item] -= 5; State.res.gold += 3; }
        }
        UI.update(); UI.renderMarket();
    },

    setTax: function(d) {
        let n = State.tax + d;
        if(n >= 0 && n < 5) State.tax = n;
        UI.update();
    },

    startRaid: function() {
        if(State.pop.sold < 5) return UI.log("Zu wenig Truppen", "error");
        UI.log("Truppen entsandt...", "info");
        setTimeout(()=>{ 
            State.res.gold += 100; UI.log("Beute: 100 Gold", "info"); UI.update();
        }, 2000);
    }
};

const UI = {
    cat: 'res',
    setCat: function(c) { 
        this.cat = c; 
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        this.renderBuildMenu(); 
    },
    
    renderBuildMenu: function() {
        const d = document.getElementById('build-menu'); d.innerHTML = "";
        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            if(b.cat !== this.cat) continue;
            let cost = [];
            if(b.cost.g) cost.push(b.cost.g+"üí∞");
            if(b.cost.w) cost.push(b.cost.w+"üå≤");
            if(b.cost.s) cost.push(b.cost.s+"üß±");
            
            let div = document.createElement('div');
            div.className = "b-card";
            div.onclick = () => Game.build(k);
            div.innerHTML = `
                ${State.b[k]>0 ? `<div class="b-badge">${State.b[k]}</div>` : ''}
                <div class="b-icon">${b.icon}</div>
                <div class="b-name">${b.name}</div>
                <div class="b-cost">${cost.join(' ')}</div>
            `;
            d.appendChild(div);
        }
    },

    addMapIcon: function(icon) {
        let d = document.createElement('div');
        d.className = 'map-building';
        d.innerText = icon;
        document.getElementById('village-map').appendChild(d);
    },

    autoAssign: function() {
        // Simple logic: fill prod buildings
        let idle = State.pop.curr - State.pop.sold;
        // Reset workers
        for(let k in State.w) State.w[k]=0;
        
        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            if(b.amt || b.proc || b.use) {
                let needed = State.b[k]; // 1 worker per building
                let take = Math.min(needed, idle);
                State.w[k] = take;
                idle -= take;
            }
        }
    },

    update: function() {
        const s = State.res;
        ['gold','wood','stone','iron','wheat','flour','hops','bread','meat','apple','cheese','beer','weapon'].forEach(k => {
            let el = document.getElementById('r-'+k);
            if(el) el.innerText = Math.floor(s[k]);
        });
        
        document.getElementById('r-pop').innerText = State.pop.curr + "/" + State.pop.max;
        document.getElementById('r-hap').innerText = Math.floor(State.pop.hap);
        document.getElementById('r-sold').innerText = State.pop.sold;
        document.getElementById('day-display').innerText = State.day;
        document.getElementById('tax-text').innerText = Config.taxes[State.tax];
        
        this.renderBuildMenu(); // Update counts
    },

    log: function(txt, type) {
        let d = document.createElement('div');
        d.className = `log-entry ${type}`;
        d.innerText = `Tag ${State.day}: ${txt}`;
        let c = document.getElementById('game-log');
        c.prepend(d);
        if(c.children.length > 20) c.lastChild.remove();
    },

    toggleMarket: function(show) {
        document.getElementById('market-modal').style.display = show ? 'flex' : 'none';
        if(show) {
            let lst = document.getElementById('market-list'); lst.innerHTML = "";
            for(let k in State.res) {
                if(k==='gold') continue;
                let r = document.createElement('div'); r.className='trade-row';
                r.innerHTML = `<span>${k} (${Math.floor(State.res[k])})</span><div><button class="trade-btn" onclick="Game.trade('${k}',1)">Kauf</button> <button class="trade-btn" onclick="Game.trade('${k}',0)">Verk</button></div>`;
                lst.appendChild(r);
            }
        }
    }
};

Game.init();
</script>
</body>
</html>
