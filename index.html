<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burgherr V6 - Stronghold Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #1a1a1a; 
            --scroll-bg: #fdf5e6; /* Pergament Farbe */
            --scroll-border: #8b5a2b;
            --primary: #5d4037; 
            --accent: #d32f2f; 
            --highlight: #ffb300;
            --text-dark: #3e2723;
        }

        * { box-sizing: border-box; user-select: none; }
        body { font-family: 'Lato', sans-serif; background: var(--bg-body); color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- 1. HEADER (RESOURCES & GOAL) --- */
        header { 
            background: #2d2d2d; height: 90px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; border-bottom: 2px solid #444;
        }
        
        .header-info { display: flex; flex-direction: column; }
        .level-display { font-family: 'MedievalSharp'; font-size: 1.4rem; color: var(--highlight); }
        .objective { font-size: 0.8rem; color: #aaa; margin-top: 2px; }
        .obj-done { color: #81c784; text-decoration: line-through; }

        .res-bar { display: flex; gap: 10px; }
        .res-box { 
            background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 4px; 
            padding: 2px 8px; min-width: 70px; text-align: center;
        }
        .res-label { font-size: 0.6rem; text-transform: uppercase; color: #888; border-bottom: 1px solid #444; display: block; margin-bottom: 2px;}
        .res-row { font-size: 0.85rem; font-weight: bold; display: flex; gap: 8px; justify-content: center; }

        /* --- 2. MAIN AREA (MAP & SIDEBAR) --- */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* MAP */
        #village-map {
            flex: 1; 
            background-color: #4a6fa5; /* Fallback */
            background-image: radial-gradient(#558b2f 10%, #33691e 90%); /* Wiese */
            position: relative; overflow: hidden;
            display: flex; flex-wrap: wrap; align-content: flex-start; gap: 5px; padding: 20px;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
        }
        .map-icon { font-size: 1.8rem; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 5px; cursor: default; position: relative; }
        .map-icon:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }

        /* SIDEBAR */
        aside.right { 
            width: 320px; background: #d7ccc8; color: var(--text-dark);
            border-left: 4px solid var(--scroll-border);
            display: flex; flex-direction: column; 
        }
        
        /* Sidebar: Log */
        .log-area { flex: 1; overflow-y: auto; padding: 10px; background: rgba(255,255,255,0.5); font-size: 0.8rem; display: flex; flex-direction: column; gap: 4px; }
        .log-entry { padding: 4px; border-bottom: 1px dashed #aaa; }
        .log-entry.error { color: #d32f2f; font-weight: bold; }
        .log-entry.success { color: #2e7d32; }

        /* Sidebar: Controls */
        .controls-area { padding: 10px; background: #bcaaa4; border-top: 2px solid var(--primary); }
        .btn-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .ctrl-btn { flex: 1; padding: 8px; border: 1px solid #5d4037; background: #efebe9; font-weight: bold; cursor: pointer; border-radius: 3px; font-size: 0.8rem; }
        .ctrl-btn:hover { background: #fff; }
        .ctrl-btn.active { background: var(--highlight); }

        /* --- 3. FOOTER (STRONGHOLD SCROLL) --- */
        footer {
            height: 160px; background: var(--scroll-bg); border-top: 5px solid var(--scroll-border);
            display: flex; align-items: center; padding: 0 20px; flex-shrink: 0; z-index: 20;
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); color: var(--text-dark);
        }

        /* Kategorien Links */
        .category-bar { 
            display: flex; gap: 5px; padding-right: 20px; border-right: 2px solid #c5afa0; margin-right: 15px; 
            flex-wrap: wrap; width: 140px; justify-content: center;
        }
        .cat-icon { 
            width: 40px; height: 40px; background: #8d6e63; color: #fff; border: 2px solid #5d4037; 
            border-radius: 4px; display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem; cursor: pointer; box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
        }
        .cat-icon:hover { background: #a1887f; transform: translateY(-2px); }
        .cat-icon.selected { background: var(--highlight); color: #000; border-color: #fff; }

        /* Geb√§ude Rechts */
        .building-scroll { display: flex; overflow-x: auto; gap: 15px; align-items: center; height: 100%; padding-bottom: 10px; flex: 1; }
        .build-item {
            min-width: 80px; height: 100px; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; cursor: pointer; position: relative;
            background: rgba(0,0,0,0.05); border-radius: 6px; padding: 5px; transition: 0.2s;
        }
        .build-item:hover { background: rgba(0,0,0,0.1); transform: scale(1.05); }
        .build-count { position: absolute; top: 0; right: 0; background: var(--accent); color: #fff; font-size: 0.7rem; padding: 1px 5px; border-radius: 4px; }
        .build-ico { font-size: 2rem; margin-bottom: 5px; }
        .build-name { font-size: 0.7rem; font-weight: bold; text-align: center; line-height: 1; }
        .build-cost { font-size: 0.65rem; color: #666; margin-top: 2px; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; }
        .modal-box { background: var(--scroll-bg); padding: 20px; width: 600px; border: 4px solid var(--scroll-border); border-radius: 8px; text-align: center; color: var(--text-dark); position: relative;}
        .modal h2 { font-family: 'MedievalSharp'; margin-top: 0; border-bottom: 1px solid #aaa; padding-bottom: 10px; }
        
        .list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; max-height: 400px; overflow-y: auto; }
        .list-item { background: rgba(255,255,255,0.5); padding: 8px; border: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        
        /* Pause Overlay */
        #pause-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 50; display: none; justify-content: center; align-items: center; color: white; font-size: 3rem; font-family: 'MedievalSharp'; text-shadow: 0 0 10px #000; pointer-events: none;}

        .res-icon { font-style: normal; }
    </style>
</head>
<body>

<div id="recruit-modal" class="modal">
    <div class="modal-box">
        <h2>Rekrutierung</h2>
        <div id="recruit-list" class="list-grid"></div>
        <button onclick="UI.toggleRecruit(false)" class="ctrl-btn" style="margin-top:20px; width:100%;">Schlie√üen</button>
    </div>
</div>

<div id="market-modal" class="modal">
    <div class="modal-box">
        <h2>Marktplatz</h2>
        <div id="market-list" class="list-grid"></div>
        <button onclick="UI.toggleMarket(false)" class="ctrl-btn" style="margin-top:20px; width:100%;">Schlie√üen</button>
    </div>
</div>

<div id="msg-modal" class="modal">
    <div class="modal-box" style="width:400px">
        <h2 id="msg-title">Nachricht</h2>
        <p id="msg-text">Text</p>
        <button onclick="Game.closeMsg()" class="ctrl-btn" style="margin-top:20px; width:100%;">Weiter</button>
    </div>
</div>

<div id="pause-overlay">PAUSIERT</div>

<header>
    <div class="header-info">
        <div class="level-display" id="level-title">Level 1</div>
        <div class="objective" id="objective-text">Ziel: Lade...</div>
    </div>
    
    <div class="res-bar">
        <div class="res-box">
            <span class="res-label">Schatz</span>
            <div class="res-row">üí∞ <span id="r-gold">0</span></div>
        </div>
        <div class="res-box">
            <span class="res-label">Lager</span>
            <div class="res-row">
                <span title="Holz">üå≤<span id="r-wood">0</span></span>
                <span title="Stein">üß±<span id="r-stone">0</span></span>
                <span title="Eisen">‚õìÔ∏è<span id="r-iron">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <span class="res-label">Ernte</span>
            <div class="res-row">
                <span title="Weizen">üåæ<span id="r-wheat">0</span></span>
                <span title="Mehl">ü•°<span id="r-flour">0</span></span>
                <span title="Hopfen">üåø<span id="r-hops">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <span class="res-label">Speise</span>
            <div class="res-row">
                <span title="Brot">üçû<span id="r-bread">0</span></span>
                <span title="Fleisch">ü•©<span id="r-meat">0</span></span>
                <span title="√Ñpfel">üçé<span id="r-apple">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <span class="res-label">Armee</span>
            <div class="res-row">
                <span title="B√∂gen">üèπ<span id="r-bow">0</span></span>
                <span title="Speere">üî±<span id="r-spear">0</span></span>
                <span title="Schwerter">‚öîÔ∏è<span id="r-sword">0</span></span>
                <span title="R√ºstung">üõ°Ô∏è<span id="r-armor">0</span></span>
            </div>
        </div>
        <div class="res-box">
            <span class="res-label">Volk</span>
            <div class="res-row">
                <span title="B√ºrger">üë®‚Äçüåæ <span id="r-pop">0</span></span>
                <span title="Beliebtheit">‚ù§Ô∏è <span id="r-hap">0</span></span>
            </div>
        </div>
    </div>
</header>

<main>
    <div id="village-map">
        </div>

    <aside class="right">
        <div style="background:#bcaaa4; padding:5px; font-weight:bold; text-align:center; font-size:0.8rem;">Tag <span id="game-day">1</span></div>
        <div class="log-area" id="game-log"></div>
        
        <div class="controls-area">
            <div class="btn-row">
                <button class="ctrl-btn" onclick="UI.toggleRecruit(true)">üõ°Ô∏è Rekrutieren</button>
                <button class="ctrl-btn" onclick="UI.toggleMarket(true)">‚öñÔ∏è Marktplatz</button>
            </div>
            
            <div style="font-size:0.8rem; margin:5px 0;"><strong>Steuern:</strong> <span id="tax-disp">Keine</span></div>
            <div class="btn-row">
                <button class="ctrl-btn" onclick="Game.tax(-1)">-</button>
                <button class="ctrl-btn" onclick="Game.tax(1)">+</button>
            </div>

            <div style="margin-top:10px; border-top:1px dashed #555; padding-top:5px;">System</div>
            <div class="btn-row">
                <button class="ctrl-btn" onclick="Game.togglePause()">‚èØÔ∏è Pause</button>
                <button class="ctrl-btn" onclick="Game.save()">üíæ Save</button>
                <button class="ctrl-btn" onclick="Game.load()">üìÇ Load</button>
                <button class="ctrl-btn" onclick="Game.reset()" style="background:#ffcdd2;">Reset</button>
            </div>
        </div>
    </aside>
</main>

<footer>
    <div class="category-bar">
        <div class="cat-icon selected" onclick="UI.setCat('burg')" title="Burggeb√§ude">üè∞</div>
        <div class="cat-icon" onclick="UI.setCat('werk')" title="Werkst√§tten">üî®</div>
        <div class="cat-icon" onclick="UI.setCat('farm')" title="Farmen">üçé</div>
        <div class="cat-icon" onclick="UI.setCat('stadt')" title="Stadtgeb√§ude">üè†</div>
        <div class="cat-icon" onclick="UI.setCat('waffen')" title="Waffengeb√§ude">‚öîÔ∏è</div>
        <div class="cat-icon" onclick="UI.setCat('nahrung')" title="Nahrungsgeb√§ude">üçû</div>
    </div>

    <div class="building-scroll" id="build-list">
        </div>
</footer>

<script>
/* --- DATEN --- */
const Levels = [
    { id: 1, title: "Die Gr√ºndung", intro: "Sichert das √úberleben. Baut H√ºtten und sammelt Holz.", goal: { wood: 50, pop: 10 }, start: { gold:100, wood:20, food:20 } },
    { id: 2, title: "Brot & Stein", intro: "Baut Steinbr√ºche und eine B√§ckerei-Kette.", goal: { bread: 30, stone: 20 }, start: { gold:150, wood:50, food:30 } },
    { id: 3, title: "Waffenkammer", intro: "Produziert B√∂gen und Speere.", goal: { bow: 5, spear: 5 }, start: { gold:200, wood:100, stone:50, food:50 } },
    { id: 4, title: "Der erste Krieg", intro: "Bildet 10 Soldaten aus.", goal: { soldiers: 10 }, start: { gold:300, wood:100, stone:100, iron:20, food:100 } },
    { id: 5, title: "Die Kathedrale", intro: "Baut die Kathedrale.", goal: { cath: 1 }, start: { gold:1000, wood:500, stone:500, iron:100, food:200 } }
];

const Units = {
    peasant: { name: "Bauer", cost: 0, str: 1 }, // Auto defense
    archer: { name: "Bogensch√ºtze", cost: 10, wpn: "bow", str: 5 },
    spear: { name: "Pikenier", cost: 15, wpn: "spear", str: 8 },
    sword: { name: "Schwertk√§mpfer", cost: 30, wpn: "sword", armor: "armor", str: 15 }
};

const Config = {
    tick: 5000,
    taxes: ["Keine", "Niedrig", "Mittel", "Hoch", "Grausam"],
    buildings: {
        // BURG
        wall_w: { name:"Holzwall", cat:"burg", icon:"ü™µ", cost:{g:10,w:20}, def:10 },
        wall_s: { name:"Steinmauer", cat:"burg", icon:"üß±", cost:{g:50,s:20}, def:50 },
        tower:  { name:"Wachturm", cat:"burg", icon:"üóº", cost:{g:100,s:50}, def:150 },
        gate:   { name:"Torhaus", cat:"burg", icon:"‚õ©Ô∏è", cost:{g:50,w:20,s:20}, def:20 },
        barracks: { name:"Kaserne", cat:"burg", icon:"‚õ∫", cost:{g:150,s:20}, desc:"Rekrutierung" },
        armory: { name:"Waffenkammer", cat:"burg", icon:"üõ°Ô∏è", cost:{g:100,w:50}, desc:"Lager" }, // Cosmetic mostly

        // WERKSTATT
        wood:   { name:"Holzf√§ller", cat:"werk", icon:"ü™ì", cost:{g:10}, prod:"wood", amt:3 },
        ox:     { name:"Ochsenjoch", cat:"werk", icon:"üêÇ", cost:{g:20,w:20} },
        quarry: { name:"Steinbruch", cat:"werk", icon:"‚õèÔ∏è", cost:{g:50,w:50}, prod:"stone", amt:2, need:"ox" },
        iron:   { name:"Eisenmine", cat:"werk", icon:"‚õìÔ∏è", cost:{g:100,w:100}, prod:"iron", amt:1 },
        pitch:  { name:"Pechgrube", cat:"werk", icon:"‚ö´", cost:{g:150,w:50}, prod:"pitch", amt:1 },

        // FARM
        apple:  { name:"Obstgarten", cat:"farm", icon:"üçé", cost:{g:30,w:10}, prod:"apple", amt:3 },
        hunter: { name:"J√§gerstand", cat:"farm", icon:"üèπ", cost:{g:20,w:5}, prod:"meat", amt:2 },
        dairy:  { name:"K√§serei", cat:"farm", icon:"üßÄ", cost:{g:40,w:20}, prod:"cheese", amt:2 },
        wheat:  { name:"Getreide", cat:"farm", icon:"üåæ", cost:{g:40,w:10}, prod:"wheat", amt:2 },
        hops:   { name:"Hopfen", cat:"farm", icon:"üåø", cost:{g:40,w:10}, prod:"hops", amt:2 },

        // STADT
        hovel:  { name:"H√ºtte", cat:"stadt", icon:"üõñ", cost:{w:10}, pop:5 },
        house:  { name:"Haus", cat:"stadt", icon:"üè†", cost:{g:50,w:30,s:10}, pop:10 },
        church: { name:"Kirche", cat:"stadt", icon:"‚õ™", cost:{g:500,s:100}, rel:10 },
        cath:   { name:"KATHEDRALE", cat:"stadt", icon:"üïç", cost:{g:5000,s:2000}, rel:50 },
        apoth:  { name:"Apotheke", cat:"stadt", icon:"üíä", cost:{g:200,w:50}, hap:5 },
        well:   { name:"Brunnen", cat:"stadt", icon:"üíß", cost:{g:50,s:10}, hap:2 },

        // WAFFEN
        fletcher: { name:"Pfeilmacher", cat:"waffen", icon:"üèπ", cost:{g:100,w:50}, use:"wood", out:"bow", amt:1 },
        pole:     { name:"Pikenmacher", cat:"waffen", icon:"üî±", cost:{g:100,w:50}, use:"wood", out:"spear", amt:1 },
        smith:    { name:"Schmiede", cat:"waffen", icon:"‚öîÔ∏è", cost:{g:200,w:100}, use:"iron", out:"sword", amt:1 },
        armor:    { name:"R√ºstung", cat:"waffen", icon:"üõ°Ô∏è", cost:{g:200,w:100}, use:"iron", out:"armor", amt:1 },
        tanner:   { name:"Gerber", cat:"waffen", icon:"üß•", cost:{g:100,w:50}, need:"dairy", prod:"leather", amt:1 },

        // NAHRUNG
        granary: { name:"Kornspeicher", cat:"nahrung", icon:"üì¶", cost:{w:20}, cap:50 },
        mill:    { name:"M√ºhle", cat:"nahrung", icon:"‚öôÔ∏è", cost:{g:100,w:50}, proc:"wheat", out:"flour", ratio:1 },
        bake:    { name:"B√§ckerei", cat:"nahrung", icon:"üçû", cost:{g:50,w:20}, proc:"flour", out:"bread", ratio:4 },
        brew:    { name:"Brauerei", cat:"nahrung", icon:"üç∫", cost:{g:100,w:20}, proc:"hops", out:"beer", ratio:2 },
        inn:     { name:"Schenke", cat:"nahrung", icon:"üçª", cost:{g:200,w:100}, hap:10 }
    }
};

let State = {};

const Game = {
    init: function() {
        if(localStorage.getItem('sh_save')) this.load();
        else this.startLevel(1);
        
        UI.init();
        setInterval(this.tick, Config.tick);
        setInterval(UI.updateBar, 100);
        setInterval(this.save, 30000); // Auto save
    },

    startLevel: function(lvlId) {
        let l = Levels.find(x => x.id == lvlId);
        if(!l) return alert("Alle Level geschafft!");
        
        State = {
            level: lvlId, day: 1, paused: true, lastTick: Date.now(),
            res: { ...l.start, stone:0, iron:0, pitch:0, wheat:0, flour:0, bread:l.start.food||0, cheese:0, meat:0, apple:0, hops:0, beer:0, bow:0, spear:0, sword:0, armor:0, leather:0 },
            pop: { curr:5, max:0, sold:0, hap:100 },
            b: {}, w: {}, tax: 0
        };
        for(let k in Config.buildings) { State.b[k]=0; State.w[k]=0; }
        
        UI.showMsg(`Level ${lvlId}: ${l.title}`, l.intro);
        UI.renderMap();
        UI.update();
    },

    tick: function() {
        if(State.paused) return;
        State.day++;
        State.lastTick = Date.now();

        // 1. Prod
        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            let n = State.w[k];
            if(n <= 0) continue;

            // Logic
            if(b.need && State.b[b.need] < n) n = State.b[b.need]; // e.g. Quarry needs Ox

            // Simple Prod
            if(b.prod) {
                State.res[b.prod] += (n * (b.amt||1));
            }
            // Processing
            if(b.proc) {
                let take = Math.min(State.res[b.proc], n);
                if(take > 0) {
                    State.res[b.proc] -= take;
                    State.res[b.out] += (take * (b.ratio||1));
                }
            }
            // Crafting (Waffen)
            if(b.use) {
                if(State.res[b.use] >= n) {
                    State.res[b.use] -= n;
                    State.res[b.out] += (n * (b.amt||1));
                }
            }
        }

        // 2. Food
        let eat = State.pop.curr;
        let foods = ['bread','meat','cheese','apple'];
        let ate = 0;
        foods.forEach(f => {
            if(eat>0 && State.res[f]>0) {
                let take = Math.min(eat, State.res[f]);
                State.res[f] -= take; eat -= take; ate += take;
            }
        });
        
        let hapChg = 0;
        if(eat > 0) { UI.log(`${eat} hungern!`, 'error'); hapChange = -20; }
        else hapChg += 2; // Fed bonus

        // 3. Tax & Beer
        let taxVals = [2, 0, -2, -5, -15];
        let taxGold = [-2, 0, 2, 4, 8];
        hapChg += taxVals[State.tax];
        State.res.gold += (State.pop.curr * taxGold[State.tax]);

        if(State.res.beer >= State.pop.curr && State.pop.curr > 0) {
            State.res.beer -= State.pop.curr;
            hapChg += 5;
        }

        State.pop.hap = Math.max(0, Math.min(100, State.pop.hap + hapChg));

        // 4. Pop Growth
        State.pop.max = (State.b.hovel*5) + (State.b.house*10) + 5;
        let busy = 0; for(let k in State.w) busy += State.w[k];
        let idle = State.pop.curr - State.pop.sold - busy;

        if(State.pop.hap > 60 && State.pop.curr < State.pop.max && Math.random()>0.5) {
            State.pop.curr++; UI.log("B√ºrger zugewandert", "success"); Game.autoAssign();
        } else if(State.pop.hap < 20 && State.pop.curr > 0) {
            State.pop.curr--; UI.log("B√ºrger geflohen", "error");
            // Remove worker logic simplified
        }

        // 5. Check Win
        let l = Levels.find(x => x.id == State.level);
        let win = true;
        for(let k in l.goal) {
            let val = State.res[k] || State.b[k] || (k=='pop'?State.pop.curr:0) || (k=='soldiers'?State.pop.sold:0);
            if(val < l.goal[k]) win = false;
        }
        if(win) {
            State.paused = true;
            UI.showMsg("SIEG!", "Level geschafft!", () => Game.startLevel(State.level+1));
        }

        UI.update();
    },

    autoAssign: function() {
        let busy = 0; for(let k in State.w) busy += State.w[k];
        let idle = State.pop.curr - State.pop.sold - busy;
        if(idle <= 0) return;

        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            // Nur Produktionsgeb√§ude
            if((b.prod || b.proc || b.use) && State.b[k] > State.w[k]) {
                State.w[k]++;
                idle--;
                if(idle<=0) break;
            }
        }
    },

    build: function(key) {
        let b = Config.buildings[key];
        if(State.res.gold >= (b.cost.g||0) && State.res.wood >= (b.cost.w||0) && State.res.stone >= (b.cost.s||0)) {
            State.res.gold -= (b.cost.g||0); State.res.wood -= (b.cost.w||0); State.res.stone -= (b.cost.s||0);
            State.b[key]++;
            UI.addMapIcon(b.icon);
            Game.autoAssign();
            UI.update();
        } else UI.log("Zu wenig Rohstoffe", "error");
    },

    recruit: function(type) {
        if(State.b.barracks < 1) return UI.log("Keine Kaserne!", "error");
        
        // Count idle
        let busy = 0; for(let k in State.w) busy += State.w[k];
        let idle = State.pop.curr - State.pop.sold - busy;
        if(idle <= 0) return UI.log("Keine Rekruten (Bauern)", "error");

        let u = Units[type];
        if(State.res.gold < u.cost) return UI.log("Zu wenig Gold", "error");
        
        // Check Weapons
        if(u.wpn && State.res[u.wpn] < 1) return UI.log(u.wpn + " fehlt!", "error");
        if(u.armor && State.res[u.armor] < 1) return UI.log("R√ºstung fehlt!", "error");

        // Pay
        State.res.gold -= u.cost;
        if(u.wpn) State.res[u.wpn]--;
        if(u.armor) State.res[u.armor]--;
        State.pop.sold++;
        
        UI.log(u.name + " ausgebildet", "success");
        UI.update();
    },

    tax: function(d) {
        let n = State.tax + d;
        if(n >= 0 && n < 5) State.tax = n;
        UI.update();
    },

    trade: function(item, buy) {
        if(buy && State.res.gold >= 5) { State.res.gold-=5; State.res[item]+=5; }
        if(!buy && State.res[item] >= 5) { State.res[item]-=5; State.res.gold+=3; }
        UI.update(); UI.renderMarket();
    },

    togglePause: function() {
        State.paused = !State.paused;
        document.getElementById('pause-overlay').style.display = State.paused ? 'flex' : 'none';
    },
    save: function() { localStorage.setItem('sh_save', JSON.stringify(State)); UI.log("Gespeichert", "success"); },
    load: function() { 
        let d = localStorage.getItem('sh_save'); 
        if(d) { State = JSON.parse(d); State.paused = true; UI.renderMap(); UI.update(); UI.showMsg("Geladen","Willkommen zur√ºck"); }
    },
    reset: function() { localStorage.removeItem('sh_save'); location.reload(); },
    closeMsg: function() { document.getElementById('msg-modal').style.display = 'none'; State.paused = false; State.lastTick = Date.now(); }
};

const UI = {
    cat: 'burg',
    init: function() { this.renderBuild(); },
    setCat: function(c) { this.cat = c; this.renderBuild(); 
        document.querySelectorAll('.cat-icon').forEach(e => e.classList.remove('selected'));
        event.target.classList.add('selected');
    },
    renderBuild: function() {
        const d = document.getElementById('build-list'); d.innerHTML = "";
        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            if(b.cat !== this.cat) continue;
            let cost = [];
            if(b.cost.g) cost.push(b.cost.g+"üí∞"); if(b.cost.w) cost.push(b.cost.w+"üå≤"); if(b.cost.s) cost.push(b.cost.s+"üß±");
            
            let el = document.createElement('div'); el.className = "build-item";
            el.onclick = () => Game.build(k);
            el.innerHTML = `<span class="build-count">${State.b[k]}</span><div class="build-ico">${b.icon}</div><div class="build-name">${b.name}</div><div class="build-cost">${cost.join(' ')}</div>`;
            d.appendChild(el);
        }
    },
    update: function() {
        const r = State.res;
        ['gold','wood','stone','iron','wheat','flour','hops','bread','meat','apple','cheese','beer','bow','spear','sword','armor'].forEach(k => {
            let e = document.getElementById('r-'+k); if(e) e.innerText = Math.floor(r[k]);
        });
        document.getElementById('r-pop').innerText = State.pop.curr + "/" + State.pop.max;
        document.getElementById('r-hap').innerText = Math.floor(State.pop.hap);
        document.getElementById('r-sold').innerText = State.pop.sold;
        
        document.getElementById('game-day').innerText = State.day;
        document.getElementById('level-title').innerText = "Level " + State.level;
        document.getElementById('tax-disp').innerText = Config.taxes[State.tax];

        // Objective
        let l = Levels.find(x => x.id == State.level);
        if(l) {
            let txt = [];
            for(let k in l.goal) {
                let cur = State.res[k] || State.b[k] || (k=='pop'?State.pop.curr:0) || (k=='soldiers'?State.pop.sold:0);
                txt.push(`${k}: ${cur}/${l.goal[k]}`);
            }
            document.getElementById('objective-text').innerText = txt.join(', ');
        }
        
        this.renderBuild();
    },
    renderMap: function() {
        const m = document.getElementById('village-map'); m.innerHTML = "";
        for(let k in State.b) {
            for(let i=0; i<State.b[k]; i++) this.addMapIcon(Config.buildings[k].icon);
        }
    },
    addMapIcon: function(ico) {
        let d = document.createElement('div'); d.className='map-icon'; d.innerText=ico;
        document.getElementById('village-map').appendChild(d);
    },
    log: function(txt, type) {
        let d = document.createElement('div'); d.className=`log-entry ${type}`; d.innerText = `Tag ${State.day}: ${txt}`;
        let c = document.getElementById('game-log'); c.prepend(d);
    },
    showMsg: function(t, b, cb) {
        document.getElementById('msg-title').innerText = t;
        document.getElementById('msg-text').innerText = b;
        document.getElementById('msg-modal').style.display = 'flex';
        // Override button logic if callback
        let btn = document.querySelector('#msg-modal button');
        btn.onclick = cb ? () => { cb(); Game.closeMsg(); } : Game.closeMsg;
    },
    toggleMarket: function(show) {
        document.getElementById('market-modal').style.display = show ? 'flex' : 'none';
        if(show) { State.paused=true; this.renderMarket(); } else { State.paused=false; }
    },
    renderMarket: function() {
        const l = document.getElementById('market-list'); l.innerHTML = "";
        for(let k in State.res) {
            if(k=='gold') continue;
            let d = document.createElement('div'); d.className='trade-row';
            d.innerHTML = `<span>${k} (${Math.floor(State.res[k])})</span><div><button class="trade-btn" onclick="Game.trade('${k}',1)">K</button><button class="trade-btn" onclick="Game.trade('${k}',0)">V</button></div>`;
            l.appendChild(d);
        }
    },
    toggleRecruit: function(show) {
        document.getElementById('recruit-modal').style.display = show ? 'flex' : 'none';
        if(show) {
            State.paused=true; 
            const l = document.getElementById('recruit-list'); l.innerHTML = "";
            for(let k in Units) {
                if(k=='peasant') continue;
                let u = Units[k];
                let req = `${u.cost}üí∞`;
                if(u.wpn) req += `, 1 ${u.wpn}`;
                if(u.armor) req += `, 1 ${u.armor}`;
                let d = document.createElement('div'); d.className='trade-row';
                d.innerHTML = `<span>${u.name} (St√§rke ${u.str})</span><button class="trade-btn" onclick="Game.recruit('${k}')">Ausbilden (${req})</button>`;
                l.appendChild(d);
            }
        } else { State.paused=false; }
    }
};

Game.init();
</script>
</body>
</html>
