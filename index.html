<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burgherr WebApp - V2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #2b2b2b; --bg-panel: #fdf6e3; --primary: #8b5e3c; --primary-dark: #5d4037;
            --secondary: #37474f; --accent: #d32f2f; --positive: #2e7d32; --highlight: #f9a825;
            --text-main: #333333; --text-light: #f1f1f1; --border-radius: 8px;
        }

        * { box-sizing: border-box; user-select: none; }
        body { font-family: 'Lato', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 10px; height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        #app { background: var(--bg-panel); width: 100%; max-width: 1600px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.6); display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* HEADER */
        header { background: var(--secondary); color: var(--text-light); padding: 5px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 4px solid var(--primary); height: 120px; }
        .header-left h1 { font-family: 'MedievalSharp', cursive; margin: 0; font-size: 1.5rem; color: var(--highlight); text-shadow: 2px 2px 0 #000; }
        
        .res-container { display: flex; gap: 8px; flex: 1; justify-content: flex-end; }
        .res-group { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 4px 8px; display: flex; flex-direction: column; min-width: 90px; position: relative; cursor: default; }
        .res-group:hover { background: rgba(255,255,255,0.1); }
        .res-group-label { font-size: 0.6rem; text-transform: uppercase; color: #aaa; margin-bottom: 2px; border-bottom: 1px solid #555; text-align:center; }
        .res-items { display: flex; justify-content: space-around; align-items: center; gap: 8px; }
        .res-item { display: flex; flex-direction: column; align-items: center; }
        .res-icon { font-size: 1.1rem; }
        .res-val { font-weight: 900; font-size: 0.9rem; color: #fff; }
        .gold-val { color: var(--highlight); }

        /* TOOLTIP */
        .pop-tooltip { visibility: hidden; opacity: 0; width: 220px; background: #222; color: #fff; position: absolute; top: 100%; right: 0; padding: 10px; border-radius: 6px; z-index: 9999; font-size: 0.85rem; border: 1px solid #555; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: opacity 0.2s; pointer-events: none; margin-top: 5px; }
        .res-group:hover .pop-tooltip { visibility: visible; opacity: 1; }
        .tooltip-row { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding: 2px 0; }
        .val-pos { color: #81c784; } .val-neg { color: #e57373; } .val-neu { color: #ccc; }

        /* LAYOUT */
        main { display: flex; flex: 1; overflow: hidden; }
        aside.left { width: 360px; background: #f4ecd8; padding: 15px; overflow-y: auto; border-right: 1px solid #dccbb1; display: flex; flex-direction: column; gap: 10px; }
        aside.right { width: 380px; background: #eaddcf; padding: 15px; overflow-y: auto; border-left: 1px solid #dccbb1; display: flex; flex-direction: column; gap: 15px; }
        section#center-log { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; background: #fff; background-image: radial-gradient(#f4e4bc 10%, transparent 10%); background-size: 20px 20px; }

        h2 { font-family: 'MedievalSharp', cursive; color: var(--primary-dark); border-bottom: 2px solid var(--primary); font-size: 1.2rem; margin: 0 0 5px 0; }
        h3.cat-title { font-family: 'MedievalSharp', cursive; color: #555; margin: 10px 0 5px 0; border-bottom: 1px dashed #aaa; font-size: 1rem; }

        /* CARDS */
        .build-card {
            background: #fff; border: 1px solid #cbb092; padding: 6px 10px; border-radius: 4px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: background 0.2s; cursor: pointer;
            border-left: 4px solid transparent; position: relative; margin-bottom: 5px;
        }
        .build-card:hover { background: #fff8e1; border-left-color: var(--highlight); }
        .build-name { font-weight: bold; font-size: 0.9rem; }
        .build-cost { font-size: 0.7rem; color: #666; }
        
        .worker-pill { background: #eee; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; margin-top: 2px; color: #555; }
        .worker-pill.full { background: #c8e6c9; color: #2e7d32; } 
        .worker-pill.empty { background: #ffcdd2; color: #b71c1c; }

        /* LOG */
        .log-entry { padding: 5px 8px; border-radius: 4px; font-size: 0.9rem; border-left: 3px solid #ccc; background: #fcfcfc; }
        .log-entry.report { border-left-color: var(--highlight); background-color: #fffde7; font-family: monospace; font-size: 0.8rem; color: #333; }
        .log-entry.error { border-left-color: var(--accent); background-color: #ffebee; color: #b71c1c; font-weight: bold; }
        .log-entry.beer { border-left-color: #f57f17; background-color: #fff8e1; color: #bf360c; font-style: italic;}
        .log-entry.win { border: 2px solid var(--highlight); background-color: #fffde7; color: #f57f17; font-weight: bold; font-size: 1.1rem; text-align: center; }

        /* MARKET MODAL GRID */
        #market-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; max-height: 400px; overflow-y: auto; }
        .trade-item { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #ccc; text-align: center; }
        .trade-icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }
        .trade-actions { display: flex; gap: 5px; justify-content: center; margin-top: 5px; }
        .trade-btn { border: 1px solid #999; background: #eee; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.75rem; font-weight: bold; flex:1;}
        .trade-btn:hover { background: var(--highlight); }

        /* UI MISC */
        .preview-panel { background: #fff3e0; border: 1px solid #ffb74d; padding: 8px; border-radius: 6px; font-size: 0.85rem; }
        .preview-row { display: flex; justify-content: space-between; margin-bottom: 1px; }
        .p-plus { color: var(--positive); font-weight: bold; } .p-minus { color: var(--accent); font-weight: bold; }
        
        .bar-container { width: 100%; background: #ddd; height: 6px; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: var(--positive); transition: width 0.1s linear; }
        
        .floating-text { position: absolute; font-weight: bold; animation: floatUp 1s ease-out forwards; pointer-events: none; z-index: 9999; text-shadow: 1px 1px 0 #fff;}
        @keyframes floatUp { to { opacity: 0; transform: translateY(-30px); } }
        
        /* Modal General */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .modal-box { background: #fdf6e3; width: 600px; padding: 25px; border: 4px solid var(--primary); border-radius: 10px; text-align: center; max-height: 90vh; overflow-y: auto;}
        .modal-title { font-family: 'MedievalSharp'; font-size: 2rem; color: var(--accent); margin-bottom: 15px; }
        
        /* Button Style */
        .big-btn { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        .big-btn:hover { background: var(--primary-dark); }
        .big-btn.secondary { background: #fff; color: #333; border: 2px solid var(--primary); }
        .big-btn.secondary:hover { background: #eee; }

        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    </style>
</head>
<body>

<div id="particles"></div>

<div id="modal-info" class="modal-overlay">
    <div class="modal-box" style="width:400px">
        <div id="info-title" class="modal-title">Nachricht</div>
        <div id="info-text">Text</div>
        <button onclick="UI.closeInfo()" class="big-btn" style="margin-top:20px;">Verstanden</button>
    </div>
</div>

<div id="modal-market" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title">‚öñÔ∏è Der Marktplatz</div>
        <div style="font-size:0.9rem; color:#555;">Kauft und verkauft Waren gegen Gold.</div>
        
        <div id="market-grid">
            </div>

        <button onclick="UI.toggleMarket(false)" class="big-btn secondary" style="margin-top:20px;">Markt verlassen</button>
    </div>
</div>

<div id="app">
    <header>
        <div class="header-left">
            <h1>üè∞ Der Burgherr</h1>
        </div>
        <div class="res-container">
            <div class="res-group">
                <div class="res-group-label">Lager</div>
                <div class="res-items">
                    <div class="res-item" title="Gold"><span class="res-icon">üí∞</span><span class="res-val gold-val" id="res-gold">0</span></div>
                    <div class="res-item" title="Holz"><span class="res-icon">üå≤</span><span class="res-val" id="res-wood">0</span></div>
                    <div class="res-item" title="Stein"><span class="res-icon">üß±</span><span class="res-val" id="res-stone">0</span></div>
                    <div class="res-item" title="Eisen"><span class="res-icon">‚õìÔ∏è</span><span class="res-val" id="res-iron">0</span></div>
                </div>
            </div>
            
            <div class="res-group">
                <div class="res-group-label">Korn & Brot</div>
                <div class="res-items">
                    <div class="res-item" title="Weizen"><span class="res-icon">üåæ</span><span class="res-val" id="res-wheat">0</span></div>
                    <div class="res-item" title="Mehl"><span class="res-icon">ü•°</span><span class="res-val" id="res-flour">0</span></div>
                    <div class="res-item" title="Brot"><span class="res-icon">üçû</span><span class="res-val" id="res-bread">0</span></div>
                </div>
            </div>

            <div class="res-group">
                <div class="res-group-label">Speisekammer</div>
                <div class="res-items">
                    <div class="res-item" title="Fleisch"><span class="res-icon">ü•©</span><span class="res-val" id="res-meat">0</span></div>
                    <div class="res-item" title="√Ñpfel"><span class="res-icon">üçé</span><span class="res-val" id="res-apple">0</span></div>
                    <div class="res-item" title="Hopfen"><span class="res-icon">üåø</span><span class="res-val" id="res-hops">0</span></div>
                    <div class="res-item" title="Bier"><span class="res-icon">üç∫</span><span class="res-val" id="res-beer">0</span></div>
                </div>
            </div>

            <div class="res-group">
                <div class="res-group-label">Milit√§r</div>
                <div class="res-items">
                    <div class="res-item" title="Waffen"><span class="res-icon">‚öîÔ∏è</span><span class="res-val" id="res-weapon">0</span></div>
                    <div class="res-item" title="Soldaten"><span class="res-icon">üõ°Ô∏è</span><span class="res-val" id="res-soldier">0</span></div>
                </div>
            </div>

            <div class="res-group" id="pop-group">
                <div class="res-group-label">Das Reich</div>
                <div class="res-items">
                    <div class="res-item" title="Wohnraum"><span class="res-icon">üè†</span><span class="res-val" id="res-housing">0/0</span></div>
                    <div class="res-item" title="Unt√§tig"><span class="res-icon">üí§</span><span class="res-val" id="res-idle">0</span></div>
                    <div class="res-item"><span class="res-icon">‚ù§Ô∏è</span><span class="res-val" id="res-pop">0</span></div>
                </div>
                <div class="pop-tooltip" id="pop-details">Lade...</div>
            </div>
        </div>
    </header>

    <main>
        <aside class="left">
            <h2>üî® Bauauftr√§ge</h2>
            <div style="font-size:0.8rem; margin-bottom:10px; color:#555;">Automatische Arbeitszuweisung</div>
            <div id="build-list"></div>
        </aside>

        <section id="center-log"></section>

        <aside class="right">
            <h2>Verwaltung</h2>
            
            <button class="big-btn secondary" onclick="UI.toggleMarket(true)">‚öñÔ∏è Marktplatz √∂ffnen</button>

            <br><br>
            
            <div class="preview-panel" id="production-preview"></div>
            <div class="bar-container" style="margin-top:5px;"><div class="bar-fill" id="day-bar"></div></div>
            <div style="margin-top:5px; font-size:0.9rem; text-align:right;">Tag: <span id="stat-day">1</span></div>

            <hr style="border:0; border-top:1px solid #ccc; margin: 15px 0;">
            
            <h2>‚öîÔ∏è Ausbildung</h2>
            
            <div class="build-card" id="btn-recruit" onclick="Game.recruit('regular')">
                <div class="build-info">
                    <span class="build-name">Soldat (Kaserne)</span>
                    <span class="build-cost">10üí∞, 1‚öîÔ∏è, 1üë®‚Äçüåæ</span>
                </div>
                <div style="font-weight:bold;">+</div>
            </div>
            
            <div class="build-card" id="btn-merc" onclick="Game.recruit('mercenary')" style="background:#fff3e0;">
                <div class="build-info">
                    <span class="build-name">S√∂ldner anheuern</span>
                    <span class="build-cost">50üí∞ (Keine Bev√∂lkerung n√∂tig!)</span>
                </div>
                <div style="font-weight:bold;">+</div>
            </div>

            <br>
            <div style="margin-bottom:5px;">Steuern: <strong id="tax-display">Keine</strong></div>
            <div style="display:flex; gap:5px;">
                <button onclick="Game.setTax(-1)" style="flex:1;">Weniger</button>
                <button onclick="Game.setTax(1)" style="flex:1;">Mehr</button>
            </div>
        </aside>
    </main>
</div>

<script>
const Config = {
    tickRate: 5000, 
    combatStartDay: 40,
    buildings: {
        // --- RESSOURCEN ---
        woodcutter: { name: "Holzf√§ller", costG: 15, costW: 0, costS: 0, output: "wood", amount: 2, cat: "Ressourcen" },
        quarry:     { name: "Steinbruch", costG: 50, costW: 20, costS: 0, output: "stone", amount: 1, cat: "Ressourcen" },
        ironmine:   { name: "Eisenmine",  costG: 100, costW: 50, costS: 0, output: "iron", amount: 1, cat: "Ressourcen" },
        
        // --- NAHRUNG ---
        farm_apple: { name: "Apfelgarten", costG: 30, costW: 10, costS: 0, output: "apple", amount: 3, cat: "Nahrung" },
        hunter:     { name: "J√§gerstand", costG: 20, costW: 5, costS: 0, output: "meat", amount: 2, cat: "Nahrung" },
        farm_wheat: { name: "Getreidefarm", costG: 40, costW: 10, costS: 0, output: "wheat", amount: 2, cat: "Nahrung" }, 
        mill:       { name: "M√ºhle", costG: 80, costW: 30, costS: 10, process: "wheat", product: "flour", throughput: 8, ratio: 1, cat: "Nahrung" },
        bakery:     { name: "B√§ckerei", costG: 60, costW: 20, costS: 0, process: "flour", product: "bread", throughput: 1, ratio: 4, cat: "Nahrung" },
        farm_hops:  { name: "Hopfenfarm", costG: 40, costW: 15, costS: 0, output: "hops", amount: 2, cat: "Nahrung" },
        brewery:    { name: "Brauerei", costG: 100, costW: 20, costS: 20, process: "hops", product: "beer", throughput: 2, ratio: 2, cat: "Nahrung" },
        
        // --- WOHNRAUM ---
        house:      { name: "H√ºtte", costG: 0, costW: 10, costS: 0, capacity: 5, cat: "Wohnraum" },
        house_lg:   { name: "Haus", costG: 50, costW: 40, costS: 10, capacity: 10, cat: "Wohnraum" },

        // --- VERTEIDIGUNG ---
        weaponsmith:{ name: "Waffenschmiede", costG: 100, costW: 0, costS: 20, process: "iron", product: "weapons", throughput: 1, ratio: 1, cat: "Verteidigung" },
        barracks:   { name: "Kaserne", costG: 150, costW: 0, costS: 50, cat: "Verteidigung" },
        merc_post:  { name: "S√∂ldnerlager", costG: 500, costW: 50, costS: 0, cat: "Verteidigung" },

        // --- KUNST ---
        church:     { name: "Kirche", costG: 500, costW: 0, costS: 200, capacity: 0, religion: 15, cat: "Kunst" },
        cathedral:  { name: "KATHEDRALE", costG: 5000, costW: 2000, costS: 3000, capacity: 0, cat: "Kunst" } 
    },
    taxes: [
        { name: "Bestechung", gold: -2, pop: +5 },
        { name: "Keine", gold: 0, pop: +1 },
        { name: "Niedrig", gold: 2, pop: -2 },
        { name: "Hoch", gold: 4, pop: -6 },
        { name: "Grausam", gold: 8, pop: -15 }
    ]
};

const State = {
    day: 1, paused: false, lastTick: Date.now(),
    res: { gold: 200, wood: 50, stone: 0, iron: 0, wheat: 0, flour: 0, bread: 0, meat: 5, apple: 5, hops: 0, beer: 0, weapons: 0 },
    pop: { current: 5, max: 10, happiness: 100, soldiers: 0 },
    b: {}, w: {}, 
    taxIndex: 1, 
    factors: { food: 0, tax: 0, events: 0, beer: 0, religion: 0 },
};

// Init Buildings
for(let k in Config.buildings) { State.b[k] = 0; State.w[k] = 0; }

const Game = {
    init: function() {
        UI.renderBuildMenu();
        UI.update();
        setInterval(() => { if(!State.paused) this.tick(); }, Config.tickRate);
        setInterval(() => { if(!State.paused) UI.updateBar(); }, 100);
        UI.log("Sire! Baut die Wirtschaft auf. Klickt rechts auf 'Marktplatz', um zu handeln.", "report");
        this.autoAssign();
    },

    tick: function() {
        State.day++;
        State.lastTick = Date.now();
        State.factors = { food: 0, tax: 0, events: 0, beer: 0, religion: 0 };
        let report = { produced: [], eaten: [] };

        // 1. Produktion
        for(let k in Config.buildings) {
            let conf = Config.buildings[k];
            if(conf.output) {
                let amt = State.w[k] * conf.amount;
                if(amt > 0) { State.res[conf.output] += amt; report.produced.push(`${amt} ${conf.output}`); }
            }
        }

        // Verarbeitung
        this.process('mill', 'wheat', 'flour', report);
        this.process('bakery', 'flour', 'bread', report);
        this.process('brewery', 'hops', 'beer', report);
        this.process('weaponsmith', 'iron', 'weapons', report);

        // 2. Konsum
        let pop = State.pop.current;
        let foodDiversity = 0;
        
        if(pop > 0) {
            const eat = (type) => {
                if(State.res[type] > 0) {
                    let take = Math.min(State.res[type], pop);
                    State.res[type] -= take; pop -= take;
                    if(take > 0) { report.eaten.push(`${take} ${type}`); foodDiversity++; }
                }
            };
            eat('bread'); eat('meat'); eat('apple');
            
            if(pop > 0) { 
                UI.log(`HUNGER! ${pop} B√ºrger hungern!`, "error"); State.factors.food = -20; 
            } else { State.factors.food = foodDiversity; }

            // Bier
            if(State.res.beer > 0) {
                let drink = Math.min(State.res.beer, State.pop.current);
                State.res.beer -= drink;
                if(drink >= State.pop.current * 0.5) State.factors.beer = (drink === State.pop.current) ? 10 : 5;
            }
        }

        // 3. Religion
        if(State.b.church > 0) State.factors.religion = State.b.church * Config.buildings.church.religion;

        // 4. Steuern
        const tax = Config.taxes[State.taxIndex];
        if(State.pop.current > 0) {
            State.res.gold += (State.pop.current * tax.gold);
            State.factors.tax = tax.pop;
        }

        // 5. Beliebtheit
        let sum = State.factors.food + State.factors.tax + State.factors.events + State.factors.beer + State.factors.religion;
        State.pop.happiness = Math.max(0, Math.min(100, State.pop.happiness + sum));
        
        this.handleMigration();
        this.checkCombat();

        // Log
        let logText = "";
        if(report.produced.length) logText += `<b>P:</b> ${report.produced.join(', ')}. `;
        if(report.eaten.length) logText += `<b>V:</b> ${report.eaten.join(', ')}.`;
        if(logText) UI.log(logText, "report");

        UI.update();
    },

    process: function(b, inR, outR, rep) {
        let workers = State.w[b];
        let conf = Config.buildings[b];
        if(workers > 0) {
            let capacity = workers * (conf.throughput || 1);
            let possible = Math.min(State.res[inR], capacity);
            if(possible > 0) {
                State.res[inR] -= possible;
                let out = possible * conf.ratio;
                State.res[outR] += out;
                rep.produced.push(`${out} ${outR}`);
            }
        }
    },

    autoAssign: function() {
        let assigned = Object.values(State.w).reduce((a,b)=>a+b,0);
        let free = State.pop.current - State.pop.soldiers - assigned;
        if(free > 0) {
            const priority = ['farm_apple', 'hunter', 'bakery', 'mill', 'farm_wheat', 'brewery', 'farm_hops', 'woodcutter', 'quarry', 'ironmine', 'weaponsmith'];
            for(let t of priority) {
                if(free <= 0) break;
                if(State.b[t] > 0) {
                    let openSlots = State.b[t] - State.w[t];
                    if(openSlots > 0) {
                        let take = Math.min(free, openSlots);
                        State.w[t] += take; free -= take;
                    }
                }
            }
        }
        UI.renderBuildMenu();
    },

    removeRandomWorker: function() {
        let assigned = Object.values(State.w).reduce((a,b)=>a+b,0);
        let free = State.pop.current - State.pop.soldiers - assigned;
        if(free > 0) return;
        for(let k in State.w) { if(State.w[k] > 0) { State.w[k]--; break; } }
        UI.renderBuildMenu();
    },

    handleMigration: function() {
        if(State.pop.happiness > 50 && State.pop.current < State.pop.max && Math.random() < 0.3) {
            State.pop.current++; UI.log("Neuer Siedler angekommen.", "success"); this.autoAssign();
        }
        if(State.pop.happiness < 20 && State.pop.current > 0) {
            this.removeRandomWorker(); State.pop.current--; State.pop.happiness = 30; UI.log("Ein B√ºrger ist geflohen!", "error");
        }
    },

    trade: function(action, type, amount) {
        // Base Prices
        const basePrice = { wood: 1, stone: 2, iron: 4, wheat: 1, flour: 2, bread: 3, meat: 2, apple: 1, hops: 2, beer: 5, weapons: 10 };
        let p = basePrice[type] || 1;
        
        let sellPrice = Math.floor(p * amount * 0.8); // 80% Wert
        let buyPrice = Math.ceil(p * amount * 1.5);   // 150% Wert (teuer!)

        if(action === 'sell') {
            if(State.res[type] >= amount) { State.res[type] -= amount; State.res.gold += sellPrice; UI.log(`${amount} ${type} verkauft (+${sellPrice}).`, "success"); } 
            else UI.log("Nicht genug Ware.");
        } else {
            if(State.res.gold >= buyPrice) { State.res.gold -= buyPrice; State.res[type] += amount; UI.log(`${amount} ${type} gekauft (-${buyPrice}).`, "success"); } 
            else UI.log("Zu wenig Gold.");
        }
        UI.updateMarket(); // Preise/Verf√ºgbarkeit updaten
        UI.update();
    },

    build: function(type) {
        let c = Config.buildings[type];
        if(State.res.gold >= c.costG && State.res.wood >= c.costW && State.res.stone >= c.costS) {
            State.res.gold -= c.costG; State.res.wood -= c.costW; State.res.stone -= c.costS;
            State.b[type]++;
            if(c.capacity) State.pop.max += c.capacity;
            
            if(type === 'cathedral') {
                State.paused = true;
                UI.showInfo("SIEG!", "Die Kathedrale steht! Ihr habt gewonnen!");
                UI.log("SPIEL GEWONNEN!", "win");
            }
            
            this.autoAssign();
            UI.update();
        } else UI.log("Zu wenig Ressourcen!", "error");
    },

    recruit: function(type) {
        if(type === 'regular') {
            if(State.b.barracks === 0) { UI.log("Kaserne fehlt!", "error"); return; }
            let assigned = Object.values(State.w).reduce((a,b)=>a+b,0);
            let free = State.pop.current - State.pop.soldiers - assigned;
            if(State.res.gold >= 10 && State.res.weapons >= 1 && free > 0) {
                State.res.gold -= 10; State.res.weapons--; State.pop.soldiers++;
                UI.log("Soldat rekrutiert.", "success");
            } else UI.log("Fehlt: Gold, Waffe oder Bauer.", "error");
        } 
        else if (type === 'mercenary') {
            if(State.b.merc_post === 0) { UI.log("S√∂ldnerlager fehlt!", "error"); return; }
            if(State.res.gold >= 50) {
                State.res.gold -= 50; State.pop.soldiers++;
                UI.log("S√∂ldner angeheuert!", "success");
            } else UI.log("Zu wenig Gold (50 ben√∂tigt).", "error");
        }
        UI.update();
    },

    setTax: function(d) {
        let n = State.taxIndex + d;
        if(n >= 0 && n < Config.taxes.length) { State.taxIndex = n; UI.update(); }
    },
    
    checkCombat: function() {
        if(State.day < Config.combatStartDay || State.pop.current === 0) return;
        if(Math.random() < 0.1) {
            State.paused = true; UI.showInfo("Angriff!", "Banditen!");
            const enemy = Math.floor(State.day * 1.5);
            const me = State.pop.soldiers * 12;
            if(me >= enemy) {
                UI.log("SIEG! Feind abgewehrt.", "success"); State.factors.events = 10;
            } else {
                UI.log("NIEDERLAGE! Gepl√ºndert.", "error");
                State.res.gold = Math.floor(State.res.gold/2); State.res.apple=0; State.res.meat=0; State.res.bread=0;
                State.factors.events = -15;
            }
        }
    }
};

const UI = {
    renderBuildMenu: function() {
        const el = document.getElementById('build-list'); el.innerHTML = "";
        
        const categories = ["Ressourcen", "Nahrung", "Wohnraum", "Verteidigung", "Kunst"];
        
        categories.forEach(cat => {
            // Header
            let h3 = document.createElement('h3');
            h3.className = "cat-title";
            h3.innerText = cat;
            el.appendChild(h3);

            for(let k in Config.buildings) {
                let b = Config.buildings[k];
                if(b.cat !== cat) continue;

                let cost = `${b.costG}üí∞`;
                if(b.costW) cost += ` ${b.costW}üå≤`;
                if(b.costS) cost += ` ${b.costS}üß±`;
                
                let workers = State.w[k] || 0;
                let max = State.b[k] || 0;
                let pillClass = (max > 0 && workers === max) ? "full" : (max > 0 ? "empty" : "");
                
                let pillText = `üë∑ ${workers}/${max}`;
                if(b.capacity > 0 || k === 'barracks' || k === 'merc_post' || k === 'church') pillText = `${max} Gebaut`;
                if(k === 'cathedral') pillText = max > 0 ? "GEBAUT" : "Im Bau";

                let div = document.createElement('div');
                div.className = "build-card";
                div.onclick = () => Game.build(k);
                div.innerHTML = `
                    <div class="build-info">
                        <span class="build-name">${b.name}</span>
                        <span class="build-cost">${cost}</span>
                    </div>
                    <div>${max > 0 ? `<div class="worker-pill ${pillClass}">${pillText}</div>` : ''}</div>
                `;
                el.appendChild(div);
            }
        });
    },

    toggleMarket: function(show) {
        document.getElementById('modal-market').style.display = show ? 'flex' : 'none';
        if(show) { State.paused = true; this.renderMarket(); }
        else { State.paused = false; State.lastTick = Date.now(); }
    },

    renderMarket: function() {
        const grid = document.getElementById('market-grid');
        grid.innerHTML = "";
        const items = [
            {id:'wood', n:'Holz', i:'üå≤'}, {id:'stone', n:'Stein', i:'üß±'}, {id:'iron', n:'Eisen', i:'‚õìÔ∏è'},
            {id:'wheat', n:'Weizen', i:'üåæ'}, {id:'flour', n:'Mehl', i:'ü•°'}, {id:'bread', n:'Brot', i:'üçû'},
            {id:'meat', n:'Fleisch', i:'ü•©'}, {id:'apple', n:'Apfel', i:'üçé'}, {id:'hops', n:'Hopfen', i:'üåø'},
            {id:'beer', n:'Bier', i:'üç∫'}, {id:'weapons', n:'Waffen', i:'‚öîÔ∏è'}
        ];

        items.forEach(it => {
            let div = document.createElement('div');
            div.className = "trade-item";
            div.innerHTML = `
                <span class="trade-icon">${it.i}</span>
                <div style="font-weight:bold; font-size:0.8rem; margin-bottom:5px;">${it.n}</div>
                <div style="font-size:0.75rem; margin-bottom:5px;">Lager: ${Math.floor(State.res[it.id])}</div>
                <div class="trade-actions">
                    <button class="trade-btn" onclick="Game.trade('buy', '${it.id}', 10)">Kaufen</button>
                    <button class="trade-btn" onclick="Game.trade('sell', '${it.id}', 10)">Verk.</button>
                </div>
            `;
            grid.appendChild(div);
        });
    },
    
    updateMarket: function() {
        if(document.getElementById('modal-market').style.display === 'flex') this.renderMarket();
    },

    update: function() {
        const s = State; const r = s.res;
        const set = (id, v) => { const e = document.getElementById(id); if(e) e.innerText = Math.floor(v); };
        
        set('res-gold', r.gold); set('res-wood', r.wood); set('res-stone', r.stone); set('res-iron', r.iron);
        set('res-bread', r.bread); set('res-meat', r.meat); set('res-apple', r.apple); set('res-wheat', r.wheat);
        set('res-flour', r.flour); set('res-hops', r.hops); set('res-beer', r.beer); set('res-weapon', r.weapons); set('res-soldier', s.pop.soldiers);
        
        const assigned = Object.values(s.w).reduce((a,b)=>a+b,0);
        const free = s.pop.current - s.pop.soldiers - assigned;
        set('res-idle', free);
        document.getElementById('res-housing').innerText = `${s.pop.current}/${s.pop.max}`;
        
        const popEl = document.getElementById('res-pop');
        popEl.innerText = s.pop.happiness;
        popEl.style.color = s.pop.happiness > 50 ? '#81c784' : '#e57373';
        
        let tt = "";
        if(s.factors.food !== 0) tt += `<div class="tooltip-row"><span>Essen:</span><span class="${s.factors.food>0?'val-pos':'val-neg'}">${s.factors.food}</span></div>`;
        if(s.factors.beer > 0) tt += `<div class="tooltip-row"><span>Bier:</span><span class="val-pos">+${s.factors.beer}</span></div>`;
        if(s.factors.religion > 0) tt += `<div class="tooltip-row"><span>Religion:</span><span class="val-pos">+${s.factors.religion}</span></div>`;
        tt += `<div class="tooltip-row"><span>Steuern:</span><span class="${s.factors.tax>=0?'val-pos':'val-neg'}">${s.factors.tax}</span></div>`;
        if(s.factors.events !== 0) tt += `<div class="tooltip-row"><span>Events:</span><span class="${s.factors.events>0?'val-pos':'val-neg'}">${s.factors.events}</span></div>`;
        
        document.getElementById('pop-details').innerHTML = tt || "Neutral";

        set('stat-day', s.day);
        document.getElementById('tax-display').innerText = Config.taxes[s.taxIndex].name;
        
        // Buttons
        const btnReg = document.getElementById('btn-recruit');
        const btnMerc = document.getElementById('btn-merc');
        
        if(State.b.barracks > 0) { btnReg.style.opacity=1; btnReg.style.cursor='pointer'; } 
        else { btnReg.style.opacity=0.5; btnReg.style.cursor='not-allowed'; }
        
        if(State.b.merc_post > 0) { btnMerc.style.opacity=1; btnMerc.style.cursor='pointer'; } 
        else { btnMerc.style.opacity=0.5; btnMerc.style.cursor='not-allowed'; }

        this.updatePreview();
    },

    updatePreview: function() {
        let html = "";
        const add = (t, v, g) => { if(v!==0) html += `<div class="preview-row"><span>${t}</span><span class="${g?'p-plus':'p-minus'}">${v>0?'+':''}${v}</span></div>`; };
        
        add("Holz", State.w.woodcutter*Config.buildings.woodcutter.amount, true);
        
        let cMill = Config.buildings.mill;
        let cBakery = Config.buildings.bakery;
        let millCap = State.w.mill * cMill.throughput;
        let wheatIn = Math.min(State.res.wheat, millCap);
        let flourOut = wheatIn * cMill.ratio;
        let bakeCap = State.w.bakery * cBakery.throughput;
        let flourIn = Math.min(State.res.flour + flourOut, bakeCap);
        let breadOut = flourIn * cBakery.ratio;
        
        let foodGain = (State.w.farm_apple*Config.buildings.farm_apple.amount) + (State.w.hunter*Config.buildings.hunter.amount) + breadOut;
        let foodNet = foodGain - State.pop.current;
        
        add("Nahrung (Netto)", foodNet, foodNet>=0);
        
        if(State.w.mill > 0 && State.res.wheat < 1) html += `<div style="color:orange;font-size:0.7rem">‚ö†Ô∏è Weizen fehlt</div>`;
        if(State.w.bakery > 0 && (State.res.flour + flourOut) < 1) html += `<div style="color:orange;font-size:0.7rem">‚ö†Ô∏è Mehl fehlt</div>`;
        
        document.getElementById('production-preview').innerHTML = html || "<span style='color:#999'>Keine Produktion</span>";
    },

    updateBar: function() {
        const pct = ((Date.now() - State.lastTick) / Config.tickRate) * 100;
        document.getElementById('day-bar').style.width = Math.min(pct, 100) + "%";
    },

    log: function(msg, type='') {
        const box = document.getElementById('center-log');
        const div = document.createElement('div');
        div.className = `log-entry ${type}`;
        div.innerHTML = `<strong>T${State.day}:</strong> ${msg}`;
        box.prepend(div);
    },
    showInfo: function(t, txt) {
        document.getElementById('info-title').innerText=t; document.getElementById('info-text').innerText=txt;
        document.getElementById('modal-info').style.display='flex';
    },
    closeInfo: function() { document.getElementById('modal-info').style.display='none'; State.paused=false; State.lastTick=Date.now(); }
};

Game.init();
</script>
</body>
</html>
