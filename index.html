<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Burgherr V2.0 - Reforged</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #121212; 
            --panel-bg: #e6dac3;
            --border: #3e2723;
            --highlight: #ffb300;
            --text: #271c19;
            --success: #2e7d32;
            --danger: #c62828;
            --accent: #d84315;
            --btn-bg: #d7ccc8;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Lato', sans-serif; background: var(--bg-body); color: #ddd; margin: 0; 
            height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- TICK BAR --- */
        #tick-container { height: 4px; background: #000; width: 100%; position: relative; z-index: 200; flex-shrink: 0; }
        #tick-bar { height: 100%; background: var(--highlight); width: 0%; transition: width 0.1s linear; }

        /* --- HEADER --- */
        header { 
            background: #1e1e1e; height: 85px; flex-shrink: 0; border-bottom: 3px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 10px; z-index: 100;
        }

        .header-title { font-family: 'MedievalSharp'; color: var(--highlight); line-height: 1; }
        .header-title h1 { margin: 0; font-size: 1.2rem; }
        .header-title span { font-size: 0.7rem; color: #888; }

        /* Resources Scroll */
        .res-container { display: flex; gap: 5px; flex: 1; justify-content: flex-end; overflow-x: auto; padding-bottom: 5px; margin-left: 10px; }
        .res-container::-webkit-scrollbar { display: none; } 

        .res-group { 
            background: #333; border: 1px solid #555; border-radius: 4px; padding: 3px 6px; 
            min-width: 60px; text-align: center; display: flex; flex-direction: column; justify-content: center; flex-shrink: 0;
        }
        
        .res-label { font-size: 0.5rem; text-transform: uppercase; color: #aaa; border-bottom: 1px solid #444; margin-bottom: 2px; }
        .res-values { display: flex; gap: 8px; justify-content: center; font-weight: bold; font-size: 0.8rem; color: #eee; }
        .res-item { position: relative; }
        
        .rate-ind { font-size: 0.6rem; position: absolute; top: -8px; right: -6px; font-weight: 900; text-shadow: 1px 1px 0 #000; }
        .rate-pos { color: #66bb6a; }
        .rate-neg { color: #ef5350; }

        /* --- MAIN LAYOUT --- */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }

        #map-area { 
            flex: 1; position: relative; overflow: hidden; padding: 8px;
            background-color: #0f1910;
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 6px;
        }
        
        .zone { 
            position: relative; border-radius: 6px; overflow: hidden; 
            box-shadow: inset 0 0 15px rgba(0,0,0,0.7); border: 2px solid rgba(255,255,255,0.05);
            transition: transform 0.1s; cursor: pointer;
        }
        .zone:active { transform: scale(0.98); border-color: rgba(255,255,255,0.3); }

        #z-forest { background: radial-gradient(circle at center, #2e7d32, #1b5e20); }
        #z-mount { background: linear-gradient(135deg, #5d4037, #3e2723); } 
        #z-town { background: radial-gradient(#d7ccc8, #8d6e63); border: 2px solid #5d4037; }
        #z-farm { background: radial-gradient(#8bc34a, #558b2f); }

        .zone-label { 
            position: absolute; bottom: 5px; left: 8px; 
            font-family: 'MedievalSharp'; font-size: 1rem; color: rgba(255,255,255,0.7); 
            text-shadow: 1px 1px 2px #000; pointer-events: none;
        }

        /* Sidebar */
        aside { 
            width: 280px; background: var(--panel-bg); border-left: 4px solid var(--border); 
            display: flex; flex-direction: column; color: var(--text); z-index: 50; flex-shrink: 0;
        }
        .log-box { 
            flex: 1; overflow-y: auto; padding: 5px; display: flex; flex-direction: column; gap: 3px; 
            background: rgba(0,0,0,0.05); font-size: 0.75rem; 
        }
        .log-entry { 
            background: #fff; padding: 3px 6px; border-radius: 3px; border-left: 3px solid #999; 
            animation: slideIn 0.2s; 
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
        .log-entry.bad { border-color: var(--danger); background: #ffebee; }
        .log-entry.good { border-color: var(--success); }

        .controls { padding: 10px; background: #bcaaa4; border-top: 2px solid var(--border); display: flex; flex-direction: column; gap: 5px; }
        
        .btn { 
            border: 1px solid var(--border); background: var(--btn-bg); 
            padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; color: var(--text);
            box-shadow: 0 2px 0 #8d6e63; position: relative;
        }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-red { background: #d32f2f; color: #fff; border-color: #b71c1c; box-shadow: 0 2px 0 #b71c1c; }

        /* --- FOOTER (BUILDING & WORKERS) --- */
        footer { 
            height: 160px; background: #d7ccc8; border-top: 4px solid var(--border); flex-shrink: 0;
            display: flex; flex-direction: column; z-index: 60;
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
        }
        
        .cat-bar { height: 35px; display: flex; border-bottom: 1px solid #a1887f; background: rgba(0,0,0,0.05); overflow-x: auto; }
        .cat-btn { flex: 1; min-width: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; border-right: 1px solid #a1887f; }
        .cat-btn.active { background: var(--highlight); color: #000; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }

        .build-bar { flex: 1; display: flex; gap: 8px; overflow-x: auto; padding: 8px; align-items: center; }
        
        /* CARD DESIGN */
        .card { 
            width: 90px; height: 100%; background: #efebe9; border: 1px solid #8d6e63; border-radius: 6px; 
            display: flex; flex-direction: column; flex-shrink: 0; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: 0.1s;
        }
        .card-head { 
            height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border-bottom: 1px dashed #ccc; cursor: pointer; position: relative;
        }
        .card-head:active { background: #e0e0e0; }
        .card-icon { font-size: 1.4rem; line-height: 1; }
        .card-name { font-size: 0.6rem; font-weight: bold; text-align: center; margin-top: 2px; }
        .lvl-badge { position: absolute; top: 2px; right: 2px; background: var(--border); color: #fff; font-size: 0.55rem; padding: 1px 4px; border-radius: 4px; }
        
        /* Worker Controls in Card */
        .card-workers { flex: 1; display: flex; align-items: center; justify-content: space-between; padding: 2px 4px; background: rgba(0,0,0,0.03); }
        .w-btn { 
            width: 20px; height: 20px; border: 1px solid #999; background: #fff; border-radius: 3px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold;
        }
        .w-val { font-size: 0.7rem; font-weight: bold; }
        
        .cost-pop {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: #fff; padding: 4px 8px; border-radius: 4px;
            font-size: 0.7rem; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 100; width: 120px; text-align: center;
        }
        .card:hover .cost-pop { opacity: 1; top: -45px; }

        /* Floating Text */
        .float-txt {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 1.2rem; font-weight: 900; pointer-events: none;
            animation: floatUp 1s forwards; text-shadow: 1px 1px 0 #000; z-index: 3000;
        }
        @keyframes floatUp { 100% { opacity: 0; transform: translate(-50%, -80px); } }

        /* Mobile Fixes */
        @media (max-width: 700px) {
            header { height: 70px; padding: 0 5px; }
            .header-title { display: none; }
            main { flex-direction: column; }
            #map-area { flex: 1.2; min-height: 30vh; }
            aside { width: 100%; height: auto; flex: 1; border-left: none; border-top: 4px solid var(--border); flex-direction: row; }
            .log-box { flex: 1; border-right: 2px solid var(--border); }
            .controls { width: 130px; justify-content: center; }
            footer { height: 180px; }
            .card { width: 100px; }
            .w-btn { width: 28px; height: 28px; } /* Bigger touch targets */
        }
        
        /* Modal */
        .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-win { background: var(--panel-bg); width: 90%; max-width: 400px; padding: 20px; border: 4px solid var(--border); border-radius: 8px; text-align: center; color: var(--text); box-shadow: 0 0 30px #000; }
    </style>
</head>
<body>

<div id="modal-mask" class="modal-mask">
    <div class="modal-win">
        <h2 id="m-title" style="font-family:'MedievalSharp'; margin-top:0">Willkommen</h2>
        <div id="m-body" style="margin-bottom:20px;"></div>
        <button onclick="UI.closeModal()" class="btn" style="width:100%; background:var(--highlight);">Weiter</button>
    </div>
</div>

<div id="tick-container"><div id="tick-bar"></div></div>

<header>
    <div class="header-title">
        <h1>Burgherr</h1>
        <span>Reforged</span>
    </div>

    <div class="res-container">
        <div class="res-group">
            <span class="res-label">Schatz</span>
            <div class="res-values">üí∞ <span id="r-gold">0</span></div>
        </div>
        
        <div class="res-group">
            <span class="res-label">Lager <span id="limit-store" style="font-weight:normal; opacity:0.7"></span></span>
            <div class="res-values">
                <span class="res-item" title="Holz">üå≤<span id="r-wood">0</span><span id="d-wood" class="rate-ind"></span></span>
                <span class="res-item" title="Stein">üß±<span id="r-stone">0</span><span id="d-stone" class="rate-ind"></span></span>
                <span class="res-item" title="Weizen">üåæ<span id="r-wheat">0</span><span id="d-wheat" class="rate-ind"></span></span>
                <span class="res-item" title="Mehl">ü•°<span id="r-flour">0</span><span id="d-flour" class="rate-ind"></span></span>
            </div>
        </div>

        <div class="res-group">
            <span class="res-label">Speise <span id="limit-food" style="font-weight:normal; opacity:0.7"></span></span>
            <div class="res-values">
                <span class="res-item" title="Brot">üçû<span id="r-bread">0</span><span id="d-bread" class="rate-ind"></span></span>
                <span class="res-item" title="√Ñpfel">üçé<span id="r-apple">0</span><span id="d-apple" class="rate-ind"></span></span>
            </div>
        </div>

        <div class="res-group" style="border-color: #8d6e63;">
            <span class="res-label">Volk</span>
            <div class="res-values">
                <span title="B√ºrger">üë®‚Äçüåæ <span id="pop-curr">0</span>/<span id="pop-max">0</span></span>
                <span title="Unt√§tig" style="color:var(--highlight)">üí§ <span id="pop-idle">0</span></span>
                <span title="Laune">‚ù§Ô∏è <span id="pop-hap">0</span></span>
            </div>
        </div>
    </div>
</header>

<main>
    <div id="map-area">
        <div class="zone" id="z-forest" onclick="Game.clickGather('wood', event)">
            <div class="zone-label">Forst</div>
        </div>
        <div class="zone" id="z-mount" onclick="Game.clickGather('stone', event)">
            <div class="zone-label">Gebirge</div>
        </div>
        <div class="zone" id="z-town">
            <div class="zone-label">Stadt</div>
        </div>
        <div class="zone" id="z-farm" onclick="Game.clickGather('apple', event)">
            <div class="zone-label">L√§ndereien</div>
        </div>
    </div>

    <aside>
        <div class="log-box" id="log"></div>
        <div class="controls">
            <div style="font-size:0.8rem; text-align:center;">
                Tag <span id="day-disp">1</span>
            </div>
            <button class="btn" onclick="Game.save()">üíæ Speichern</button>
            <button class="btn btn-red" onclick="Game.hardReset()">‚ò†Ô∏è Neustart</button>
        </div>
    </aside>
</main>

<footer>
    <div class="cat-bar">
        <div class="cat-btn active" onclick="UI.setCat('res')">üî®</div>
        <div class="cat-btn" onclick="UI.setCat('food')">üçé</div>
        <div class="cat-btn" onclick="UI.setCat('town')">üè†</div>
        </div>
    <div class="build-bar" id="build-list"></div>
</footer>

<script>
/* --- KONFIGURATION & DATEN --- */
const Config = {
    tick: 2000, // ms pro Tick
    b: {
        // RESSOURCEN
        woodcutter: { n:"Holzf√§ller", c:"res", i:"ü™ì", desc:"Hackt Holz", cost:{g:10}, prod:{wood:3}, cap:2 },
        quarry:     { n:"Steinbruch", c:"res", i:"‚õèÔ∏è", desc:"Baut Stein ab", cost:{g:50,w:50}, prod:{stone:2}, cap:3 },
        stock:      { n:"Lager",      c:"res", i:"üì¶", desc:"Platz +50", cost:{w:50}, passive:true, store:50 },
        
        // ESSEN
        orchard:    { n:"Obstgarten", c:"food", i:"üå≥", desc:"Erntet √Ñpfel", cost:{g:20,w:10}, prod:{apple:2}, cap:2 },
        farm:       { n:"Bauernhof",  c:"food", i:"üåæ", desc:"S√§t Weizen", cost:{g:50,w:30}, prod:{wheat:3}, cap:3 },
        mill:       { n:"M√ºhle",      c:"food", i:"‚öôÔ∏è", desc:"Weizen zu Mehl", cost:{g:100,w:50,s:20}, convert:{in:'wheat',out:'flour',ratio:1}, cap:2 },
        bakery:     { n:"B√§ckerei",   c:"food", i:"üçû", desc:"Mehl zu Brot", cost:{g:100,w:50,s:20}, convert:{in:'flour',out:'bread',ratio:3}, cap:3 },
        granary:    { n:"Kornspeicher", c:"food", i:"üõñ", desc:"Essen +50", cost:{w:30,s:10}, passive:true, foodStore:50 },

        // STADT
        tent:       { n:"Zelt",       c:"town", i:"‚õ∫", desc:"Pop +2", cost:{w:10}, passive:true, pop:2 },
        house:      { n:"Haus",       c:"town", i:"üè†", desc:"Pop +5", cost:{g:20,w:30,s:5}, passive:true, pop:5 },
        manor:      { n:"Herrenhaus", c:"town", i:"üè∞", desc:"Pop +10", cost:{g:200,w:100,s:50}, passive:true, pop:10 }
    }
};

/* --- STATE MANAGEMENT --- */
let S = {
    day: 1,
    res: { gold:50, wood:0, stone:0, wheat:0, flour:0, bread:10, apple:10 },
    b: {}, // Geb√§ude Anzahl
    w: {}, // Zugewiesene Arbeiter
    pop: { curr: 3, hap: 100 },
    rates: {} // Letzte Netto-Raten f√ºr UI
};

let tickInterval;
let lastTick = Date.now();

/* --- LOGIK CORE --- */
const Game = {
    init: function() {
        this.load();
        UI.init();
        tickInterval = setInterval(this.tick, Config.tick);
        requestAnimationFrame(UI.animTick);
        
        if(S.day === 1) UI.modal("Willkommen Burgherr", "Dein Volk erwartet Befehle. Weise Arbeiter zu (unten im Men√º), um die Wirtschaft anzukurbeln. Klicke auf die Karte f√ºr erste Rohstoffe.");
    },

    tick: function() {
        S.day++;
        lastTick = Date.now();
        
        // 1. Reset Rates
        let d = {}; // Delta
        for(let k in S.res) d[k] = 0;
        
        // 2. Kapazit√§ten berechnen
        let maxStore = 50 + ((S.b.stock||0)*50);
        let maxFood = 50 + ((S.b.granary||0)*50);
        let popCap = 3 + ((S.b.tent||0)*2) + ((S.b.house||0)*5) + ((S.b.manor||0)*10);

        // 3. Produktion durch Geb√§ude
        for(let k in Config.b) {
            let b = Config.b[k];
            let count = S.b[k] || 0;
            let workers = S.w[k] || 0;
            
            if(count > 0 && workers > 0) {
                // Einfache Produktion
                if(b.prod) {
                    for(let rKey in b.prod) {
                        d[rKey] += (workers * b.prod[rKey]);
                    }
                }
                // Umwandlung (Konverter)
                if(b.convert) {
                    let needed = workers; // 1 Worker verarbeitet 1 Item pro Tick
                    let avail = S.res[b.convert.in] + d[b.convert.in]; // Verf√ºgbar (inkl. aktueller Prod)
                    
                    let actualWork = Math.min(needed, Math.max(0, avail));
                    
                    if(actualWork < needed) UI.log(`Zu wenig ${b.convert.in} f√ºr ${b.n}`, 'bad');
                    
                    d[b.convert.in] -= actualWork;
                    d[b.convert.out] += (actualWork * b.convert.ratio);
                }
            }
        }

        // 4. Konsum (Essen)
        let hungry = S.pop.curr;
        let ate = 0;
        // Priorit√§t: √Ñpfel -> Brot
        ['apple','bread'].forEach(f => {
            if(hungry > 0) {
                let avail = S.res[f] + d[f]; // Verf√ºgbar nach Produktion
                let take = Math.min(hungry, Math.max(0, avail));
                d[f] -= take;
                hungry -= take;
                ate += take;
            }
        });

        // 5. Ergebnisse anwenden & Limits
        // Happiness
        if(hungry > 0) {
            S.pop.hap = Math.max(0, S.pop.hap - 5);
            UI.log(`${hungry} hungern!`, 'bad');
        } else {
            if(S.pop.hap < 100) S.pop.hap++;
        }

        // Bev√∂lkerungswachstum / Tod
        if(hungry > 2 && Math.random() < 0.2) {
            S.pop.curr--; 
            Game.unassignRandom();
            UI.log("Ein B√ºrger ist verhungert", 'bad');
        } else if(S.pop.hap > 80 && S.pop.curr < popCap && Math.random() < 0.3) {
            S.pop.curr++;
            UI.log("Ein neuer B√ºrger ist geboren", 'good');
        }

        // Ressourcen addieren mit Hard Caps
        for(let k in d) {
            let old = S.res[k];
            let val = old + d[k];
            
            // Cap Check
            let isFood = ['apple','bread','wheat','flour'].includes(k);
            let limit = isFood ? maxFood : maxStore;
            if(k === 'gold') limit = 99999;
            
            if(val > limit) val = limit;
            if(val < 0) val = 0;
            
            S.res[k] = val;
            S.rates[k] = val - old; // Wahre Rate speichern
        }

        S.pop.max = popCap;
        UI.update();
    },

    // Helfer: Zieht Arbeiter ab, wenn einer stirbt
    unassignRandom: function() {
        for(let k in S.w) {
            if(S.w[k] > 0) { S.w[k]--; break; }
        }
    },

    // Klick auf Karte
    clickGather: function(res, e) {
        S.res[res] = (S.res[res]||0) + 1;
        UI.floatText(e.clientX, e.clientY, "+1");
        UI.update();
    },

    // Bauen
    build: function(key) {
        let b = Config.b[key];
        // Check Cost
        if(!Game.canAfford(b.cost)) return;
        
        // Pay
        for(let c in b.cost) S.res[{g:'gold',w:'wood',s:'stone'}[c]] -= b.cost[c];
        
        S.b[key] = (S.b[key]||0) + 1;
        UI.update();
        UI.renderBuild(); // Re-render card for new limits
    },

    // Arbeiter zuweisen
    assign: function(key, delta) {
        if(!S.b[key]) return;
        let b = Config.b[key];
        let maxSlots = S.b[key] * (b.cap || 0);
        let curr = S.w[key] || 0;

        if(delta > 0) {
            // Hinzuf√ºgen
            let busy = 0; for(let k in S.w) busy += S.w[k];
            let idle = S.pop.curr - busy;
            if(idle > 0 && curr < maxSlots) {
                S.w[key] = curr + 1;
            }
        } else {
            // Entfernen
            if(curr > 0) {
                S.w[key] = curr - 1;
            }
        }
        UI.update();
        UI.updateCards(); // Refresh buttons
    },

    canAfford: function(cost) {
        if(!cost) return true;
        if(cost.g && S.res.gold < cost.g) return false;
        if(cost.w && S.res.wood < cost.w) return false;
        if(cost.s && S.res.stone < cost.s) return false;
        return true;
    },

    save: function() {
        localStorage.setItem('burgherr_v2', JSON.stringify(S));
        UI.log("Spiel gespeichert");
    },
    load: function() {
        let d = localStorage.getItem('burgherr_v2');
        if(d) {
            try {
                let saved = JSON.parse(d);
                // Merge save with default structure to avoid crashes on updates
                S = { ...S, ...saved, res: { ...S.res, ...saved.res } };
            } catch(e) { console.error("Save corrupted"); }
        }
    },
    hardReset: function() {
        if(confirm("Wirklich alles l√∂schen?")) {
            localStorage.removeItem('burgherr_v2');
            location.reload();
        }
    }
};

/* --- UI MANAGER --- */
const UI = {
    cat: 'res',
    
    init: function() {
        this.renderBuild();
        this.update();
    },

    animTick: function() {
        let now = Date.now();
        let diff = now - lastTick;
        let pct = Math.min(100, (diff / Config.tick) * 100);
        document.getElementById('tick-bar').style.width = pct + "%";
        requestAnimationFrame(UI.animTick);
    },

    update: function() {
        // Resources
        for(let k in S.res) {
            let el = document.getElementById('r-'+k);
            if(el) el.innerText = Math.floor(S.res[k]);
            
            let rateEl = document.getElementById('d-'+k);
            if(rateEl) {
                let r = S.rates[k] || 0;
                rateEl.innerText = r > 0 ? '+'+r : (r<0 ? r : '');
                rateEl.className = 'rate-ind ' + (r>=0 ? 'rate-pos' : 'rate-neg');
            }
        }

        // Pop
        let busy = 0; for(let k in S.w) busy += S.w[k];
        let idle = S.pop.curr - busy;
        document.getElementById('pop-curr').innerText = S.pop.curr;
        document.getElementById('pop-max').innerText = S.pop.max;
        document.getElementById('pop-idle').innerText = idle;
        document.getElementById('pop-hap').innerText = S.pop.hap;
        document.getElementById('day-disp').innerText = S.day;

        // Limits Display
        let maxStore = 50 + ((S.b.stock||0)*50);
        let maxFood = 50 + ((S.b.granary||0)*50);
        document.getElementById('limit-store').innerText = "(Max: "+maxStore+")";
        document.getElementById('limit-food').innerText = "(Max: "+maxFood+")";

        this.updateCards();
    },

    setCat: function(c) {
        this.cat = c;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if(event && event.currentTarget) event.currentTarget.classList.add('active');
        this.renderBuild();
    },

    renderBuild: function() {
        const list = document.getElementById('build-list');
        list.innerHTML = "";
        
        for(let k in Config.b) {
            let b = Config.b[k];
            if(b.c !== this.cat) continue;

            let card = document.createElement('div');
            card.className = "card";
            card.id = "card-"+k;
            
            // Tooltip Cost Construction
            let costs = [];
            if(b.cost.g) costs.push(b.cost.g + " Gold");
            if(b.cost.w) costs.push(b.cost.w + " Holz");
            if(b.cost.s) costs.push(b.cost.s + " Stein");

            // Worker Controls (nur wenn kein Passivgeb√§ude)
            let workerHtml = "";
            if(!b.passive) {
                workerHtml = `
                    <div class="card-workers">
                        <div class="w-btn" onclick="Game.assign('${k}', -1)">-</div>
                        <div class="w-val"><span id="w-${k}">0</span>/<span id="cap-${k}">0</span></div>
                        <div class="w-btn" onclick="Game.assign('${k}', 1)">+</div>
                    </div>
                `;
            } else {
                workerHtml = `<div class="card-workers" style="justify-content:center; color:#777; font-size:0.6rem;">Passiv</div>`;
            }

            card.innerHTML = `
                <div class="cost-pop">${costs.join(', ')}</div>
                <div class="lvl-badge" id="lvl-${k}">0</div>
                <div class="card-head" onclick="Game.build('${k}')">
                    <div class="card-icon">${b.i}</div>
                    <div class="card-name">${b.n}</div>
                </div>
                ${workerHtml}
            `;
            list.appendChild(card);
        }
        this.updateCards();
    },

    updateCards: function() {
        for(let k in Config.b) {
            let b = Config.b[k];
            if(b.c !== this.cat) continue;
            
            // Update Level
            let lvlEl = document.getElementById('lvl-'+k);
            if(lvlEl) lvlEl.innerText = S.b[k] || 0;

            // Update Workers
            if(!b.passive) {
                let wEl = document.getElementById('w-'+k);
                let capEl = document.getElementById('cap-'+k);
                if(wEl) wEl.innerText = S.w[k] || 0;
                if(capEl) capEl.innerText = (S.b[k]||0) * b.cap;
            }

            // Visual Feedback Cost
            let card = document.getElementById('card-'+k);
            if(card) {
                if(Game.canAfford(b.cost)) card.style.opacity = "1";
                else card.style.opacity = "0.6";
            }
        }
    },

    log: function(msg, type) {
        let div = document.createElement('div');
        div.className = `log-entry ${type||''}`;
        div.innerText = `Tag ${S.day}: ${msg}`;
        let box = document.getElementById('log');
        box.prepend(div);
        if(box.childNodes.length > 20) box.removeChild(box.lastChild);
    },

    floatText: function(x, y, txt) {
        let el = document.createElement('div');
        el.className = 'float-txt';
        el.innerText = txt;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    },

    modal: function(title, txt) {
        document.getElementById('m-title').innerText = title;
        document.getElementById('m-body').innerText = txt;
        document.getElementById('modal-mask').style.display = 'flex';
    },
    closeModal: function() {
        document.getElementById('modal-mask').style.display = 'none';
    }
};

// Start
Game.init();

</script>
</body>
</html>
