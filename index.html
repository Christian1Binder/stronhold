<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burgherr WebApp - Stronghold Style Pop</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #2b2b2b;
            --bg-panel: #fdf6e3;
            --primary: #8b5e3c;
            --primary-dark: #5d4037;
            --secondary: #37474f;
            --accent: #d32f2f;
            --positive: #2e7d32;
            --highlight: #f9a825;
            --text-main: #333333;
            --text-light: #f1f1f1;
            --border-radius: 8px;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            height: 100vh;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        #app {
            background-color: var(--bg-panel);
            width: 100%;
            max-width: 1400px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- HEADER --- */
        header {
            background-color: var(--secondary);
            color: var(--text-light);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 4px solid var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 10;
            height: 110px;
        }

        .header-left { display: flex; flex-direction: column; }
        .header-left h1 {
            font-family: 'MedievalSharp', cursive;
            margin: 0;
            font-size: 1.5rem;
            color: var(--highlight);
            text-shadow: 2px 2px 0 #000;
        }

        #villager-chatter {
            background: #fff;
            color: #333;
            padding: 8px 15px;
            border-radius: 15px;
            border-bottom-left-radius: 0;
            font-style: italic;
            font-size: 0.9rem;
            max-width: 250px;
            position: relative;
            margin-top: 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            opacity: 0; transition: opacity 0.5s;
        }

        .res-container { display: flex; gap: 10px; flex: 1; justify-content: flex-end; }
        .res-group {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px; padding: 5px 8px; display: flex; flex-direction: column; min-width: 120px;
        }
        .res-items { display: flex; justify-content: space-around; align-items: center; gap: 8px; }
        .res-item { display: flex; flex-direction: column; align-items: center; position: relative; cursor: help; }
        .res-icon { font-size: 1.2rem; }
        .res-val { font-weight: 900; font-size: 1rem; color: #fff; }
        .gold-val { color: var(--highlight); }

        /* TOOLTIP F√úR POPULARIT√ÑT (Das Herzst√ºck dieser √Ñnderung) */
        .pop-tooltip-container { position: relative; }
        
        .pop-tooltip {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 100;
            top: 100%;
            left: 50%; /* Zentrieren */
            transform: translateX(-50%); /* Zentrieren */
            margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.2s;
            border: 1px solid #555;
        }
        
        /* Der kleine Pfeil oben am Tooltip */
        .pop-tooltip::after {
            content: ""; position: absolute; bottom: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: transparent transparent #333 transparent;
        }

        .pop-tooltip-container:hover .pop-tooltip { visibility: visible; opacity: 1; }

        .tooltip-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .tooltip-row:last-child { border-bottom: none; margin-bottom: 0; font-weight: bold; padding-top: 5px; border-top: 1px solid #777; }
        .val-pos { color: #81c784; }
        .val-neg { color: #e57373; }
        .val-neu { color: #ccc; }

        /* --- MAIN --- */
        main { display: flex; flex: 1; overflow: hidden; }

        aside {
            width: 320px; background-color: #f4ecd8; padding: 15px;
            overflow-y: auto; border-right: 1px solid #dccbb1; display: flex; flex-direction: column; gap: 15px;
        }
        aside.right { border-right: none; border-left: 1px solid #dccbb1; }

        h2 { font-family: 'MedievalSharp', cursive; color: var(--primary-dark); border-bottom: 2px solid var(--primary); font-size: 1.2rem; margin: 0 0 5px 0; }

        /* CLICKER */
        .clicker-area { display: flex; gap: 10px; margin-bottom: 5px; }
        .clicker-btn {
            flex: 1; background: #fff; border: 2px solid var(--primary);
            border-radius: 8px; padding: 10px 5px; text-align: center;
            cursor: pointer; box-shadow: 0 3px 0 var(--primary-dark);
        }
        .clicker-btn:active { transform: translateY(3px); box-shadow: none; }
        .clicker-icon { font-size: 1.4rem; display: block; }
        .clicker-label { font-size: 0.75rem; font-weight: bold; color: var(--primary-dark); }

        /* BUTTONS */
        .btn-group { display: flex; flex-direction: column; gap: 6px; }
        button.build-btn {
            background-color: #fff; border: 1px solid #cbb092;
            border-left: 4px solid var(--primary); padding: 8px 10px;
            border-radius: 4px; font-family: 'Lato', sans-serif; font-weight: 700;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.1s;
        }
        button.build-btn:hover:not(:disabled) { background-color: var(--primary); color: white; transform: translateX(3px); }
        button.build-btn:disabled { opacity: 0.5; background: #eee; cursor: not-allowed; }
        .cost { font-size: 0.7rem; font-weight: normal; opacity: 0.8; }

        /* Steuer Buttons */
        .tax-controls { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        .tax-btn { width: 30px; height: 30px; background: var(--secondary); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .tax-display { font-weight: bold; }

        /* LOG */
        #log-area {
            flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px;
            background-image: radial-gradient(#f4e4bc 10%, transparent 10%), radial-gradient(#f4e4bc 10%, transparent 10%);
            background-size: 20px 20px; background-color: #ffffff;
        }
        .log-entry { padding: 8px 12px; border-radius: 5px; font-size: 0.9rem; border-left: 3px solid #ccc; background: #fcfcfc; }
        .log-entry.combat { border-left-color: var(--accent); background-color: #ffebee; color: #b71c1c; font-weight: bold;}
        .log-entry.important { border-left-color: var(--highlight); background-color: #fffde7; }

        /* FLOATING TEXT */
        .floating-text {
            position: absolute; font-weight: bold; font-size: 1.2rem; pointer-events: none;
            animation: floatUp 1s ease-out forwards; z-index: 1000; text-shadow: 1px 1px 0 #fff;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }

        /* BARS & STATUS */
        .progress-wrapper { margin-bottom: 15px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: bold; }
        .progress-bg { width: 100%; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; margin-top: 2px;}
        .progress-fill { height: 100%; width: 0%; transition: width 0.1s linear; }
        #bar-day { background-color: #2e7d32; }
        #bar-migration { background-color: #1976d2; }
        
        .efficiency-display { font-weight: bold; color: #2e7d32; }
        .efficiency-display.low { color: var(--accent); }

        /* MODAL */
        #modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 200;
        }
        #modal-box {
            background: #fdf6e3; width: 450px; padding: 25px;
            border: 3px solid var(--primary); border-radius: 10px; text-align: center;
        }
        #modal-title { font-family: 'MedievalSharp'; font-size: 1.8rem; color: var(--accent); margin-bottom: 10px; }

    </style>
</head>
<body>

<div id="particles"></div>
<div id="modal-overlay">
    <div id="modal-box">
        <div id="modal-title">Nachricht</div>
        <div id="modal-text">Text</div>
        <button onclick="UI.closeModal()" style="margin-top:20px; padding:8px 20px; font-weight:bold;">Verstanden</button>
    </div>
</div>

<div id="app">
    <header>
        <div class="header-left">
            <h1>üè∞ Der Burgherr</h1>
            <div id="villager-chatter">"Mylord..."</div>
        </div>
        
        <div class="res-container">
            <div class="res-group">
                <div class="res-items">
                    <div class="res-item" title="Gold"><span class="res-icon">üí∞</span><span class="res-val gold-val" id="res-gold">0</span></div>
                    <div class="res-item" title="Holz"><span class="res-icon">üå≤</span><span class="res-val" id="res-wood">0</span></div>
                    <div class="res-item" title="Stein"><span class="res-icon">üß±</span><span class="res-val" id="res-stone">0</span></div>
                    <div class="res-item" title="Eisen"><span class="res-icon">‚õìÔ∏è</span><span class="res-val" id="res-iron">0</span></div>
                </div>
            </div>
            <div class="res-group">
                <div class="res-items">
                    <div class="res-item" title="Brot"><span class="res-icon">üçû</span><span class="res-val" id="res-bread">0</span></div>
                    <div class="res-item" title="Fleisch"><span class="res-icon">ü•©</span><span class="res-val" id="res-meat">0</span></div>
                    <div class="res-item" title="√Ñpfel"><span class="res-icon">üçé</span><span class="res-val" id="res-apple">0</span></div>
                </div>
            </div>
            
            <div class="res-group pop-tooltip-container">
                <div class="res-items">
                    <div class="res-item" title="Soldaten"><span class="res-icon">üõ°Ô∏è</span><span class="res-val" id="res-soldier">0</span></div>
                    <div class="res-item">
                        <span class="res-icon">‚ù§Ô∏è</span>
                        <span class="res-val" id="res-pop" style="color:#81c784">0</span>
                    </div>
                </div>
                <div class="pop-tooltip" id="pop-details">
                    <div class="tooltip-row"><span>Wird geladen...</span></div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <aside>
            <h2>Manuelle Arbeit</h2>
            <div class="clicker-area">
                <div class="clicker-btn" onclick="Game.manualGather('wood', event)">
                    <span class="clicker-icon">üå≤</span>
                    <span class="clicker-label">Holz hacken</span>
                </div>
                <div class="clicker-btn" onclick="Game.manualGather('food', event)">
                    <span class="clicker-icon">üçé</span>
                    <span class="clicker-label">Sammeln</span>
                </div>
            </div>

            <h2>Bauwesen</h2>
            <div class="btn-group">
                <button class="build-btn" onclick="Game.build('woodcutter')">Holzf√§ller <span class="cost">15üí∞</span></button>
                <button class="build-btn" onclick="Game.build('quarry')">Steinbruch <span class="cost">50üí∞ 20üå≤</span></button>
                <button class="build-btn" onclick="Game.build('ironmine')">Eisenmine <span class="cost">100üí∞ 50üå≤</span></button>
                <button class="build-btn" onclick="Game.build('house')">H√ºtte <span class="cost">10üå≤</span></button>
            </div>

            <h2>Nahrung</h2>
            <div class="btn-group">
                <button class="build-btn" onclick="Game.build('farm_apple')">Apfelgarten <span class="cost">30üí∞ 10üå≤</span></button>
                <button class="build-btn" onclick="Game.build('hunter')">J√§gerstand <span class="cost">20üí∞ 5üå≤</span></button>
                <button class="build-btn" onclick="Game.build('farm_wheat')">Getreidefarm <span class="cost">40üí∞ 10üå≤</span></button>
                <button class="build-btn" onclick="Game.build('mill')">M√ºhle <span class="cost">80üí∞ 30üå≤</span></button>
                <button class="build-btn" onclick="Game.build('bakery')">B√§ckerei <span class="cost">60üí∞ 20üå≤</span></button>
            </div>
        </aside>

        <section id="log-area"></section>

        <aside class="right">
            <h2>Milit√§r</h2>
            <div class="btn-group">
                <button class="build-btn" onclick="Game.build('weaponsmith')">Schmiede <span class="cost">100üí∞ 20üß±</span></button>
                <button class="build-btn" onclick="Game.build('barracks')">Kaserne <span class="cost">150üí∞ 50üß±</span></button>
                <button class="build-btn" onclick="Game.recruit()">Soldat <span class="cost">10üí∞ 1‚öîÔ∏è</span></button>
            </div>
            
            <br>
            <h2>Verwaltung</h2>
            <div style="margin-bottom:5px; font-size:0.9rem;">Steuern einstellen:</div>
            <div class="tax-controls">
                <button class="tax-btn" onclick="Game.setTax(-1)">-</button>
                <span class="tax-display" id="display-tax">Keine Steuern</span>
                <button class="tax-btn" onclick="Game.setTax(1)">+</button>
            </div>

            <br>
            <h2>Status & Wirtschaft</h2>
            <div style="font-size:0.9rem">
                <strong>Tag:</strong> <span id="stat-day">1</span><br>
                <strong>Bev√∂lkerung:</strong> <span id="stat-pop">0/0</span><br>
                <strong>Arbeitskraft:</strong> <span id="stat-workers" class="efficiency-display">100%</span>
            </div>

            <br>
            <div class="progress-wrapper">
                <div class="progress-label"><span>Produktion (Tag)</span><span>5s</span></div>
                <div class="progress-bg"><div class="progress-fill" id="bar-day"></div></div>
            </div>
            <div class="progress-wrapper">
                <div class="progress-label"><span>Zuzug</span><span id="text-migration">0%</span></div>
                <div class="progress-bg"><div class="progress-fill" id="bar-migration" style="width: 0%"></div></div>
            </div>
        </aside>
    </main>
</div>

<script>
const Config = {
    tickRate: 5000, 
    combatStartDay: 40, 
    buildings: {
        woodcutter: { costG: 15, costW: 0, costS: 0, name: "Holzf√§ller" },
        quarry:     { costG: 50, costW: 20, costS: 0, name: "Steinbruch" },
        ironmine:   { costG: 100, costW: 50, costS: 0, name: "Eisenmine" },
        house:      { costG: 0, costW: 10, costS: 0, capacity: 5, name: "H√ºtte" },
        farm_apple: { costG: 30, costW: 10, costS: 0, name: "Apfelgarten" },
        hunter:     { costG: 20, costW: 5, costS: 0, name: "J√§gerstand" },
        farm_wheat: { costG: 40, costW: 10, costS: 0, name: "Getreidefarm" },
        mill:       { costG: 80, costW: 30, costS: 10, name: "M√ºhle" },
        bakery:     { costG: 60, costW: 20, costS: 0, name: "B√§ckerei" },
        weaponsmith:{ costG: 100, costW: 0, costS: 20, name: "Waffenschmiede" },
        barracks:   { costG: 150, costW: 0, costS: 50, name: "Kaserne" }
    },
    taxes: [
        { name: "Gro√üz√ºgige Bestechung", gold: -4, pop: +10 },
        { name: "Kleine Bestechung", gold: -2, pop: +5 },
        { name: "Keine Steuern", gold: 0, pop: +1 }, // +1 Basis-Moral
        { name: "Niedrige Steuern", gold: 2, pop: -2 },
        { name: "Hohe Steuern", gold: 4, pop: -6 },
        { name: "Grausame Steuern", gold: 8, pop: -15 }
    ]
};

const State = {
    day: 1, paused: false, lastTick: Date.now(),
    gold: 150, wood: 50, stone: 0, iron: 0,
    wheat: 0, flour: 0, bread: 0, meat: 5, apple: 5,
    weapons: 0, soldiers: 0,
    population: 5, maxPop: 10, popularity: 100, 
    taxIndex: 2, 
    
    migrationProgress: 0,
    b: { woodcutter: 0, quarry: 0, ironmine: 0, house: 0, farm_apple: 0, hunter: 0, farm_wheat: 0, mill: 0, bakery: 0, weaponsmith: 0, barracks: 0 },
    
    // NEU: Wir speichern die letzte √Ñnderung f√ºr das Tooltip
    factors: { food: 0, tax: 0, events: 0 },
    
    flags: { seenCombat: false, seenStarvation: false, seenNoWorkers: false }
};

const Phrases = {
    happy: ["Das Volk liebt Euch!", "Eure Gnaden sind weise.", "Die Speicher sind voll!"],
    neutral: ["Noch mehr Arbeit?", "Es geht uns gut.", "Wir brauchen Holz."],
    angry: ["Die Steuern erdr√ºcken uns!", "Wir haben Hunger!", "Schluss mit der Tyrannei!"],
    empty: ["Es ist so still...", "Wo sind alle hin?", "Geisterstadt..."]
};

const Game = {
    init: function() {
        UI.log("Sire! Fahrt mit der Maus √ºber das ‚ù§Ô∏è-Symbol um Details zur Beliebtheit zu sehen.", "important");
        UI.update();
        setInterval(() => { if(!State.paused) this.tick(); }, Config.tickRate);
        setInterval(() => { if(!State.paused) UI.updateBars(); }, 100);
        setInterval(() => { if(!State.paused) this.updateChatter(); }, 8000);
    },

    manualGather: function(type, event) {
        if(State.paused) return;
        if(type === 'wood') {
            State.wood += 1; UI.showFloaty(event.clientX, event.clientY, "+1üå≤", "#8d6e63");
        } else if(type === 'food') {
            State.apple += 1; UI.showFloaty(event.clientX, event.clientY, "+1üçé", "#ef5350");
        }
        UI.update();
    },

    tick: function() {
        State.day++;
        State.lastTick = Date.now();
        
        // Reset Faktoren
        State.factors.food = 0;
        State.factors.tax = 0;
        State.factors.events = 0;

        // 1. Jobs & Effizienz
        const jobs = State.b.woodcutter + State.b.quarry + State.b.ironmine + 
                     State.b.farm_apple + State.b.hunter + State.b.farm_wheat + 
                     State.b.mill + State.b.bakery + State.b.weaponsmith;
        
        const peasants = Math.max(0, State.population - State.soldiers);
        
        let efficiency = 1.0;
        if (jobs > 0) {
            if (peasants === 0) efficiency = 0;
            else if (peasants < jobs) efficiency = peasants / jobs;
        }

        // 2. Produktion
        const prod = (base) => base * efficiency;
        State.wood += prod(State.b.woodcutter * 2);
        State.stone += prod(State.b.quarry * 1);
        State.iron += prod(State.b.ironmine * 1);
        State.apple += prod(State.b.farm_apple * 3);
        State.meat += prod(State.b.hunter * 2);
        State.wheat += prod(State.b.farm_wheat * 2);

        // Verarbeitung
        let millCap = prod(State.b.mill * 2); 
        let wheatProc = Math.min(State.wheat, millCap);
        State.wheat -= wheatProc; State.flour += (wheatProc * 2);

        let bakeCap = prod(State.b.bakery * 2);
        let flourProc = Math.min(State.flour, bakeCap);
        State.flour -= flourProc; State.bread += (flourProc * 3);

        let smithCap = prod(State.b.weaponsmith);
        let ironProc = Math.min(State.iron, smithCap);
        State.iron -= ironProc; State.weapons += ironProc;

        // 3. Steuern
        const taxInfo = Config.taxes[State.taxIndex];
        if (State.population > 0) {
            State.gold += (State.population * taxInfo.gold);
            State.factors.tax = taxInfo.pop; // Faktor speichern
        }

        // 4. Konsum & Nahrungsbonus
        this.handleConsumption();

        // 5. Gesamtrechnung
        const totalChange = State.factors.food + State.factors.tax + State.factors.events;
        State.popularity += totalChange;

        // Limits
        if(State.popularity > 100) State.popularity = 100;
        if(State.popularity < 0) State.popularity = 0;

        // Checks
        this.checkCombat();
        this.handleMigration();

        UI.update(efficiency, jobs, peasants);
    },

    handleConsumption: function() {
        if(State.population === 0) return;

        let needed = State.population;
        let foodTypesEaten = 0; // Vielfalt!
        
        const eat = (type) => {
            if (State[type] > 0) {
                let take = Math.min(State[type], needed);
                State[type] -= take;
                needed -= take;
                // Wenn wir von diesem Typ was gegessen haben, z√§hlt es zur Vielfalt
                if (take > 0) foodTypesEaten++;
            }
        };

        eat('bread'); eat('meat'); eat('apple');

        if (needed > 0) {
            // Hungerstrafe
            State.factors.food = -20;
            if(!State.flags.seenStarvation) {
                UI.showModal("Hungersnot", "Sire, das Volk hungert! -20 Beliebtheit.");
                State.flags.seenStarvation = true;
            }
        } else {
            // SATT!
            // Basis: Jeder bekommt +1 weil satt.
            // Bonus: +1 f√ºr jeden ZUS√ÑTZLICHEN Typ (Stronghold Logik: "Vielfalt")
            // Wenn 1 Typ gegessen: +0 Bonus (Basis Moral ist in Steuern enthalten oder neutral)
            // Sagen wir: Faktor = Anzahl Typen.
            // 1 Typ = +1. 2 Typen = +2. 3 Typen = +3.
            State.factors.food = foodTypesEaten;
        }
    },

    handleMigration: function() {
        // Migration nur wenn Beliebtheit >= 50
        let growth = 0;
        if(State.popularity >= 50) {
            growth = (State.popularity - 40) * 0.5;
        } else {
            State.migrationProgress = 0;
        }
        
        if(State.population < State.maxPop && growth > 0) {
            State.migrationProgress += growth;
            if(State.migrationProgress >= 100) {
                State.population++;
                State.migrationProgress = 0;
                UI.log("Ein neuer Siedler ist eingezogen.", "important");
                const rect = document.getElementById('res-pop').getBoundingClientRect();
                UI.showFloaty(rect.left, rect.top, "+1üòä", "#81c784");
            }
        }

        if(State.popularity < 30 && State.population > 0) {
            if(Math.random() < 0.3) {
                State.population--;
                State.popularity = 40; 
                UI.log("Ein B√ºrger verl√§sst uns.", "combat");
            }
        }
    },

    checkCombat: function() {
        if(State.day < Config.combatStartDay || State.population === 0) return;

        if(Math.random() < 0.1) {
            State.paused = true;
            UI.showModal("Angriff!", "Banditen greifen an!");

            const enemyStr = Math.floor(State.day * 1.5);
            const myStr = State.soldiers * 12;
            
            UI.log(`Kampf! Feind: ${enemyStr} vs Wir: ${myStr}`, "combat");
            
            if (myStr >= enemyStr) {
                UI.log("Sieg! Die Ehre ist unser.", "important");
                // Sieg gibt kurzfristig Moral
                State.factors.events = 5; 
                State.popularity += 5; // Direkt-Bonus
            } else {
                UI.log("Niederlage! Unsere Lager sind leer.", "combat");
                State.gold = Math.floor(State.gold / 2);
                State.apple = 0; State.meat = 0; State.bread = 0;
                // Niederlage tut weh
                State.factors.events = -10;
                State.popularity -= 10;
                if(State.soldiers > 0) State.soldiers--;
            }
        }
    },

    setTax: function(dir) {
        let newIndex = State.taxIndex + dir;
        if (newIndex >= 0 && newIndex < Config.taxes.length) {
            State.taxIndex = newIndex;
            UI.update(); // Update UI sofort damit Tooltip stimmt
        }
    },

    updateChatter: function() {
        if(State.population === 0) {
            document.getElementById('villager-chatter').innerText = `"${Phrases.empty[0]}"`;
            document.getElementById('villager-chatter').style.opacity = 1;
            return;
        }
        let pool = Phrases.neutral;
        if(State.popularity > 80) pool = Phrases.happy;
        if(State.popularity < 40) pool = Phrases.angry;
        const text = pool[Math.floor(Math.random() * pool.length)];
        const el = document.getElementById('villager-chatter');
        el.style.opacity = 0;
        setTimeout(() => { el.innerText = `"${text}"`; el.style.opacity = 1; }, 300);
    },

    build: function(type) {
        const b = Config.buildings[type];
        if (State.gold >= b.costG && State.wood >= b.costW && State.stone >= b.costS) {
            State.gold -= b.costG; State.wood -= b.costW; State.stone -= b.costS;
            State.b[type]++;
            if(b.capacity) State.maxPop += b.capacity;
            UI.update();
            UI.log(`${b.name} gebaut.`);
        } else {
            UI.log("Zu wenig Ressourcen.");
        }
    },

    recruit: function() {
        if(State.b.barracks > 0 && State.gold >= 10 && State.weapons >= 1 && State.population > State.soldiers + 1) {
            State.gold -= 10; State.weapons -= 1; State.soldiers++;
            UI.update();
            UI.log("Soldat rekrutiert.", "important");
        } else {
            UI.log("Bedingungen nicht erf√ºllt.");
        }
    }
};

const UI = {
    log: function(text, type = '') {
        const area = document.getElementById('log-area');
        const div = document.createElement('div');
        div.className = `log-entry ${type}`;
        div.innerHTML = `<strong>Tag ${State.day}:</strong> ${text}`;
        area.prepend(div);
        if(area.children.length > 20) area.removeChild(area.lastChild);
    },

    update: function(efficiency = 1, jobs = 0, peasants = 0) {
        const s = State;
        const set = (id, val) => document.getElementById(id).innerText = Math.floor(val);
        set('res-gold', s.gold); set('res-wood', s.wood); set('res-stone', s.stone); set('res-iron', s.iron);
        set('res-bread', s.bread); set('res-meat', s.meat); set('res-apple', s.apple);
        set('res-soldier', s.soldiers); set('res-pop', s.popularity);
        
        document.getElementById('stat-day').innerText = s.day;
        document.getElementById('stat-pop').innerText = `${s.population} / ${s.maxPop}`;

        // TAX
        const tax = Config.taxes[s.taxIndex];
        document.getElementById('display-tax').innerText = tax.name;
        
        // WORKERS
        const effPct = Math.floor(efficiency * 100);
        const elWorker = document.getElementById('stat-workers');
        if(jobs === 0) elWorker.innerText = "Keine Jobs";
        else {
            elWorker.innerText = `${peasants}/${jobs} Arbeiter (${effPct}%)`;
            elWorker.className = (effPct < 100) ? 'efficiency-display low' : 'efficiency-display';
        }

        // TOOLTIP UPDATE (Das Herzst√ºck)
        this.updateTooltip();
    },

    updateTooltip: function() {
        const f = State.factors;
        // Tax Info live holen, falls wir im Pause-Modus umschalten
        const taxVal = Config.taxes[State.taxIndex].pop;
        
        const total = f.food + taxVal + f.events;
        
        const row = (label, val) => {
            let colorClass = "val-neu";
            if(val > 0) colorClass = "val-pos";
            if(val < 0) colorClass = "val-neg";
            const sign = val > 0 ? "+" : "";
            return `<div class="tooltip-row"><span>${label}:</span><span class="${colorClass}">${sign}${val}</span></div>`;
        };

        let html = "";
        html += row("Nahrung (Vielfalt)", f.food);
        html += row("Steuern", taxVal);
        html += row("Ereignisse/Angst", f.events);
        html += `<div class="tooltip-row" style="margin-top:5px; border-top:1px solid #555; padding-top:3px;">
                    <span>Trend:</span>
                    <span class="${total >= 0 ? 'val-pos' : 'val-neg'}">${total > 0 ? '+' : ''}${total}</span>
                 </div>`;
        
        document.getElementById('pop-details').innerHTML = html;
        
        // Farbe des Herzens anpassen
        const popEl = document.getElementById('res-pop');
        if(State.popularity >= 80) popEl.style.color = "#81c784"; // Gr√ºn
        else if(State.popularity >= 40) popEl.style.color = "#fff"; // Wei√ü
        else popEl.style.color = "#e57373"; // Rot
    },

    updateBars: function() {
        const timePassed = Date.now() - State.lastTick;
        let pctDay = (timePassed / Config.tickRate) * 100;
        if(pctDay > 100) pctDay = 100;
        document.getElementById('bar-day').style.width = pctDay + '%';
        let pctMig = Math.min(State.migrationProgress, 100);
        document.getElementById('bar-migration').style.width = pctMig + '%';
        document.getElementById('text-migration').innerText = Math.floor(pctMig) + '%';
    },

    showFloaty: function(x, y, text, color) {
        const el = document.createElement('div');
        el.className = 'floating-text';
        el.innerText = text;
        el.style.left = (x - 10) + 'px'; el.style.top = (y - 20) + 'px'; el.style.color = color;
        document.getElementById('particles').appendChild(el);
        setTimeout(() => el.remove(), 1000);
    },

    showModal: function(title, text) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-text').innerText = text;
        document.getElementById('modal-overlay').style.display = 'flex';
    },
    closeModal: function() {
        document.getElementById('modal-overlay').style.display = 'none';
        State.paused = false;
        State.lastTick = Date.now();
    }
};

Game.init();
</script>
</body>
</html>
