<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Burgherr V3.2 - Pre-Monetization</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #0d0d0d; 
            --panel-bg: #e0d5b7;
            --border: #3e2723;
            --highlight: #ffb300;
            --text: #271c19;
            --success: #2e7d32;
            --danger: #b71c1c;
            --accent: #d84315;
            --can-build: #e8f5e9;
            --can-build-border: #2e7d32;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Lato', sans-serif; background: var(--bg-body); color: #ccc; margin: 0; 
            height: 100vh; height: 100dvh; 
            display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- TICK BAR --- */
        #tick-container { height: 6px; background: #000; width: 100%; position: relative; z-index: 200; flex-shrink: 0; }
        #tick-bar { height: 100%; background: var(--highlight); width: 0%; transition: width 0.1s linear; box-shadow: 0 0 10px var(--highlight); }

        /* --- HEADER --- */
        header { 
            background: #1a1a1a; height: 100px; flex-shrink: 0; border-bottom: 3px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 10px; z-index: 100; position: relative;
        }

        .header-info { width: 130px; flex-shrink: 0; display:flex; flex-direction:column; justify-content:center; }
        .game-title { font-family: 'MedievalSharp'; font-size: 1.3rem; color: var(--highlight); margin: 0; line-height: 1; text-shadow: 2px 2px 0 #000; }
        .mil-stats { font-size: 0.75rem; color: #ef5350; margin-top: 4px; font-weight: bold; }

        /* Scrollable Resources */
        .res-container { display: flex; gap: 6px; flex: 1; justify-content: flex-end; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .res-container::-webkit-scrollbar { height: 0px; } 

        .res-group { 
            background: #2d2d2d; border: 1px solid #444; border-radius: 4px; padding: 4px 8px; 
            min-width: 65px; text-align: center; display: flex; flex-direction: column; justify-content: center;
            position: relative; cursor: pointer; transition: background 0.2s; flex-shrink: 0;
        }
        
        .res-label { font-size: 0.55rem; text-transform: uppercase; color: #888; border-bottom: 1px solid #444; margin-bottom: 2px; }
        .res-values { display: flex; gap: 8px; justify-content: center; font-weight: bold; font-size: 0.85rem; color: #eee; position: relative; }
        
        .res-item { position: relative; display: inline-block; min-width: 15px; text-align: center; }
        .rate-ind { font-size: 0.65rem; position: absolute; top: -10px; right: -8px; opacity: 0.9; font-weight: 900; text-shadow: 1px 1px 0 #000; }
        .rate-pos { color: #66bb6a; }
        .rate-neg { color: #ef5350; }

        /* Trend Indicator for Happiness */
        .trend-val { font-size: 0.7rem; margin-left: 4px; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: #888; }

        /* Floating Text */
        .float-txt {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            font-size: 1.2rem; font-weight: 900; pointer-events: none;
            animation: floatUp 1.5s forwards; text-shadow: 1px 1px 0 #000; z-index: 3000;
        }
        .click-pop {
            position: absolute; font-size: 2rem; font-weight: bold; color: #fff; pointer-events: none; z-index: 4000;
            text-shadow: 0 0 5px #000; animation: floatUpMap 0.6s forwards;
        }
        @keyframes floatUp { 0% { opacity: 1; top: -20px; transform: translateX(-50%); } 100% { opacity: 0; top: -50px; transform: translateX(-50%); } }
        @keyframes floatUpMap { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.5); } }

        /* --- MAIN MAP --- */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }

        #map-area { 
            flex: 1; position: relative; overflow: hidden; padding: 10px;
            background-color: #0d1b0e;
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8px;
        }
        
        .zone { 
            position: relative; border-radius: 8px; overflow: hidden; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
            transition: transform 0.1s; cursor: pointer; border: 2px solid rgba(255,255,255,0.05);
            touch-action: manipulation; 
        }
        .zone:active { transform: scale(0.97); border-color: rgba(255,255,255,0.4); }

        #z-forest { background: radial-gradient(circle at center, #2e7d32, #1b5e20); }
        #z-mountain { background: linear-gradient(135deg, #5d4037, #3e2723); } 
        #z-town { background: radial-gradient(#d7ccc8, #8d6e63); border: 2px solid #5d4037; }
        #z-farm { background: radial-gradient(#8bc34a, #558b2f); }

        .zone-label { 
            position: absolute; bottom: 10px; left: 10px; 
            font-family: 'MedievalSharp'; font-size: 1.2rem; color: rgba(255,255,255,0.6); 
            text-shadow: 1px 1px 2px #000; pointer-events: none; z-index: 10;
        }
        .zone-hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.15; font-size: 4rem; pointer-events: none; }

        .map-b { 
            position: absolute; font-size: 1.6rem; 
            filter: drop-shadow(2px 2px 1px rgba(0,0,0,0.5)); pointer-events: none;
            animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes popIn { from { transform: scale(0) translateY(20px); opacity:0; } to { transform: scale(1) translateY(0); opacity:1; } }

        /* SIDEBAR */
        aside { 
            width: 320px; background: var(--panel-bg); border-left: 5px solid var(--border); 
            display: flex; flex-direction: column; color: var(--text); z-index: 50; flex-shrink: 0;
        }
        .log-box { 
            flex: 1; overflow-y: auto; padding: 5px; display: flex; flex-direction: column; gap: 4px; 
            background: rgba(0,0,0,0.05); font-size: 0.8rem; position: relative;
        }
        .log-entry { 
            background: #fff; padding: 4px 8px; border-radius: 4px; border-left: 4px solid #999; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-shrink: 0; animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        .log-entry:nth-child(1) { font-weight: bold; border-left-width: 6px; } 
        .log-entry:nth-child(n+10) { opacity: 0.5; } 

        .log-entry.prod { border-color: var(--success); }
        .log-entry.warn { border-color: var(--danger); background: #ffebee; }
        .log-entry.death { border-color: #000; background: #444; color: #fff; }
        .log-entry.war { border-color: var(--highlight); background: #fff8e1; }

        .controls { padding: 8px; background: #bcaaa4; border-top: 2px solid var(--border); }
        .c-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .btn { 
            flex: 1; padding: 10px 5px; border: 1px solid var(--border); background: #efebe9; 
            font-weight: bold; cursor: pointer; border-radius: 4px; color: var(--text); font-size: 0.9rem;
            touch-action: manipulation;
        }
        .btn:active { transform: translateY(2px); background: #ddd; }
        .btn-war { background: #5d4037; color: #fff; border-color: #3e2723; }
        
        /* NEU: Gold Button f√ºr Ads */
        .btn-gold { 
            background: linear-gradient(to bottom, #ffd700, #ffb300); color: #4e342e; border-color: #c49000;
            text-shadow: 0 1px 0 rgba(255,255,255,0.4); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .btn-gold:active { background: #ffb300; transform: translateY(2px); box-shadow: none; }

        /* --- FOOTER (BUILDING) --- */
        footer { 
            height: 160px; background: #d7ccc8; border-top: 5px solid var(--border); flex-shrink: 0;
            display: flex; padding: 0 5px; align-items: center; 
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            z-index: 60;
        }
        
        .cat-bar { width: 120px; display: flex; flex-wrap: wrap; gap: 4px; border-right: 2px solid #ccc; padding-right: 5px; justify-content: center; }
        .cat-btn { width: 36px; height: 36px; background: var(--border); color: #fff; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; border: 2px solid transparent; }
        .cat-btn.active { background: var(--highlight); color: #000; border-color: #fff; }

        .build-bar { flex: 1; display: flex; gap: 8px; overflow-x: auto; padding: 5px; height: 100%; align-items: center; -webkit-overflow-scrolling: touch; }
        .b-card { 
            min-width: 80px; height: 110px; background: rgba(0,0,0,0.05); border-radius: 6px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; border: 2px solid transparent; transition: 0.1s; flex-shrink: 0;
        }
        .b-card:active { transform: scale(0.95); }
        .b-card.can-build { background: var(--can-build); border-color: var(--can-build-border); box-shadow: 0 2px 4px rgba(46, 125, 50, 0.2); }
        .b-count { position: absolute; top: -5px; right: -5px; background: var(--accent); color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; font-weight: bold; box-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        
        /* WORKER CONTROL ON CARD */
        .b-worker-box { 
            width: 100%; border-top: 1px solid rgba(0,0,0,0.1); margin-top: 2px;
            display: flex; justify-content: space-between; align-items: center; padding: 2px 4px;
            background: rgba(255,255,255,0.3); border-radius: 0 0 6px 6px;
        }
        .w-btn { width: 18px; height: 18px; background: #fff; border: 1px solid #999; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; cursor: pointer; }
        .w-btn:active { background: #ccc; }
        .w-disp { font-size: 0.7rem; font-weight: bold; color: #333; }
        .w-empty .w-disp { color: var(--danger); }

        /* MODALS */
        .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        
        .modal-win { 
            background: var(--panel-bg); 
            width: 95%; max-width: 500px; 
            max-height: 90vh; overflow-y: auto; 
            padding: 20px; border: 4px solid var(--border); border-radius: 8px; text-align: center; color: var(--text); box-shadow: 0 0 50px #000; position: relative; 
        }
        
        .list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: left; margin: 15px 0; }
        .list-item { background: rgba(255,255,255,0.5); padding: 5px; border: 1px solid #999; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; font-size: 0.85rem; }
        .missing-res { color: var(--danger); font-weight: bold; }
        .war-card { background: rgba(0,0,0,0.1); padding: 8px; margin-bottom: 5px; border: 1px solid #777; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            header { height: 70px; padding: 0 5px; }
            .header-info { display: flex; width: auto; align-items: flex-start; }
            .game-title { font-size: 1.1rem; }
            
            main { flex-direction: column; }
            #map-area { flex: 1.5; min-height: 40vh; }
            
            aside { 
                width: 100%; height: auto; flex: 1; min-height: 180px; 
                border-left: none; border-top: 4px solid var(--border); 
                flex-direction: row; 
            }
            .log-box { flex: 1; border-right: 2px solid var(--border); }
            .controls { width: 140px; overflow-y: auto; padding: 5px; display: flex; flex-direction: column; justify-content: center; }
            
            footer { height: 130px; flex-direction: column; padding: 0; }
            .cat-bar { width: 100%; height: 40px; border-right: none; border-bottom: 2px solid #ccc; flex-wrap: nowrap; overflow-x: auto; justify-content: flex-start; padding: 2px 5px; }
            .cat-btn { flex-shrink: 0; width: 40px; }
            .build-bar { width: 100%; height: 90px; }
            
            .list-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="modal-mask" class="modal-mask">
    <div class="modal-win">
        <h2 id="m-title" style="font-family:'MedievalSharp'; margin-top:0">Titel</h2>
        <div id="m-body" style="font-size:1.1rem; line-height:1.4">Text</div>
        <button id="m-btn" class="btn" style="margin-top:20px; width:100%; background:var(--highlight);">Aktion</button>
    </div>
</div>

<div id="war-mask" class="modal-mask">
    <div class="modal-win">
        <h2 style="font-family:'MedievalSharp'; margin:0">Feldz√ºge</h2>
        <div style="margin-bottom:10px; border-bottom:1px solid #999; padding-bottom:5px;">
            Armee: <span id="army-str" style="font-weight:bold; font-size:1.2rem">0</span> ‚öîÔ∏è
        </div>
        <div id="war-list" class="list-grid" style="grid-template-columns: 1fr;"></div>
        <button onclick="UI.closeWar()" class="btn" style="width:100%">R√ºckzug</button>
    </div>
</div>

<div id="recruit-mask" class="modal-mask">
    <div class="modal-win">
        <h2 style="font-family:'MedievalSharp'; margin:0">Kaserne</h2>
        <div id="recruit-list" class="list-grid"></div>
        <button onclick="UI.closeRecruit()" class="btn" style="width:100%">Schlie√üen</button>
    </div>
</div>

<div id="market-mask" class="modal-mask">
    <div class="modal-win">
        <h2 style="font-family:'MedievalSharp'; margin:0">Markt</h2>
        <div id="market-list" class="list-grid"></div>
        <button onclick="UI.closeMarket()" class="btn" style="width:100%">Schlie√üen</button>
    </div>
</div>

<div id="tick-container"><div id="tick-bar"></div></div>

<header>
    <div class="header-info">
        <div class="game-title">Burgherr</div>
        <div class="objective" id="obj-disp">Lade...</div>
        <div class="mil-stats">
            üíÇ <span id="s-sold">0</span> ‚öîÔ∏è <span id="s-wep">0</span>
        </div>
    </div>

    <div class="res-container">
        <div class="res-group" id="rg-gold">
            <span class="res-label">Schatz</span>
            <div class="res-values">üí∞ <span id="r-gold">0</span></div>
        </div>
        
        <div class="res-group" id="rg-store" onclick="UI.showStorage()">
            <span class="res-label">Lager</span>
            <div class="res-values">
                <span class="res-item" title="Holz">üå≤<span id="r-wood">0</span><span id="d-wood" class="rate-ind"></span></span>
                <span class="res-item" title="Stein">üß±<span id="r-stone">0</span><span id="d-stone" class="rate-ind"></span></span>
                <span class="res-item" title="Weizen">üåæ<span id="r-wheat">0</span><span id="d-wheat" class="rate-ind"></span></span>
                <span class="res-item" title="Mehl">ü•°<span id="r-flour">0</span><span id="d-flour" class="rate-ind"></span></span>
                <span class="res-item" title="Hopfen">üåø<span id="r-hops">0</span><span id="d-hops" class="rate-ind"></span></span>
            </div>
        </div>

        <div class="res-group" id="rg-food" onclick="UI.showFood()">
            <span class="res-label">Nahrung</span>
            <div class="res-values">
                <span class="res-item" title="Brot">üçû<span id="r-bread">0</span><span id="d-bread" class="rate-ind"></span></span>
                <span class="res-item" title="√Ñpfel">üçé<span id="r-apple">0</span><span id="d-apple" class="rate-ind"></span></span>
                <span class="res-item" title="Bier">üç∫<span id="r-beer">0</span><span id="d-beer" class="rate-ind"></span></span>
            </div>
        </div>

        <div class="res-group" onclick="UI.showHappy()" style="cursor:pointer; border-color:#8d6e63;">
            <span class="res-label">Volk (Trend)</span>
            <div class="res-values pop-val">
                <span title="B√ºrger">üë®‚Äçüåæ <span id="r-pop">0</span></span>
                <span title="Beliebtheit">‚ù§Ô∏è <span id="r-hap">0</span><span id="hap-trend" class="trend-val"></span></span>
                <span title="Unt√§tig" class="idle-val">üí§ <span id="r-idle">0</span></span>
            </div>
        </div>
    </div>
</header>

<main>
    <div id="map-area">
        <div class="zone" id="z-forest" onclick="Game.clickGather('wood', event)">
            <div class="zone-hint">üå≤</div>
            <div class="zone-label">Forst</div>
        </div>
        <div class="zone" id="z-mountain" onclick="Game.clickGather('stone', event)">
            <div class="zone-hint">‚õ∞Ô∏è</div>
            <div class="zone-label">Gebirge</div>
        </div>
        <div class="zone" id="z-town">
            <div class="zone-hint">üè∞</div>
            <div class="zone-label">Stadt</div>
        </div>
        <div class="zone" id="z-farm" onclick="Game.clickGather('apple', event)">
            <div class="zone-hint">üçé</div>
            <div class="zone-label">L√§ndereien</div>
        </div>
    </div>

    <aside>
        <div class="log-box" id="log"></div>
        <div class="controls">
            <div class="c-row">
                <button class="btn btn-gold" onclick="Game.watchAdForReward()" style="flex:1.5;">üí∞ Schatzkammer (+250g)</button>
            </div>
            <div class="c-row">
                <button class="btn" onclick="UI.openRecruit()">üõ°Ô∏è</button>
                <button class="btn btn-war" onclick="UI.openWar()">‚öîÔ∏è</button>
                <button class="btn" onclick="UI.openMarket()">‚öñÔ∏è</button>
            </div>
            <div style="background:rgba(255,255,255,0.5); padding:3px; border-radius:4px; font-size:0.7rem; margin:5px 0; text-align:center;">
                Steuer: <strong id="tax-name">Keine</strong><br>
                <span id="tax-impact" style="font-size:0.65rem; font-weight:bold;"></span>
                <div>
                    <button onclick="Game.tax(-1)" style="padding:2px 8px;cursor:pointer">‚ûñ</button> 
                    <button onclick="Game.tax(1)" style="padding:2px 8px;cursor:pointer">‚ûï</button>
                </div>
            </div>
            <div style="text-align:center; font-size:0.7rem; margin-top:5px;">
                Tag <span id="day-disp">1</span> - Lvl <span id="lvl-disp">1</span><br>
                <button onclick="Game.save()" style="margin-top:3px; padding:2px 5px;">Save</button>
                <button onclick="Game.reset()" style="margin-top:3px; padding:2px 5px; color:red">Reset</button>
            </div>
        </div>
    </aside>
</main>

<footer>
    <div class="cat-bar">
        <div class="cat-btn active" onclick="UI.setCat('burg')">üè∞</div>
        <div class="cat-btn" onclick="UI.setCat('werk')">üî®</div>
        <div class="cat-btn" onclick="UI.setCat('farm')">üçé</div>
        <div class="cat-btn" onclick="UI.setCat('stadt')">üè†</div>
        <div class="cat-btn" onclick="UI.setCat('waffen')">‚öîÔ∏è</div>
        <div class="cat-btn" onclick="UI.setCat('nahrung')">üçû</div>
    </div>
    <div class="build-bar" id="build-list"></div>
</footer>

<script>
/* DATEN */
const T = {
    wood:"Holz", stone:"Stein", iron:"Eisen", pitch:"Pech", wheat:"Weizen", flour:"Mehl", hops:"Hopfen",
    bread:"Brot", meat:"Fleisch", cheese:"K√§se", apple:"√Ñpfel", beer:"Bier",
    bow:"Bogen", spear:"Speer", sword:"Schwert", armor:"R√ºstung", leather:"Leder",
    gold:"Gold", pop:"B√ºrger", archer:"Sch√ºtze", pikeman:"Pikenier", swordsman:"Schwertk√§mpfer", merc:"S√∂ldner",
    cath:"Kathedrale"
};
const SafeT = (k) => T[k] || k; 

const Rules = {
    storeTypes: ['wood','stone','iron','wheat','flour','hops'],
    foodTypes:  ['bread','meat','apple','cheese','beer'] 
};

const Levels = [
    {
        id:1, 
        t:"Gr√ºndung", 
        msg:"Sorge f√ºr Nahrung und Unterk√ºnfte. Klicke auf die Karte f√ºr erste Rohstoffe!", 
        goal:{wood:50, pop:10}, 
        start:{gold: 100, wood: 60, bread: 50, apple: 20}
    },
    {id:2, t:"Stein & Brot", msg:"Baut Steinbr√ºche & Brotproduktion. Klicke auf Berge f√ºr Stein.", goal:{stone:20, bread:30}, start:{gold:150, wood:50, bread:50}},
    {id:3, t:"Waffen", msg:"Stellt B√∂gen und Speere her.", goal:{bow:5, spear:5}, start:{gold:200, wood:100, stone:50, bread:100, meat:20}},
    {id:4, t:"Armee", msg:"Bildet 10 Soldaten aus.", goal:{soldier:10}, start:{gold:300, wood:100, stone:100, iron:20, bread:100, meat:50}},
    {id:5, t:"Kathedrale", msg:"Das Meisterwerk.", goal:{cath:1}, start:{gold:1000, wood:500, stone:500, iron:100, bread:200, wine:50}}
];

const Units = {
    archer: {n:"Sch√ºtze", cost:10, res:"bow", str:5},
    pikeman: {n:"Pikenier", cost:15, res:"spear", str:8},
    swordsman: {n:"Schwertk.", cost:30, res:"sword", arm:"armor", str:15},
    merc: {n:"S√∂ldner", cost:50, str:10}
};

const Missions = [
    {n:"Banditenlager", str:20, loot:{gold:50, wood:20, bread:20}, risk:"Niedrig"},
    {n:"Wegelagerer", str:50, loot:{gold:100, iron:10, meat:20}, risk:"Mittel"},
    {n:"Raubritterburg", str:150, loot:{gold:300, stone:50, sword:5, armor:2}, risk:"Hoch"},
    {n:"Feindliche Grafschaft", str:500, loot:{gold:1000, iron:100}, risk:"Extrem"}
];

const Config = {
    tick: 4000, 
    taxes: [
        {n:"Keine",   g:0, h:1},
        {n:"Gering",  g:1, h:-1}, 
        {n:"Normal",  g:2, h:-2},
        {n:"Hoch",    g:4, h:-4},
        {n:"Wucher",  g:8, h:-10}
    ],
    b: {
        // BURG
        wall_w:{n:"Holzwall",c:"burg",i:"ü™µ",z:"z-town",cost:{g:10,w:20}},
        tower:{n:"Turm",c:"burg",i:"üóº",z:"z-mountain",cost:{g:100,s:50}},
        barrack:{n:"Kaserne",c:"burg",i:"‚õ∫",z:"z-town",cost:{g:150,s:20},desc:"Armee"},
        merc:{n:"S√∂ldnerlager",c:"burg",i:"üé™",z:"z-town",cost:{g:500,w:100},desc:"S√∂ldner"},
        
        // WERK
        wood:{n:"Holzf√§ller",c:"werk",i:"ü™ì",z:"z-forest",cost:{g:10},prod:"wood",amt:3, type:"mat"},
        stock:{n:"Vorratslager",c:"werk",i:"üì¶",z:"z-town",cost:{w:20},desc:"Lager"},
        ox:{n:"Ochsenjoch",c:"werk",i:"üêÇ",z:"z-mountain",cost:{g:20,w:20}},
        quarry:{n:"Steinbruch",c:"werk",i:"‚õèÔ∏è",z:"z-mountain",cost:{g:50,w:50},prod:"stone",amt:2,need:"ox", type:"mat"},
        iron:{n:"Eisenmine",c:"werk",i:"‚õìÔ∏è",z:"z-mountain",cost:{g:100,w:100},prod:"iron",amt:1, type:"mat"},
        
        // FARM
        apple:{n:"Obstgarten",c:"farm",i:"üçé",z:"z-farm",cost:{g:30,w:10},prod:"apple",amt:3, type:"food"},
        hunter:{n:"J√§ger",c:"farm",i:"üèπ",z:"z-forest",cost:{g:20,w:5},prod:"meat",amt:2, type:"food"},
        dairy:{n:"K√§serei",c:"farm",i:"üßÄ",z:"z-farm",cost:{g:40,w:20},prod:"cheese",amt:2, type:"food"},
        wheat:{n:"Getreide",c:"farm",i:"üåæ",z:"z-farm",cost:{g:40,w:10},prod:"wheat",amt:2, type:"mat"},
        hops:{n:"Hopfen",c:"farm",i:"üåø",z:"z-farm",cost:{g:40,w:10},prod:"hops",amt:2, type:"mat"},
        
        // STADT
        hovel:{n:"H√ºtte",c:"stadt",i:"üõñ",z:"z-town",cost:{w:10},pop:5},
        house:{n:"Haus",c:"stadt",i:"üè†",z:"z-town",cost:{g:50,w:30,s:10},pop:10},
        church:{n:"Kirche",c:"stadt",i:"‚õ™",z:"z-town",cost:{g:500,s:100},rel:10},
        cath:{n:"KATHEDRALE",c:"stadt",i:"üïç",z:"z-town",cost:{g:5000,s:2000},rel:50},
        
        // WAFFEN
        fletch:{n:"Pfeilmacher",c:"waffen",i:"üèπ",z:"z-town",cost:{g:100,w:50},use:"wood",out:"bow",amt:1},
        pole:{n:"Pikenmacher",c:"waffen",i:"üî±",z:"z-town",cost:{g:100,w:50},use:"wood",out:"spear",amt:1},
        smith:{n:"Schmiede",c:"waffen",i:"‚öîÔ∏è",z:"z-town",cost:{g:200,w:100},use:"iron",out:"sword",amt:1},
        armor:{n:"R√ºstung",c:"waffen",i:"üõ°Ô∏è",z:"z-town",cost:{g:200,w:100},use:"iron",out:"armor",amt:1},
        
        // NAHRUNG
        gran:{n:"Kornspeicher",c:"nahrung",i:"üõñ",z:"z-town",cost:{w:20},cap:50},
        mill:{n:"M√ºhle",c:"nahrung",i:"‚öôÔ∏è",z:"z-town",cost:{g:100,w:50},proc:"wheat",out:"flour",r:1},
        bake:{n:"B√§cker",c:"nahrung",i:"üçû",z:"z-town",cost:{g:50,w:20},proc:"flour",out:"bread",r:4, type:"food"},
        brew:{n:"Brauerei",c:"nahrung",i:"üç∫",z:"z-town",cost:{g:100,w:20},proc:"hops",out:"beer",r:2}
    }
};

/* LOGIC */
let S = {}; 
let lastTickTime = 0;

const Game = {
    init: function() {
        if(localStorage.getItem('sh_v32_monetize')) {
            try {
                let load = JSON.parse(localStorage.getItem('sh_v32_monetize'));
                if(load) S = load;
                else this.startLevel(1);
                Game.recalcStats(); 
                UI.init();
                UI.showModal("Willkommen zur√ºck", "Dein Lehen erwartet dich.", "Weiter");
            } catch(e) { this.reset(); }
        } else {
            this.startLevel(1);
        }
        setInterval(this.tick, Config.tick);
        lastTickTime = Date.now();
        requestAnimationFrame(UI.animateTick);
    },

    startLevel: function(id) {
        let l = Levels.find(x => x.id == id);
        if(!l) return UI.showModal("Spielende", "Du bist der wahre Burgherr!", "Hurra");
        
        S = {
            lvl: id, day: 1, paused: true,
            res: { gold:0, wood:0, stone:0, iron:0, pitch:0, wheat:0, flour:0, bread:0, meat:0, cheese:0, apple:0, hops:0, beer:0, bow:0, spear:0, sword:0, armor:0, leather:0 },
            units: { archer:0, pikeman:0, swordsman:0, merc:0 },
            pop: { curr:5, max:0, hap:100 },
            b: {}, w: {}, tax: 0,
            factors: { hunger:0, variety:0, tax:0, beer:0, religion:0, overcrowd:0, idle:0, total:0 },
            rates: {} 
        };
        for(let k in l.start) S.res[k] = l.start[k];
        for(let k in Config.b) { S.b[k]=0; S.w[k]=0; }
        S.b.stock = 1; S.b.gran = 1;
        Game.recalcStats(); 
        
        Game.autoAssign(); 

        UI.init();
        UI.showModal("Level " + id + ": " + l.t, l.msg, "Starten");
    },

    recalcStats: function() {
        S.pop.max = (S.b.hovel||0)*5 + (S.b.house||0)*10 + 5;
    },

    getArmyStr: function() {
        let s = 0;
        for(let k in S.units) s += (S.units[k] * Units[k].str);
        return s;
    },

    countWorkers: function() {
        let work = 0; for (let k in S.w) work += S.w[k];
        let sold = 0; for (let k in S.units) sold += S.units[k];
        let available = S.pop.curr - sold;
        let idle = available - work;
        return { work, sold, available, idle };
    },
    
    isProductionBuilding: function(b) {
        return !!(b.prod || b.proc || b.use);
    },

    clickGather: function(type, e) {
        if(S.paused) return;
        let maxS = (S.b.stock || 1) * 50;
        let maxF = (S.b.gran || 1) * 50;
        let curS = 0; Rules.storeTypes.forEach(k=>curS+=S.res[k]);
        let curF = 0; Rules.foodTypes.forEach(k=>curF+=S.res[k]);

        if(type === 'wood' || type === 'stone') {
            if(curS >= maxS) { UI.showFloatingText(type, "Lager Voll!", "neg"); return; }
        }
        if(type === 'apple') {
            if(curF >= maxF) { UI.showFloatingText(type, "Speicher Voll!", "neg"); return; }
        }

        S.res[type]++;
        UI.update();
        UI.showFloatingText(type, "+1", "pos");
        UI.showMapClickEffect(e.currentTarget, type === 'apple' ? 'üçé' : (type==='wood'?'üå≤':'üß±'));
    },

    tick: function() {
        if(S.paused) { lastTickTime = Date.now(); return; }
        S.day++;
        lastTickTime = Date.now();
        let startRes = JSON.parse(JSON.stringify(S.res));
        Game.recalcStats();
        
        let dRes = {}; for(let k in S.res) dRes[k] = 0;
        let maxS = (S.b.stock || 1) * 50;
        let maxF = (S.b.gran || 1) * 50; 
        
        // 1. Produktion
        for(let k in Config.b) {
            let b = Config.b[k];
            let n = S.w[k];
            if(n <= 0) continue;
            if(b.prod) {
                let effN = n;
                if(b.need && S.b[b.need] < n) effN = S.b[b.need]; 
                dRes[b.prod] = (dRes[b.prod]||0) + (effN * (b.amt||1));
            }
            if(b.proc) {
                let avail = S.res[b.proc] + (dRes[b.proc]||0); 
                let maxProc = n;
                let actual = Math.min(avail, maxProc);
                if(actual > 0) {
                    dRes[b.proc] -= actual;
                    dRes[b.out] = (dRes[b.out]||0) + (actual * (b.r||1));
                }
            }
            if(b.use) {
                let avail = S.res[b.use] + (dRes[b.use]||0);
                let actual = Math.min(avail, n);
                if(actual > 0) {
                    dRes[b.use] -= actual;
                    dRes[b.out] = (dRes[b.out]||0) + (actual * (b.amt||1));
                }
            }
        }

        // 2. Konsum (Essen)
        let eat = S.pop.curr;
        let foods = ['bread','meat','cheese','apple'];
        let ateTypes = 0;
        foods.sort((a,b) => (S.res[b]||0) - (S.res[a]||0));
        for(let f of foods) {
            if(eat <= 0) break;
            let avail = (S.res[f]||0) + (dRes[f]||0);
            if(avail > 0) {
                let take = Math.min(eat, avail);
                dRes[f] = (dRes[f]||0) - take;
                eat -= take;
                ateTypes++;
            }
        }

        // 3. HAPPINESS SYSTEM
        let h = { hunger:0, variety:0, tax:0, beer:0, religion:0, overcrowd:0, idle:0, total:0 };

        if(eat > 0) { 
            UI.log(`${eat} hungern!`, 'warn'); 
            h.hunger = -8; 
            if(Math.random() < 0.2) {
                S.pop.curr--;
                UI.log("Ein B√ºrger verhungert.", "death");
                Game.unassignWorker(true); 
            }
        } else { h.hunger = +2; }

        h.variety = (ateTypes >= 3) ? +2 : (ateTypes === 2 ? +1 : 0);

        let tx = Config.taxes[S.tax];
        h.tax = tx.h;
        dRes.gold = (dRes.gold||0) + (S.pop.curr * tx.g);

        let availBeer = (S.res.beer||0) + (dRes.beer||0);
        if(S.pop.curr > 0) {
            if(availBeer >= S.pop.curr) {
                dRes.beer -= S.pop.curr;
                h.beer = +3;
            } else if(availBeer > 0) {
                let ratio = availBeer / S.pop.curr;
                dRes.beer -= availBeer;
                h.beer = (ratio >= 0.5) ? +1 : 0;
            }
        }

        h.religion = (S.b.church||0) * 3;

        if(S.pop.max > 0) {
            let fill = S.pop.curr / S.pop.max;
            if(fill > 0.95) h.overcrowd = -2;
            if(fill > 1.00) h.overcrowd = -6; 
        }

        let cw = Game.countWorkers();
        if(cw.available > 0) {
            let idleRatio = cw.idle / cw.available;
            if(idleRatio > 0.4) h.idle = -1;
        }

        h.total = h.hunger + h.variety + h.tax + h.beer + h.religion + h.overcrowd + h.idle;
        let delta = Math.max(-6, Math.min(6, h.total));
        S.pop.hap = Math.max(0, Math.min(100, S.pop.hap + delta));
        S.factors = { ...h, total: delta };

        // 4. Apply & Limits
        for(let k in dRes) {
            S.res[k] = (S.res[k]||0) + dRes[k];
            if(S.res[k] < 0) S.res[k] = 0;
        }

        let curS = 0; Rules.storeTypes.forEach(k=>curS+=S.res[k]);
        let curF = 0; Rules.foodTypes.forEach(k=>curF+=S.res[k]);

        if(curS > maxS) {
            let types = Rules.storeTypes;
            let over = curS - maxS;
            while(over > 0) {
                let del = false;
                for(let t of types) { if(S.res[t] > 0 && over > 0) { S.res[t]--; over--; del=true; } }
                if(!del) break;
            }
        }
        if(curF > maxF) {
            let types = Rules.foodTypes;
            let over = curF - maxF;
            while(over > 0) {
                let del = false;
                for(let t of types) { if(S.res[t] > 0 && over > 0) { S.res[t]--; over--; del=true; } }
                if(!del) break;
            }
        }

        if(S.pop.curr <= 0) {
            S.pop.curr = 0; S.paused = true; UI.update();
            UI.showModal("GAME OVER", "Das Dorf ist ausgestorben.", "Neustart", Game.reset);
            return; 
        }

        if(S.pop.hap > 70 && S.pop.curr < S.pop.max && Math.random()>0.6) {
            S.pop.curr++; 
            UI.log("Neuer B√ºrger", "prod");
        } else if(S.pop.hap < 20 && S.pop.curr > 0) {
            S.pop.curr--; UI.log("B√ºrger geflohen", "warn");
            Game.unassignWorker(true);
        }

        S.rates = {};
        for(let k in S.res) {
            let diff = S.res[k] - startRes[k];
            if(diff !== 0) S.rates[k] = diff;
        }

        let l = Levels.find(x => x.id == S.lvl);
        let win = true;
        let sold = 0; for(let k in S.units) sold += S.units[k];
        for(let k in l.goal) {
            let val = 0;
            if(k=='pop') val=S.pop.curr;
            else if(k=='soldier') val=sold;
            else val = S.res[k] || S.b[k] || 0;
            if(val < l.goal[k]) win = false;
        }
        if(win) {
            S.paused = true;
            UI.showModal("SIEG!", "Level geschafft!", "N√§chstes Level", () => Game.startLevel(S.lvl+1));
        }
        UI.update();
    },

    autoAssign: function() {
        let cw = Game.countWorkers();
        if(cw.idle <= 0) return;

        let priority = [];
        let curF = 0; ['bread','meat','apple','cheese'].forEach(k=>curF+=S.res[k]);
        let lowFood = curF < S.pop.curr * 3; 

        for(let k in Config.b) {
            let b = Config.b[k];
            if(!Game.isProductionBuilding(b)) continue;
            let p = 2; 
            if(lowFood && (b.type === 'food' || b.out === 'bread')) p = 1; 
            if(b.prod === 'wood') p = 1.5;
            priority.push({k:k, p:p});
        }
        priority.sort((a,b) => a.p - b.p);

        for(let item of priority) {
            if(cw.idle <= 0) break;
            let k = item.k;
            if(S.b[k] > S.w[k]) { S.w[k]++; cw.idle--; }
        }
    },

    assign: function(key, dir) {
        if(!S.b[key]) return;
        let b = Config.b[key];
        if(!Game.isProductionBuilding(b)) return;

        let cw = Game.countWorkers();
        
        if(dir > 0) {
            if(cw.idle > 0 && S.w[key] < S.b[key]) {
                S.w[key]++;
            } else if(cw.idle <= 0) {
                UI.showFloatingText('r-idle', "Keine B√ºrger!", "neg");
            }
        } else {
            if(S.w[key] > 0) {
                S.w[key]--;
            }
        }
        UI.update();
        UI.renderBuild();
    },

    unassignWorker: function(protectFood) {
        const fireOrder = ['merc','smith','armor','fletch','pole','iron','gold','quarry','wood','brew','mill','bake','dairy','hunter','apple','wheat','hops'];
        for(let key of fireOrder) {
            if(S.w[key] > 0) { S.w[key]--; return true; }
        }
        for(let k in S.w) { if(S.w[k] > 0) { S.w[k]--; return true; } }
        return false;
    },

    build: function(key) {
        let b = Config.b[key];
        if(!(S.res.gold >= (b.cost.g||0) && S.res.wood >= (b.cost.w||0) && S.res.stone >= (b.cost.s||0))) return;

        S.res.gold -= (b.cost.g||0); S.res.wood -= (b.cost.w||0); S.res.stone -= (b.cost.s||0);
        S.b[key] = (S.b[key]||0) + 1;
        
        if(Game.isProductionBuilding(b)) {
            let cw = Game.countWorkers();
            if(cw.idle > 0) {
                if(S.w[key] < S.b[key]) S.w[key] = (S.w[key]||0) + 1;
            }
        }

        Game.recalcStats(); 
        UI.addMapIcon(key);
        UI.renderBuild();
        UI.update();
    },

    recruit: function(key) {
        let cw = Game.countWorkers();
        let u = Units[key];

        if(key === 'merc') {
            if((S.b.merc||0) < 1) return;
            if(S.res.gold >= 50) { S.res.gold-=50; S.units.merc++; UI.log("S√∂ldner angeheuert", "prod"); }
        } else {
            if((S.b.barrack||0) < 1) return;
            if(cw.idle < 1) { 
                UI.showModal("Keine Rekruten", "Du hast keine unt√§tigen B√ºrger. Feuere jemanden aus einem Betrieb.", "OK");
                return;
            }

            if(S.res.gold >= u.cost && S.res[u.res] >= 1) {
                if(u.arm && S.res[u.arm] < 1) return;
                S.res.gold -= u.cost;
                S.res[u.res]--;
                if(u.arm) S.res[u.arm]--;
                S.units[key]++;
                UI.log(u.n + " ausgebildet", "prod");
            }
        }
        UI.update();
    },

    // --- MONETIZATION SIMULATION ---
    watchAdForReward: function() {
        // PLATZHALTER F√úR CRAZYGAMES SDK
        // 1. Spiel pausieren
        S.paused = true;
        
        // 2. SDK Aufruf simulieren (hier modal zeigen)
        UI.showModal("K√∂niglicher Herold", "Eine Botschaft aus fernen Landen trifft ein... (Werbung wird simuliert)", "...", () => {
            // Leere Callback-Funktion, damit das Spiel pausiert bleibt, wenn man auf "..." klickt.
            // In der Realit√§t w√ºrde das SDK das Schlie√üen des Ads handeln.
        });
        
        // 3. Erfolg simulieren nach 3 Sekunden
        setTimeout(() => {
            // SDK meldet "Ad Finished"
            S.res.gold += 250; // BELOHNUNG
            
            // Spiel fortsetzen
            S.paused = false;
            lastTickTime = Date.now();
            
            // UI updaten und Erfolg melden
            UI.update();
            UI.showModal("Belohnung erhalten!", "Der Schatzmeister hat 250 Gold in die Truhen gelegt.", "Fantastisch");
            UI.log("K√∂nigliche Belohnung erhalten (+250g)", "prod");
        }, 3000); 
    },
    // -------------------------------

    launchWar: function(idx) {
        let m = Missions[idx];
        let str = Game.getArmyStr();
        let rng = (Math.random() * 0.4) + 0.8; 
        let enemyRoll = m.str * rng;
        let win = str >= enemyRoll;
        
        let lossRate = win ? 0.1 : 0.3;
        let lostUnits = [];
        for(let k in S.units) {
            let uCount = S.units[k];
            if(uCount > 0) {
                let kill = Math.ceil(uCount * lossRate * Math.random());
                if(kill > 0) {
                    S.units[k] -= kill;
                    lostUnits.push(`${kill} ${Units[k].n}`);
                }
            }
        }
        
        if(win) {
            let lootText = [];
            for(let k in m.loot) {
                S.res[k] = (S.res[k]||0) + m.loot[k];
                lootText.push(`${m.loot[k]} ${SafeT(k)}`);
            }
            UI.log(`Sieg gegen ${m.n}! Beute: ${lootText.join(', ')}`, 'war');
        } else {
            UI.log(`Niederlage gegen ${m.n}.`, 'warn');
        }
        if(lostUnits.length) UI.log(`Verluste: ${lostUnits.join(', ')}`, 'death');
        UI.update();
        UI.closeWar();
    },

    tax: function(d) {
        let n = S.tax + d;
        if(n >= 0 && n < 5) S.tax = n;
        UI.update();
    },

    trade: function(k, buy) {
        if(buy && S.res.gold >= 5) { S.res.gold-=5; S.res[k]=(S.res[k]||0)+5; }
        if(!buy && (S.res[k]||0) >= 5) { S.res[k]-=5; S.res.gold+=3; }
        UI.update(); UI.renderMarket();
    },

    save: function() { localStorage.setItem('sh_v32_monetize', JSON.stringify(S)); UI.log("Gespeichert", "prod"); },
    reset: function() { localStorage.removeItem('sh_v32_monetize'); location.reload(); }
};

const UI = {
    cat: 'burg',
    init: function() {
        this.renderMap();
        this.renderBuild();
        this.update();
    },
    
    animateTick: function() {
        if(!S.paused) {
            let now = Date.now();
            let diff = now - lastTickTime;
            let pct = Math.min(100, (diff / Config.tick) * 100);
            document.getElementById('tick-bar').style.width = pct + "%";
        }
        requestAnimationFrame(UI.animateTick);
    },
    
    update: function() {
        ['gold','wood','stone','iron','wheat','flour','hops','bread','meat','apple','cheese','beer','bow','spear','sword','armor','merc'].forEach(k => {
            let el = document.getElementById('r-'+k);
            if(el) {
                let val = S.res[k] !== undefined ? S.res[k] : (S.units[k] !== undefined ? S.units[k] : 0);
                el.innerText = Math.floor(val); 
            }
            
            let dEl = document.getElementById('d-'+k);
            if(dEl) {
                let r = S.rates[k] || 0;
                dEl.innerText = r > 0 ? `+${r}` : (r < 0 ? r : "");
                dEl.className = "rate-ind " + (r >= 0 ? "rate-pos" : "rate-neg");
            }
        });

        let cw = Game.countWorkers();
        let weps = (S.res.bow||0) + (S.res.spear||0) + (S.res.sword||0) + (S.res.armor||0);
        document.getElementById('s-sold').innerText = cw.sold;
        document.getElementById('s-wep').innerText = weps;

        document.getElementById('r-pop').innerText = S.pop.curr + "/" + S.pop.max;
        document.getElementById('r-idle').innerText = cw.idle;
        document.getElementById('r-hap').innerText = Math.floor(S.pop.hap);
        document.getElementById('day-disp').innerText = S.day;
        document.getElementById('lvl-disp').innerText = S.lvl;
        
        let trEl = document.getElementById('hap-trend');
        let change = S.factors.total || 0;
        if(trEl) {
            let sym = change > 0 ? '‚Üó' : (change < 0 ? '‚Üò' : '‚Üí');
            trEl.innerText = `${sym} (${change > 0 ? '+' : ''}${Math.round(change*10)/10})`;
            trEl.className = 'trend-val ' + (change > 0 ? 'trend-up' : (change < 0 ? 'trend-down' : 'trend-neutral'));
        }

        let tIdx = Config.taxes[S.tax];
        document.getElementById('tax-name').innerText = tIdx.n;
        
        let taxGold = S.pop.curr * tIdx.g;
        let taxHap = tIdx.h;
        let impactEl = document.getElementById('tax-impact');
        if(impactEl) {
            impactEl.innerHTML = `+${taxGold}üí∞ / ${taxHap}‚ù§Ô∏è`;
            impactEl.style.color = taxHap < 0 ? '#b71c1c' : '#2e7d32';
        }
        
        let maxS = (S.b.stock||1)*50;
        let curS = 0; Rules.storeTypes.forEach(k=>curS+=(S.res[k]||0));
        
        let maxF = (S.b.gran||1)*50;
        let curF = 0; Rules.foodTypes.forEach(k=>curF+=(S.res[k]||0));

        let l = Levels.find(x => x.id == S.lvl);
        if(l) {
            let h = "";
            for(let k in l.goal) {
                let v = 0;
                if(k=='pop') v = S.pop.curr;
                else if(k=='soldier') v = cw.sold;
                else v = S.res[k] || S.b[k] || 0;
                let c = v >= l.goal[k] ? 'color:#4caf50' : '';
                h += `<span style="${c}">${SafeT(k)}: ${Math.floor(v)}/${l.goal[k]}</span> `;
            }
            document.getElementById('obj-disp').innerHTML = h;
        }

        this.updateBuildState();
        if(document.getElementById('war-mask').style.display === 'flex') {
            document.getElementById('army-str').innerText = Game.getArmyStr();
        }
    },

    showHappy: function() {
        const f = S.factors || {};
        const rows = [
            ["Hunger/Versorgung", f.hunger],
            ["Vielfalt", f.variety],
            ["Steuern", f.tax],
            ["Bier", f.beer],
            ["Religion", f.religion],
            ["√úberbelegung", f.overcrowd],
            ["Unt√§tigkeit", f.idle],
        ];

        const c = (v) => v > 0 ? '#2e7d32' : (v < 0 ? '#b71c1c' : '#000');
        let html = `<div style="text-align:left; margin:10px 20px;">`;

        for(let [name,val] of rows) {
            if(val === 0) continue; 
            html += `
                <div style="display:flex;justify-content:space-between; border-bottom:1px solid #ccc; padding:5px 0;">
                    <span>${name}:</span>
                    <span style="font-weight:bold; color:${c(val)}">${val>0?'+':''}${val}</span>
                </div>`;
        }

        html += `
            <div style="display:flex;justify-content:space-between; margin-top:10px; font-weight:900; font-size:1.2rem;">
                <span>Œî pro Tick:</span>
                <span style="color:${c(f.total)}">${(f.total)>0?'+':''}${Math.round(f.total*10)/10}</span>
            </div>
        </div>`;

        UI.showModal("Volkslaune (Details)", "", "Schlie√üen");
        document.getElementById('m-body').innerHTML = html;
    },

    showStorage: function() {
        let maxS = (S.b.stock||1)*50;
        let curS = 0; Rules.storeTypes.forEach(k=>curS+=(S.res[k]||0));
        UI.showModal("Lager", `Belegung: ${Math.floor(curS)} / ${maxS}\nBaue 'Vorratslager', um das Limit zu erh√∂hen.`, "Schlie√üen");
    },
    
    showFood: function() {
        let maxF = (S.b.gran||1)*50;
        let curF = 0; Rules.foodTypes.forEach(k=>curF+=(S.res[k]||0));
        UI.showModal("Kornspeicher", `Nahrung: ${Math.floor(curF)} / ${maxF}\nBaue 'Kornspeicher', um das Limit zu erh√∂hen.`, "Schlie√üen");
    },

    updateBuildState: function() {
        document.querySelectorAll('.b-card').forEach(card => {
            let key = card.getAttribute('data-key');
            if(!key) return;
            let b = Config.b[key];
            let can = S.res.gold >= (b.cost.g||0) && S.res.wood >= (b.cost.w||0) && S.res.stone >= (b.cost.s||0);
            
            if(can) card.classList.add('can-build');
            else card.classList.remove('can-build');
            
            let txt = [];
            if(b.cost.g) txt.push(`<span class="${S.res.gold<b.cost.g?'missing-res':''}">${b.cost.g}üí∞</span>`);
            if(b.cost.w) txt.push(`<span class="${S.res.wood<b.cost.w?'missing-res':''}">${b.cost.w}üå≤</span>`);
            if(b.cost.s) txt.push(`<span class="${S.res.stone<b.cost.s?'missing-res':''}">${b.cost.s}üß±</span>`);
            
            card.querySelector('.cost-disp').innerHTML = txt.join(' ');
        });
    },

    showFloatingText: function(key, text, type) {
        let targetId = "";
        if(Rules.storeTypes.includes(key)) targetId = 'rg-store';
        else if(Rules.foodTypes.includes(key)) targetId = 'rg-food';
        else if(key === 'gold') targetId = 'rg-gold';
        else return; 
        
        let target = document.getElementById(targetId);
        if(!target) return;
        
        let el = document.createElement('div');
        el.className = 'float-txt';
        el.style.color = type === 'pos' ? '#4caf50' : '#f44336';
        el.innerText = text;
        target.appendChild(el);
        
        setTimeout(() => el.remove(), 1500);
    },

    showMapClickEffect: function(el, icon) {
        let pop = document.createElement('div');
        pop.className = 'click-pop';
        pop.innerText = icon;
        let rect = el.getBoundingClientRect();
        let x = Math.random() * (rect.width - 20);
        let y = Math.random() * (rect.height - 20);
        pop.style.left = x + 'px';
        pop.style.top = y + 'px';
        el.appendChild(pop);
        setTimeout(() => pop.remove(), 800);
    },

    log: function(t, c) {
        let d = document.createElement('div');
        d.className = `log-entry ${c}`;
        d.innerText = `Tag ${S.day}: ${t}`;
        let log = document.getElementById('log');
        log.prepend(d);
        if(log.childNodes.length > 20) log.removeChild(log.lastChild);
    },

    setCat: function(c) {
        this.cat = c; 
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if(event && event.currentTarget) event.currentTarget.classList.add('active');
        this.renderBuild();
        this.updateBuildState();
    },

    renderBuild: function() {
        const d = document.getElementById('build-list'); d.innerHTML = "";
        for(let k in Config.b) {
            let b = Config.b[k];
            if(b.c !== this.cat) continue;
            
            let el = document.createElement('div'); el.className = "b-card";
            el.setAttribute('data-key', k);
            // Klick auf Karte baut, Klick auf Buttons steuert Worker
            el.onclick = (e) => { if(!e.target.classList.contains('w-btn')) Game.build(k); };
            
            // MANUAL WORKER CONTROL
            let workerHtml = "";
            if(S.b[k] > 0 && Game.isProductionBuilding(b)) {
                let w = S.w[k];
                let max = S.b[k]; 
                let wClass = w < max ? 'w-empty' : 'w-full';
                workerHtml = `
                    <div class="b-worker-box">
                        <div class="w-btn" onclick="Game.assign('${k}', -1)">-</div>
                        <div class="w-disp ${wClass}">${w}/${max}</div>
                        <div class="w-btn" onclick="Game.assign('${k}', 1)">+</div>
                    </div>
                `;
            }

            el.innerHTML = `
                ${S.b[k]>0 ? `<div class="b-count">${S.b[k]}</div>`:''}
                <div style="font-size:2rem">${b.i}</div>
                <div style="font-size:0.7rem;font-weight:bold">${b.n}</div>
                <div class="cost-disp" style="font-size:0.6rem;color:#666"></div>
                ${workerHtml}
            `;
            d.appendChild(el);
        }
    },

    renderMap: function() {
        ['forest','mountain','town','farm'].forEach(z => {
            let el = document.getElementById('z-'+z);
            let nodes = Array.from(el.childNodes);
            nodes.forEach(n => {
                if(n.className === 'map-b' || n.className === 'click-pop') el.removeChild(n);
            });
        });
        for(let k in S.b) {
            for(let i=0; i<S.b[k]; i++) this.addMapIcon(k);
        }
    },

    addMapIcon: function(k) {
        let b = Config.b[k];
        let zone = document.getElementById(b.z);
        if(zone) {
            let d = document.createElement('div'); d.className='map-b'; d.innerText = b.i;
            d.title = b.n;
            d.style.left = (10 + Math.random() * 70) + '%';
            d.style.top = (10 + Math.random() * 70) + '%';
            zone.appendChild(d);
        }
    },

    showModal: function(t, b, btnTxt, cb) {
        document.getElementById('m-title').innerText = t;
        document.getElementById('m-body').innerText = b;
        let btn = document.getElementById('m-btn');
        btn.innerText = btnTxt || "OK";
        
        let newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.onclick = function() {
            document.getElementById('modal-mask').style.display = 'none';
            S.paused = false;
            lastTickTime = Date.now(); 
            if(cb) cb();
        };
        
        document.getElementById('modal-mask').style.display = 'flex';
    },

    openRecruit: function() {
        document.getElementById('recruit-mask').style.display='flex';
        let l = document.getElementById('recruit-list'); l.innerHTML="";
        for(let k in Units) {
            let u = Units[k];
            let row = document.createElement('div'); row.className='list-item';
            let cost = `${u.cost}üí∞` + (u.res ? ` +1 ${SafeT(u.res)}` : "");
            row.innerHTML = `<span>${u.n} (${u.str}‚öîÔ∏è)</span><button class="btn" style="padding:2px 8px" onclick="Game.recruit('${k}')">Ausbilden (${cost})</button>`;
            l.appendChild(row);
        }
    },
    closeRecruit: function() { document.getElementById('recruit-mask').style.display='none'; },

    openWar: function() {
        document.getElementById('war-mask').style.display='flex';
        let l = document.getElementById('war-list'); l.innerHTML="";
        document.getElementById('army-str').innerText = Game.getArmyStr();
        
        Missions.forEach((m, idx) => {
            let row = document.createElement('div'); row.className='war-card';
            let lootTxt = [];
            for(let k in m.loot) lootTxt.push(`${m.loot[k]} ${SafeT(k)}`);
            row.innerHTML = `
                <div>
                    <div style="font-weight:bold">${m.n}</div>
                    <div style="font-size:0.8rem; color:#555">Beute: ${lootTxt.join(', ')}</div>
                </div>
                <div style="text-align:right">
                    <div style="font-weight:bold; color:#b71c1c">Gefahr: ${m.risk}</div>
                    <button class="btn" style="margin-top:5px; background:var(--danger); color:#fff" onclick="Game.launchWar(${idx})">Angriff (${m.str}‚öîÔ∏è)</button>
                </div>
            `;
            l.appendChild(row);
        });
    },
    closeWar: function() { document.getElementById('war-mask').style.display='none'; },

    openMarket: function() {
        document.getElementById('market-mask').style.display='flex';
        this.renderMarket();
    },
    closeMarket: function() { document.getElementById('market-mask').style.display='none'; },
    renderMarket: function() {
        let l = document.getElementById('market-list'); l.innerHTML="";
        ['wood','stone','iron','wheat','flour','hops','bread','meat','cheese','apple','beer','bow','spear','sword','armor'].forEach(k => {
            let row = document.createElement('div'); row.className='list-item';
            row.innerHTML = `<span>${SafeT(k)}: ${Math.floor(S.res[k]||0)}</span><div><button onclick="Game.trade('${k}',1)">Kauf (5g)</button> <button onclick="Game.trade('${k}',0)">Verk (3g)</button></div>`;
            l.appendChild(row);
        });
    }
};

Game.init();
</script>
</body>
</html>
