<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burgherr V10 - Detail Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #1a1a1a; 
            --scroll-bg: #fdf5e6;
            --scroll-border: #5d4037;
            --primary: #3e2723; 
            --accent: #d32f2f; 
            --highlight: #ffb300;
            --text-dark: #3e2723;
        }

        * { box-sizing: border-box; user-select: none; }
        body { font-family: 'Lato', sans-serif; background: var(--bg-body); color: #fff; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { 
            background: #222; height: 110px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; border-bottom: 3px solid #444;
        }
        
        .header-left { width: 250px; }
        .game-title { font-family: 'MedievalSharp'; font-size: 1.6rem; color: var(--highlight); margin: 0; line-height: 1; text-shadow: 2px 2px 0 #000; }
        .objective-box { 
            margin-top: 5px; background: rgba(255,255,255,0.1); padding: 5px; 
            border-radius: 4px; border-left: 3px solid var(--highlight); font-size: 0.75rem; color: #ccc;
        }
        .obj-done { color: #81c784; text-decoration: line-through; opacity: 0.6; }

        .res-bar { display: flex; gap: 6px; flex:1; justify-content: flex-end; }
        .res-group { 
            background: #333; border: 1px solid #555; border-radius: 4px; 
            padding: 3px 6px; min-width: 60px; text-align: center; position: relative; cursor: help;
        }
        .res-group:hover { background: #444; }
        .res-lbl { font-size: 0.55rem; text-transform: uppercase; color: #aaa; border-bottom: 1px solid #555; display: block; margin-bottom: 2px; }
        .res-val { font-size: 0.85rem; font-weight: bold; display: flex; gap: 6px; justify-content: center; }
        
        /* HOVER TOOLTIP */
        .tooltip { 
            visibility: hidden; opacity: 0; position: absolute; top: 100%; right: 0; margin-top:5px;
            background: #222; border: 1px solid #777; padding: 10px; border-radius: 4px; 
            width: 180px; z-index: 1000; text-align: left; transition: 0.1s; pointer-events: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.9); font-size: 0.8rem; color: #fff;
        }
        .res-group:hover .tooltip { visibility: visible; opacity: 1; }
        .tt-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .col-green { color: #81c784; } .col-red { color: #e57373; }

        /* --- MAIN --- */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }

        #map-area {
            flex: 1; background: radial-gradient(#558b2f 10%, #33691e 90%);
            position: relative; overflow: hidden; display: flex; flex-wrap: wrap; 
            align-content: flex-start; gap: 5px; padding: 20px;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.8);
        }
        .map-icon { 
            font-size: 1.8rem; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; 
            background: rgba(255,255,255,0.15); border-radius: 6px; border: 1px solid rgba(255,255,255,0.2);
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: default; user-select: none;
        }
        .map-icon:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); z-index: 5; }
        @keyframes pop { from{transform:scale(0)} to{transform:scale(1)} }

        aside.sidebar { 
            width: 320px; background: #d7ccc8; color: var(--text-dark);
            border-left: 5px solid var(--scroll-border); display: flex; flex-direction: column; 
        }
        
        .log-container { 
            flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 6px; 
            background: rgba(0,0,0,0.05); 
        }
        .log-entry { 
            background: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.8rem; 
            border-left: 4px solid #999; box-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .log-entry.report { border-color: #558b2f; background: #f1f8e9; }
        .log-entry.error { border-color: #d32f2f; background: #ffebee; font-weight: bold; }
        .log-entry.success { border-color: #ffb300; background: #fff8e1; }

        .sidebar-controls { padding: 10px; background: #bcaaa4; border-top: 2px solid var(--primary); }
        .btn-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .action-btn { 
            flex: 1; padding: 10px; border: 1px solid #5d4037; background: #efebe9; 
            font-weight: bold; cursor: pointer; border-radius: 4px; font-size: 0.85rem; 
            box-shadow: 0 2px 0 #8d6e63; color: #3e2723;
        }
        .action-btn:active { transform: translateY(2px); box-shadow: none; }
        .action-btn:hover { background: #fff; }

        /* --- FOOTER (BUILD MENU) --- */
        footer {
            height: 150px; background: var(--scroll-bg); border-top: 6px solid var(--scroll-border);
            display: flex; align-items: center; padding: 0 15px; flex-shrink: 0; z-index: 20;
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            color: var(--text-dark);
        }

        .cat-menu { 
            display: flex; gap: 5px; padding-right: 15px; border-right: 2px solid #c5afa0; 
            margin-right: 15px; flex-wrap: wrap; width: 140px; justify-content: center; 
        }
        .cat-btn { 
            width: 38px; height: 38px; background: #8d6e63; color: #fff; 
            border: 2px solid #5d4037; border-radius: 4px; display: flex; 
            align-items: center; justify-content: center; font-size: 1.2rem; 
            cursor: pointer; box-shadow: 2px 2px 0 rgba(0,0,0,0.3); transition: 0.1s;
        }
        .cat-btn:hover { transform: translateY(-2px); background: #a1887f; }
        .cat-btn.active { background: var(--highlight); color: #000; border-color: #fff; }

        .build-menu { display: flex; overflow-x: auto; gap: 10px; align-items: center; height: 100%; padding-bottom: 5px; flex: 1; }
        .build-card {
            min-width: 80px; height: 100px; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; cursor: pointer; position: relative;
            background: rgba(0,0,0,0.05); border-radius: 6px; padding: 4px; 
            transition: 0.2s; border: 1px solid transparent; user-select: none;
        }
        .build-card:hover { background: rgba(0,0,0,0.1); transform: scale(1.05); border-color: #8b5a2b; }
        .build-badge { 
            position: absolute; top: -5px; right: -5px; background: var(--accent); 
            color: #fff; font-size: 0.7rem; padding: 1px 6px; border-radius: 8px; 
            font-weight: bold; box-shadow: 1px 1px 2px rgba(0,0,0,0.3); 
        }
        .b-icon { font-size: 2rem; margin-bottom: 2px; }
        .b-name { font-size: 0.7rem; font-weight: bold; text-align: center; line-height: 1; margin-bottom: 2px;}
        .b-cost { font-size: 0.6rem; color: #555; text-align: center; }

        /* --- MODALS --- */
        .modal-overlay { 
            display: none; position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; 
        }
        .modal-content { 
            background: var(--scroll-bg); padding: 25px; width: 500px; 
            border: 4px solid var(--scroll-border); border-radius: 10px; 
            text-align: center; color: var(--text-dark); position:relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        
        .modal-btn { 
            width: 100%; padding: 12px; background: var(--primary); color: white; 
            border: none; border-radius: 4px; font-weight: bold; cursor: pointer; 
            font-size: 1.1rem; margin-top: 20px;
        }
        .modal-btn:hover { background: #5d4037; }

        .list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: left; margin-top: 15px; max-height: 400px; overflow-y: auto;}
        .trade-row { background: rgba(255,255,255,0.6); padding: 6px; border: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; border-radius: 4px;}
        
        .trade-btn { background: #eee; border: 1px solid #999; cursor: pointer; padding: 2px 8px; font-weight: bold; border-radius: 3px; font-size: 0.8rem;}
        .trade-btn:hover { background: var(--highlight); }

        #paused-sign { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); font-size: 5rem; color: rgba(255,255,255,0.2); font-family: 'MedievalSharp'; pointer-events: none; z-index: 50; display: none; text-shadow: 0 0 20px #000; }
        
        /* Unit Display in Header */
        .unit-display { display: flex; gap: 10px; font-size: 0.85rem; }
    </style>
</head>
<body>

<div id="particles"></div>
<div id="paused-sign">PAUSIERT</div>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title" style="margin:0 0 10px 0; font-family:'MedievalSharp'">Titel</h2>
        <div id="modal-body" style="font-size:1.1rem; line-height:1.5;">Inhalt</div>
        <div id="modal-footer">
            <button id="modal-close-btn" class="modal-btn">Schlie√üen</button>
        </div>
    </div>
</div>

<header>
    <div class="header-left">
        <h1 class="game-title">Burgherr</h1>
        <div class="objective-box" id="disp-objective">Lade...</div>
    </div>
    
    <div class="res-bar">
        <div class="res-group">
            <span class="res-lbl">Schatz</span>
            <div class="res-val">üí∞ <span id="r-gold">0</span></div>
        </div>
        
        <div class="res-group">
            <span class="res-lbl">Lager</span>
            <div class="res-val">
                <span title="Holz">üå≤<span id="r-wood">0</span></span>
                <span title="Stein">üß±<span id="r-stone">0</span></span>
                <span title="Eisen">‚õìÔ∏è<span id="r-iron">0</span></span>
            </div>
            <div class="tooltip">
                <div class="tt-row"><span>Limit:</span><span id="tt-limit-stock">100</span></div>
            </div>
        </div>

        <div class="res-group">
            <span class="res-lbl">Speise</span>
            <div class="res-val">
                <span title="Brot">üçû<span id="r-bread">0</span></span>
                <span title="Fleisch">ü•©<span id="r-meat">0</span></span>
                <span title="√Ñpfel">üçé<span id="r-apple">0</span></span>
                <span title="K√§se">üßÄ<span id="r-cheese">0</span></span>
            </div>
            <div class="tooltip">
                <div class="tt-row"><span>Limit:</span><span id="tt-limit-food">100</span></div>
            </div>
        </div>

        <div class="res-group" style="min-width:120px;">
            <span class="res-lbl">Truppen</span>
            <div class="res-val unit-display">
                <span title="Bogensch√ºtzen">üèπ<span id="r-archer">0</span></span>
                <span title="Pikeniere">üî±<span id="r-spear">0</span></span>
                <span title="Schwertk√§mpfer">‚öîÔ∏è<span id="r-sword">0</span></span>
                <span title="S√∂ldner">üó°Ô∏è<span id="r-merc">0</span></span>
            </div>
        </div>

        <div class="res-group">
            <span class="res-lbl">Volk</span>
            <div class="res-val">
                <span title="Einwohner">üë®‚Äçüåæ <span id="r-pop">0</span></span>
                <span title="Unt√§tig">üí§ <span id="r-idle">0</span></span>
            </div>
            <div class="tooltip">
                <div class="tt-row"><span>Beliebtheit:</span><span id="r-hap" style="font-weight:bold">100</span></div>
                <hr style="border:0; border-top:1px solid #555; margin:2px 0;">
                <div id="hap-details"></div>
            </div>
        </div>
    </div>
</header>

<main>
    <div id="map-area"></div>

    <aside class="sidebar">
        <div style="background:#bcaaa4; padding:5px; font-weight:bold; text-align:center; font-size:0.8rem; border-bottom:1px solid #8d6e63;">
            Tag <span id="disp-day">1</span> - Level <span id="disp-level">1</span>
        </div>
        <div class="log-container" id="log-list"></div>
        
        <div class="sidebar-controls">
            <div class="btn-row">
                <button class="action-btn" onclick="UI.openRecruit()">üõ°Ô∏è Armee</button>
                <button class="action-btn" onclick="UI.openMarket()">‚öñÔ∏è Markt</button>
            </div>
            
            <div style="font-size:0.8rem; margin:5px 0; background:rgba(255,255,255,0.5); padding:4px; border-radius:4px;">
                <strong>Steuern:</strong> <span id="disp-tax">Keine</span>
                <div style="display:flex; gap:5px; margin-top:4px;">
                    <button class="small-btn" style="flex:1" onclick="Game.setTax(-1)">-</button>
                    <button class="small-btn" style="flex:1" onclick="Game.setTax(1)">+</button>
                </div>
            </div>

            <div style="border-top:1px dashed #555; padding-top:5px; margin-top:5px; font-size:0.75rem; color:#555;">System</div>
            <div class="btn-row">
                <button class="action-btn" onclick="Game.togglePause()">‚èØÔ∏è</button>
                <button class="action-btn" onclick="Game.save()">üíæ</button>
                <button class="action-btn" onclick="Game.load()">üìÇ</button>
                <button class="action-btn" onclick="Game.reset()" style="background:#ffcdd2;">‚ùå</button>
            </div>
        </div>
    </aside>
</main>

<footer>
    <div class="cat-menu">
        <div class="cat-btn selected" onclick="UI.setCat('burg')" title="Burg">üè∞</div>
        <div class="cat-btn" onclick="UI.setCat('werk')" title="Werkst√§tten">üî®</div>
        <div class="cat-btn" onclick="UI.setCat('farm')" title="Farmen">üçé</div>
        <div class="cat-btn" onclick="UI.setCat('stadt')" title="Stadt">üè†</div>
        <div class="cat-btn" onclick="UI.setCat('waffen')" title="Waffen">‚öîÔ∏è</div>
        <div class="cat-btn" onclick="UI.setCat('nahrung')" title="Nahrung">üçû</div>
    </div>
    <div class="build-menu" id="build-list"></div>
</footer>

<script>
// --- KONFIGURATION & DATEN ---
const Labels = {
    gold:"Gold", wood:"Holz", stone:"Stein", iron:"Eisen", pitch:"Pech",
    wheat:"Weizen", flour:"Mehl", hops:"Hopfen",
    bread:"Brot", meat:"Fleisch", apple:"√Ñpfel", cheese:"K√§se", beer:"Bier",
    bow:"Bogen", spear:"Speer", sword:"Schwert", armor:"R√ºstung", leather:"Harnisch",
    pop:"Einwohner", archer:"Bogensch√ºtze", spearman:"Pikenier", swordsman:"Schwertk√§mpfer", merc:"S√∂ldner",
    cath:"Kathedrale", tower:"Wachturm", church:"Kirche"
};

const T = (key) => Labels[key] || key;

const Levels = [
    { id: 1, title: "Die Gr√ºndung", intro: "Willkommen, Sire! Baut H√ºtten f√ºr Einwohner und Holzf√§ller f√ºr Rohstoffe.", goal: { wood: 50, pop: 10 }, start: { gold:100, wood:20, food:20 } },
    { id: 2, title: "Stein & Brot", intro: "Wir brauchen Stein f√ºr Mauern. Baut Steinbr√ºche (brauchen Ochsenjoch!) und eine Nahrungskette.", goal: { bread: 30, stone: 20 }, start: { gold:150, wood:50, food:30 } },
    { id: 3, title: "Aufr√ºstung", intro: "Der Feind r√ºckt n√§her. Produziert B√∂gen in der Werkstatt.", goal: { bow: 5, spear: 5 }, start: { gold:200, wood:100, stone:50, food:50 } },
    { id: 4, title: "Krieg", intro: "Bildet eure Truppen aus.", goal: { archer: 5, spearman: 5 }, start: { gold:300, wood:100, stone:100, iron:20, food:100 } },
    { id: 5, title: "Die Kathedrale", intro: "Das Meisterwerk. Baut die Kathedrale!", goal: { cath: 1 }, start: { gold:1000, wood:500, stone:500, iron:100, food:200 } }
];

const Units = {
    archer: { name: "Bogensch√ºtze", cost: 10, res: "bow", str: 5 },
    spearman: { name: "Pikenier", cost: 15, res: "spear", str: 8 },
    swordsman: { name: "Schwertk√§mpfer", cost: 30, res: "sword", armor: "armor", str: 15 },
    merc: { name: "S√∂ldner", cost: 50, str: 10 }
};

const Config = {
    tick: 5000,
    taxes: [
        {n:"Keine",g:0,h:1}, {n:"Niedrig",g:2,h:-2}, {n:"Mittel",g:4,h:-5}, 
        {n:"Hoch",g:8,h:-12}, {n:"Grausam",g:15,h:-20}
    ],
    buildings: {
        // BURG
        wall_w: { name:"Holzwall", cat:"burg", icon:"ü™µ", cost:{g:10,w:20}, def:10 },
        wall_s: { name:"Steinmauer", cat:"burg", icon:"üß±", cost:{g:50,s:20}, def:50 },
        tower:  { name:"Wachturm", cat:"burg", icon:"üóº", cost:{g:100,s:50}, def:150 },
        gate:   { name:"Torhaus", cat:"burg", icon:"‚õ©Ô∏è", cost:{g:50,w:20,s:20}, def:20 },
        barracks: { name:"Kaserne", cat:"burg", icon:"‚õ∫", cost:{g:150,s:20}, desc:"Rekrutierung" },
        merc_post: { name:"S√∂ldnerlager", cat:"burg", icon:"üé™", cost:{g:500,w:100}, desc:"S√∂ldner" },

        // WERKSTATT
        stock:  { name:"Vorratslager", cat:"werk", icon:"üì¶", cost:{w:20}, desc:"+50 Lager" },
        wood:   { name:"Holzf√§ller", cat:"werk", icon:"ü™ì", cost:{g:10}, prod:"wood", amt:3 },
        ox:     { name:"Ochsenjoch", cat:"werk", icon:"üêÇ", cost:{g:20,w:20} },
        quarry: { name:"Steinbruch", cat:"werk", icon:"‚õèÔ∏è", cost:{g:50,w:50}, prod:"stone", amt:2, need:"ox" },
        iron:   { name:"Eisenmine", cat:"werk", icon:"‚õìÔ∏è", cost:{g:100,w:100}, prod:"iron", amt:1 },
        pitch:  { name:"Pechgrube", cat:"werk", icon:"‚ö´", cost:{g:150,w:50}, prod:"pitch", amt:1 },

        // FARM
        apple:  { name:"Obstgarten", cat:"farm", icon:"üçé", cost:{g:30,w:10}, prod:"apple", amt:3 },
        hunter: { name:"J√§gerstand", cat:"farm", icon:"üèπ", cost:{g:20,w:5}, prod:"meat", amt:2 },
        dairy:  { name:"K√§serei", cat:"farm", icon:"üßÄ", cost:{g:40,w:20}, prod:"cheese", amt:2 },
        wheat:  { name:"Getreide", cat:"farm", icon:"üåæ", cost:{g:40,w:10}, prod:"wheat", amt:2 },
        hops:   { name:"Hopfen", cat:"farm", icon:"üåø", cost:{g:40,w:10}, prod:"hops", amt:2 },

        // STADT
        hovel:  { name:"H√ºtte", cat:"stadt", icon:"üõñ", cost:{w:10}, pop:5 },
        house:  { name:"Haus", cat:"stadt", icon:"üè†", cost:{g:50,w:30,s:10}, pop:10 },
        church: { name:"Kirche", cat:"stadt", icon:"‚õ™", cost:{g:500,s:100}, rel:10 },
        cath:   { name:"KATHEDRALE", cat:"stadt", icon:"üïç", cost:{g:5000,s:2000}, rel:50 },
        apoth:  { name:"Apotheke", cat:"stadt", icon:"üíä", cost:{g:200,w:50}, hap:5 },
        well:   { name:"Brunnen", cat:"stadt", icon:"üíß", cost:{g:50,s:10}, hap:2 },

        // WAFFEN
        fletcher: { name:"Pfeilmacher", cat:"waffen", icon:"üèπ", cost:{g:100,w:50}, use:"wood", out:"bow", amt:1 },
        pole:     { name:"Pikenmacher", cat:"waffen", icon:"üî±", cost:{g:100,w:50}, use:"wood", out:"spear", amt:1 },
        smith:    { name:"Schmiede", cat:"waffen", icon:"‚öîÔ∏è", cost:{g:200,w:100}, use:"iron", out:"sword", amt:1 },
        armor:    { name:"R√ºstung", cat:"waffen", icon:"üõ°Ô∏è", cost:{g:200,w:100}, use:"iron", out:"armor", amt:1 },
        tanner:   { name:"Gerber", cat:"waffen", icon:"üß•", cost:{g:100,w:50}, need:"dairy", prod:"leather", amt:1 },

        // NAHRUNG
        granary: { name:"Kornspeicher", cat:"nahrung", icon:"üõñ", cost:{w:20}, cap:50 },
        mill:    { name:"M√ºhle", cat:"nahrung", icon:"‚öôÔ∏è", cost:{g:100,w:50}, proc:"wheat", out:"flour", ratio:1 },
        bake:    { name:"B√§ckerei", cat:"nahrung", icon:"üçû", cost:{g:50,w:20}, proc:"flour", out:"bread", ratio:4 },
        brew:    { name:"Brauerei", cat:"nahrung", icon:"üç∫", cost:{g:100,w:20}, proc:"hops", out:"beer", ratio:2 },
        inn:     { name:"Schenke", cat:"nahrung", icon:"üçª", cost:{g:200,w:100}, hap:10 }
    }
};

let State = {};

const Game = {
    init: function() {
        // Neuer Save-Slot "v10" f√ºr sauberen Start mit neuer Datenstruktur
        if(localStorage.getItem('burgherr_v10')) this.load();
        else this.startLevel(1);
        
        UI.init();
        setInterval(this.tick, Config.tick);
        setInterval(this.save, 30000); 
    },

    startLevel: function(lvlId) {
        let l = Levels.find(x => x.id == lvlId);
        if(!l) {
            UI.openModal("FREIES SPIEL", "Alle Kampagnen-Level abgeschlossen! Ihr regiert nun im freien Modus.", () => {
                State.paused = false;
                UI.closeModal();
            });
            return;
        }
        
        State = {
            level: lvlId, day: 1, paused: true,
            res: { ...l.start, stone:0, iron:0, pitch:0, wheat:0, flour:0, bread:l.start.food||0, cheese:0, meat:0, apple:0, hops:0, beer:0, bow:0, spear:0, sword:0, armor:0, leather:0 },
            // NEW UNIT STRUCTURE
            units: { archer:0, spearman:0, swordsman:0, merc:0 },
            pop: { curr:5, max:0, hap:100 },
            b: {}, w: {}, tax: 0,
            factors: { food:0, tax:0, other:0 }
        };
        for(let k in Config.buildings) { State.b[k]=0; State.w[k]=0; }
        State.b.stock = 1; State.b.granary = 1;
        
        UI.openModal(`Level ${lvlId}: ${l.title}`, l.intro, () => {
            State.paused = false;
            UI.closeModal();
        });
        UI.renderMap();
        UI.update();
    },

    tick: function() {
        if(State.paused) return;
        try {
            State.day++;
            let prodLog = [], eatLog = [];

            // 1. LIMITS
            let maxStock = State.b.stock * 50;
            let maxFood = State.b.granary * 50;
            let curStock = State.res.wood + State.res.stone + State.res.iron + State.res.wheat + State.res.flour;
            let curFood = State.res.bread + State.res.meat + State.res.apple + State.res.cheese;
            let fullS = curStock >= maxStock;
            let fullF = curFood >= maxFood;

            // 2. PROD
            for(let k in Config.buildings) {
                let b = Config.buildings[k];
                let n = State.w[k];
                if(n <= 0) continue;

                if(b.need && State.b[b.need] < n) n = State.b[b.need]; 

                // Simple Prod
                if(b.prod) {
                    let isFood = ['meat','apple','wheat','hops','cheese'].includes(b.prod);
                    if((isFood && !fullF) || (!isFood && !fullS)) {
                        let amt = n * (b.amt||1);
                        State.res[b.prod] += amt;
                        prodLog.push(`${amt} ${T(b.prod)}`);
                    }
                }
                // Processing
                if(b.proc) {
                    let take = Math.min(State.res[b.proc], n);
                    if(take > 0 && !fullF) {
                        State.res[b.proc] -= take;
                        State.res[b.out] += (take * (b.ratio||1));
                        prodLog.push(`${take*(b.ratio||1)} ${T(b.out)}`);
                    }
                }
                // Craft
                if(b.use) {
                    if(State.res[b.use] >= n && !fullS) {
                        State.res[b.use] -= n;
                        State.res[b.out] += (n * (b.amt||1));
                        prodLog.push(`${n} ${T(b.out)}`);
                    }
                }
            }

            // 3. EAT
            let eat = State.pop.curr;
            let foods = ['bread','meat','cheese','apple'];
            let ate = 0;
            foods.forEach(f => {
                if(eat > 0 && State.res[f] > 0) {
                    let take = Math.min(eat, State.res[f]);
                    State.res[f] -= take; eat -= take; ate += take;
                    eatLog.push(T(f));
                }
            });
            
            let hapChg = 0;
            if(eat > 0) { 
                UI.log(`${eat} B√ºrger hungern!`, 'error'); hapChg -= 20; 
                State.factors.food = -20;
            } else { 
                hapChg += 2; 
                State.factors.food = 2;
            }

            // Tax
            let tConf = Config.taxes[State.tax];
            hapChg += tConf.h;
            State.res.gold += (State.pop.curr * tConf.g);
            State.factors.tax = tConf.h;

            // Church
            let bonus = (State.b.church * 5);
            hapChg += bonus;
            State.factors.other = bonus;

            State.pop.hap = Math.max(0, Math.min(100, State.pop.hap + hapChg));

            // 4. Pop Growth
            State.pop.max = (State.b.hovel*5) + (State.b.house*10) + 5;
            let work = 0; for(let k in State.w) work += State.w[k];
            let totalSold = 0; for(let k in State.units) totalSold += State.units[k];
            let idle = State.pop.curr - totalSold - work;

            if(State.pop.hap > 60 && State.pop.curr < State.pop.max && Math.random()>0.5) {
                State.pop.curr++; UI.log("B√ºrger zugewandert", "success"); Game.autoAssign();
            } else if(State.pop.hap < 20 && State.pop.curr > 0) {
                State.pop.curr--; UI.log("B√ºrger geflohen", "error");
                for(let k in State.w) if(State.w[k]>0){State.w[k]--; break;}
            }

            // Log entry
            if(prodLog.length || eatLog.length) {
                let html = `<div style="font-weight:bold; border-bottom:1px solid #ddd;">Tag ${State.day}</div>`;
                if(prodLog.length) html += `<div style="color:#2e7d32">Prod: ${prodLog.join(', ')}</div>`;
                if(eatLog.length) html += `<div style="color:#c62828">Essen: ${eatLog.length} Rationen</div>`;
                UI.logHtml(html, 'report');
            }

            // 5. Win Check
            let l = Levels.find(x => x.id == State.level);
            if(l) {
                let win = true;
                for(let k in l.goal) {
                    let val = 0;
                    if(k=='pop') val=State.pop.curr;
                    else if(State.units[k] !== undefined) val = State.units[k]; // Specific unit check
                    else val = State.res[k] || State.b[k] || 0;
                    if(val < l.goal[k]) win = false;
                }
                if(win) {
                    State.paused = true;
                    UI.openModal("SIEG!", "Level geschafft!", () => Game.startLevel(State.level+1));
                }
            }

            UI.update();
        } catch(e) {
            console.error(e); State.paused = true; 
            alert("Fehler! Das Spiel wurde pausiert.");
        }
    },

    autoAssign: function() {
        let work = 0; for(let k in State.w) work += State.w[k];
        let totalSold = 0; for(let k in State.units) totalSold += State.units[k];
        let idle = State.pop.curr - totalSold - work;
        if(idle <= 0) return;

        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            if((b.prod || b.proc || b.use) && State.b[k] > State.w[k]) {
                State.w[k]++; idle--;
                if(idle<=0) break;
            }
        }
    },

    build: function(key) {
        let b = Config.buildings[key];
        if(State.res.gold >= (b.cost.g||0) && State.res.wood >= (b.cost.w||0) && State.res.stone >= (b.cost.s||0)) {
            State.res.gold -= (b.cost.g||0); State.res.wood -= (b.cost.w||0); State.res.stone -= (b.cost.s||0);
            State.b[key]++;
            UI.addMapIcon(b.icon);
            Game.autoAssign();
            UI.update();
        } else UI.log("Zu wenig Rohstoffe", "error");
    },

    recruit: function(type) {
        let work = 0; for(let k in State.w) work += State.w[k];
        let totalSold = 0; for(let k in State.units) totalSold += State.units[k];
        let idle = State.pop.curr - totalSold - work;

        if(type === 'merc') {
            if(State.b.merc_post < 1) return UI.log("S√∂ldnerlager n√∂tig", "error");
            if(State.res.gold < 50) return UI.log("Zu wenig Gold", "error");
            State.res.gold -= 50; 
            State.units.merc++;
            UI.log("S√∂ldner angeheuert", "success");
        } else {
            if(State.b.barracks < 1) return UI.log("Kaserne n√∂tig", "error");
            if(idle < 1) return UI.log("Keine freien Bauern", "error");
            
            let u = Units[type];
            if(!u) return;
            if(State.res.gold < u.cost) return UI.log("Zu wenig Gold", "error");
            if(u.res && State.res[u.res] < 1) return UI.log(T(u.res) + " fehlt!", "error");
            if(u.armor && State.res[u.armor] < 1) return UI.log("R√ºstung fehlt!", "error");

            State.res.gold -= u.cost;
            if(u.res) State.res[u.res]--;
            if(u.armor) State.res[u.armor]--;
            State.units[type]++; // Specific unit increment
            UI.log(u.name + " ausgebildet", "success");
        }
        UI.update();
    },

    setTax: function(d) {
        let n = State.tax + d;
        if(n >= 0 && n < 5) State.tax = n;
        UI.update();
    },

    trade: function(item, buy) {
        if(buy && State.res.gold >= 5) { State.res.gold-=5; State.res[item]+=5; }
        if(!buy && State.res[item] >= 5) { State.res[item]-=5; State.res.gold+=3; }
        UI.update(); 
        if(document.getElementById('modal-market').style.display === 'block') UI.openMarket();
    },

    togglePause: function() { State.paused = !State.paused; UI.update(); },
    save: function() { localStorage.setItem('burgherr_v10', JSON.stringify(State)); UI.log("Gespeichert", "info"); },
    load: function() { 
        let d = localStorage.getItem('burgherr_v10'); 
        if(d) { State = JSON.parse(d); State.paused = true; UI.renderMap(); UI.update(); UI.openModal("Geladen","Willkommen zur√ºck", () => {State.paused=false; UI.closeModal()}); }
    },
    reset: function() { localStorage.removeItem('burgherr_v10'); location.reload(); },
    
    startRaid: function() {
        let army = 0; for(let k in State.units) army += State.units[k];
        if(army < 5) return UI.log("Min. 5 Mann n√∂tig", "error");
        UI.log("Raubzug gestartet...", "info");
        setTimeout(()=>{
            if(Math.random()>0.3) {
                let g = Math.floor(Math.random()*100)+50;
                State.res.gold += g; UI.log(`Erfolg! ${g} Gold erbeutet.`, "success");
            } else {
                UI.log("Misserfolg. Keine Beute.", "error");
            }
            UI.update();
        }, 2000);
    }
};

const UI = {
    cat: 'burg',
    init: function() { this.renderBuild(); },
    setCat: function(c) { 
        this.cat = c; this.renderBuild(); 
        document.querySelectorAll('.cat-btn').forEach(e => e.classList.remove('active'));
        // Fallback for init call
        if(event && event.target) event.target.classList.add('active');
    },
    renderBuild: function() {
        const d = document.getElementById('build-list'); d.innerHTML = "";
        for(let k in Config.buildings) {
            let b = Config.buildings[k];
            if(b.cat !== this.cat) continue;
            let cost = [];
            if(b.cost.g) cost.push(b.cost.g+"üí∞"); if(b.cost.w) cost.push(b.cost.w+"üå≤"); if(b.cost.s) cost.push(b.cost.s+"üß±");
            
            let el = document.createElement('div'); el.className = "build-card";
            el.onclick = () => Game.build(k);
            el.innerHTML = `
                ${State.b[k]>0 ? `<div class="build-badge">${State.b[k]}</div>`:''}
                <div class="b-icon">${b.icon}</div>
                <div class="b-name">${b.name}</div>
                <div class="b-cost">${cost.join(' ')}</div>
            `;
            d.appendChild(el);
        }
    },
    renderMap: function() {
        const m = document.getElementById('map-area'); m.innerHTML = "";
        for(let k in State.b) {
            for(let i=0; i<State.b[k]; i++) this.addMapIcon(Config.buildings[k].icon);
        }
    },
    addMapIcon: function(ico) {
        let d = document.createElement('div'); d.className='map-icon'; d.innerText=ico;
        document.getElementById('map-area').appendChild(d);
    },
    log: function(txt, type) { this.logHtml(`<div>${txt}</div>`, type); },
    logHtml: function(html, type) {
        let d = document.createElement('div'); d.className=`log-entry ${type}`; d.innerHTML = html;
        let c = document.getElementById('log-list'); c.prepend(d);
        if(c.children.length > 20) c.lastChild.remove();
    },
    update: function() {
        const r = State.res;
        ['gold','wood','stone','iron','wheat','flour','hops','bread','meat','apple','cheese','beer','bow','spear','sword','armor'].forEach(k => {
            let e = document.getElementById('r-'+k); if(e) e.innerText = Math.floor(r[k]);
        });
        
        // NEW UNIT DISPLAY
        ['archer','spear','sword','merc'].forEach(k => {
            document.getElementById('r-'+k).innerText = State.units[k];
        });

        let work = 0; for(let k in State.w) work += State.w[k];
        let totalSold = 0; for(let k in State.units) totalSold += State.units[k];
        let idle = State.pop.curr - totalSold - work;

        document.getElementById('r-pop').innerText = State.pop.curr + "/" + State.pop.max;
        document.getElementById('r-idle').innerText = idle; // IDLE DISPLAY
        document.getElementById('r-hap').innerText = Math.floor(State.pop.hap);
        document.getElementById('disp-day').innerText = State.day;
        document.getElementById('disp-level').innerText = "Level " + State.level;
        document.getElementById('disp-tax').innerText = Config.taxes[State.tax].n;
        document.getElementById('paused-sign').style.display = State.paused ? 'block' : 'none';

        // Hover Tooltip
        let f = State.factors;
        document.getElementById('hap-details').innerHTML = `
            <div class="tt-row"><span>Essen:</span><span class="${f.food>=0?'col-green':'col-red'}">${f.food}</span></div>
            <div class="tt-row"><span>Steuer:</span><span class="${f.tax>=0?'col-green':'col-red'}">${f.tax}</span></div>
            <div class="tt-row"><span>Andere:</span><span class="col-green">+${f.other}</span></div>
        `;

        // Limits
        let maxS = State.b.stock*50;
        let curS = r.wood+r.stone+r.iron+r.wheat+r.flour;
        document.getElementById('tt-limit-stock').innerText = `${Math.floor(curS)}/${maxS}`;
        
        let maxF = State.b.granary*50;
        let curF = r.bread+r.meat+r.apple+r.cheese;
        document.getElementById('tt-limit-food').innerText = `${Math.floor(curF)}/${maxF}`;

        // Objective
        let l = Levels.find(x => x.id == State.level);
        if(l) {
            let html = "";
            for(let k in l.goal) {
                let val = 0;
                if(k=='pop') val=State.pop.curr;
                else if(State.units[k] !== undefined) val = State.units[k];
                else val = State.res[k] || State.b[k] || 0;
                
                let done = val >= l.goal[k] ? "obj-done" : "";
                html += `<span class="obj-item ${done}">${T(k)}: ${Math.floor(val)}/${l.goal[k]}</span> `;
            }
            document.getElementById('disp-objective').innerHTML = html;
        }
        
        this.renderBuild();
    },
    
    // MODAL SYSTEM (Robuster Button)
    openModal: function(title, text, callback) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerText = text;
        document.getElementById('modal-overlay').style.display = 'flex';
        
        let btn = document.getElementById('modal-close-btn');
        let newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.onclick = function() {
            if(callback) callback();
            UI.closeModal();
        };
    },
    closeModal: function() {
        document.getElementById('modal-overlay').style.display = 'none';
    },

    openMarket: function() {
        document.getElementById('modal-market').style.display = 'flex';
        this.renderList('market-list', ['wood','stone','iron','wheat','flour','bread','meat','apple','cheese','hops','beer','bow','spear','sword','armor'], 'trade');
        State.paused = true;
    },
    openRecruit: function() {
        document.getElementById('modal-recruit').style.display = 'flex';
        let list = document.getElementById('recruit-list'); list.innerHTML="";
        for(let k in Units) {
            let u = Units[k];
            let cost = `${u.cost}üí∞ ` + (u.res ? `+1 ${T(u.res)}` : "");
            let d = document.createElement('div'); d.className='trade-item';
            d.innerHTML = `<span>${u.name} (${u.str}‚öîÔ∏è)</span><button class="small-btn" onclick="Game.recruit('${k}')">Ausbilden (${cost})</button>`;
            list.appendChild(d);
        }
        State.paused = true;
    },
    toggleMarket: function(s) { if(!s){document.getElementById('modal-market').style.display='none'; State.paused=false;} else UI.openMarket(); },
    toggleRecruit: function(s) { if(!s){document.getElementById('modal-recruit').style.display='none'; State.paused=false;} else UI.openRecruit(); },

    renderList: function(id, items, type) {
        let list = document.getElementById(id); list.innerHTML = "";
        items.forEach(k => {
            let d = document.createElement('div'); d.className='trade-item'; // War vorher trade-row
            d.style.cssText = "display:flex; justify-content:space-between; margin-bottom:5px; padding:5px; background:rgba(255,255,255,0.5); border-radius:4px;";
            d.innerHTML = `<span>${T(k)} (${Math.floor(State.res[k])})</span><div><button class="small-btn" onclick="Game.trade('${k}',1)">Kauf</button><button class="small-btn" onclick="Game.trade('${k}',0)">Verk</button></div>`;
            list.appendChild(d);
        });
    }
};

Game.init();
</script>
</body>
</html>
